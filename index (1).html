<!DOCTYPE html>
<html lang="cs">
<head>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smƒõn√°≈ô ‚Äì dynamick√© role + datum + aktivita + odemknut√≠ p≈ôihla≈°ov√°n√≠</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    details summary{cursor:pointer; user-select:none; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .admin-box{border:1px dashed var(--border); border-radius:10px; padding:10px; margin-top:10px; background:#fafbff}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}
  </style>
</head>
<body>
  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>
  <main>
    <div id="app"></div>
  </main>
  <div class="toast-wrap" id="toasts"></div>

<script>// ===== Supabase KV Sync Adapter (fill your keys) =====
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcHlhdndoenB2ZGJ4ZGlkZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDQxNzYsImV4cCI6MjA3MjQyMDE3Nn0.baWqIwQrlz8KJ6CfOt7-md7FZvBDSXagFXNpHy_eOH4";
let sb = null;
if (window.supabase) {
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} else {
  console.warn("Supabase library not loaded ‚Äî cloud sync disabled.");
}

// Keys to sync (align with your app's localStorage keys)
const SYNC_KEYS = [
  "smenar.users",
  "smenar.actions",
  "smenar.roles",
  "smenar.activity",
  "smenar.actions.archive"
];

async function kvGet(key){
  if(!sb) return null;
  const { data, error } = await sb.from("kv").select("val").eq("key", key).single();
  if(error && error.code !== "PGRST116"){ console.warn("kvGet error", key, error); }
  return data?.val ?? null;
}
async function kvUpsert(key, val){
  if(!sb) return;
  const { error } = await sb.from("kv").upsert({ key, val });
  if(error){ console.warn("kvUpsert error", key, error); }
}

// Keep references to original local load/save (if they exist), else provide fallbacks
const __origLocalLoad = (k) => {
  try { return JSON.parse(localStorage.getItem(k) || "[]"); } catch(e){ return []; }
};
const __origLocalSave = (k, v) => {
  try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){ console.warn("local save failed", e); }
};

// Override global load/save to dual-write to cloud, keeping sync API
window.load = function(k){
  return __origLocalLoad(k);
};
window.save = function(k, v){
  __origLocalSave(k, v);
  // async, fire-and-forget
  kvUpsert(k, v);
};

// On boot, pull cloud ‚Üí local so sync API-based code has fresh data
async function bootSync(){
  if(!sb) return;
  try{
    const { data, error } = await sb.from("kv").select("key,val").in("key", SYNC_KEYS);
    if(error){ console.warn("bootSync select error", error); return; }
    (data||[]).forEach(row=>__origLocalSave(row.key, row.val ?? []));
  }catch(e){ console.warn("bootSync catch", e); }
}

// Optional: small badge in console to indicate cloud availability
console.info("‚õÖ Cloud sync:", sb ? "ENABLED (fill your keys!)" : "DISABLED");

// ====== Kl√≠ƒçe √∫lo≈æi≈°tƒõ ======
const DB_USERS   = "smenar.users";
const DB_ACTIONS = "smenar.actions";
const DB_ROLES   = "smenar.roles";
const DB_SESSION = "smenar.session";
const DB_ACT     = "smenar.activity"; // log aktivit
const DB_ARCHIVE = "smenar.actions.archive";

// ====== Utility ======
const load = k => JSON.parse(localStorage.getItem(k) || "[]");
const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
const getSession = () => localStorage.getItem(DB_SESSION);
const setSession = id => id ? localStorage.setItem(DB_SESSION,id) : localStorage.removeItem(DB_SESSION);
const uid = () => (crypto.randomUUID ? crypto.randomUUID() : ("id"+Date.now()));
const nowIso = () => new Date().toISOString();
const today = () => new Date().toISOString().slice(0,10);
const nowMs = () => Date.now();
const loadArchive = () => JSON.parse(localStorage.getItem(DB_ARCHIVE) || "[]");
const saveArchive = (a) => localStorage.setItem(DB_ARCHIVE, JSON.stringify(a));

// roles helpers
const loadRoles = () => JSON.parse(localStorage.getItem(DB_ROLES) || "[]");
const saveRoles = (r) => localStorage.setItem(DB_ROLES, JSON.stringify(r));
const getPublicRoleKeys = () => loadRoles().filter(r=>r.isPublic).map(r=>r.key);
const roleLabel = (key) => (loadRoles().find(r=>r.key===key)?.label || key);
const slugify = (s) => s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9_]+/g,'_').replace(/^_+|_+$/g,'');

// activity helpers
const loadAct = () => JSON.parse(localStorage.getItem(DB_ACT) || "[]");
const saveAct = (a) => localStorage.setItem(DB_ACT, JSON.stringify(a));
const lastSeenKey = (uid) => `smenar.activity.lastseen.${uid}`;
const getLastSeen = (uid) => parseInt(localStorage.getItem(lastSeenKey(uid))||"0",10);
const setLastSeen = (uid, ts) => localStorage.setItem(lastSeenKey(uid), String(ts||Date.now()));


function isSupportUser(u){
  if(!u) return false;
  const byRole = Array.isArray(u.roles) && u.roles.includes("support");
  const byName = (u.name || "").trim().toLowerCase() === "podpora";
  return byRole || byName;
}

// Glob√°ln√≠ smaz√°n√≠ archivovan√© akce
window.deleteArchivedEvent = function(aid){
  try{
    if(!confirm("Opravdu smazat tuto archivovanou akci?")) return;

    let arc = loadArchive();                    // mus√≠≈° m√≠t definovan√© loadArchive/saveArchive
    const idx = arc.findIndex(x => x.id === aid);
    if(idx < 0){ alert("Akce v archivu nenalezena."); return; }

    const ev = arc[idx];
    arc.splice(idx, 1);
    saveArchive(arc);

    logActivity({
      type: "deleteArchivedEvent",
      userId: ME?.id,
      userName: ME?.name,
      eventId: aid,
      eventTitle: ev?.title || "Ud√°lost"
    });

    toast("Archivovan√° akce smaz√°na", ev?.title || "");
    viewPastEvents();                           // obnov zobrazen√≠ seznamu
  }catch(e){
    console.error("deleteArchivedEvent error:", e);
    alert("Nepoda≈ôilo se smazat archivovanou akci.");
  }
};
// CSV utils (Excel CZ: st≈ôedn√≠k)
function csvEscape(val){
  if(val===null || val===undefined) return "";
  const s = String(val).replace(/\r?\n/g," ");
  return /[\";,\t]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
}
function toCSV(rows, header){
  const lines = [];
  lines.push(header.join(";"));
  rows.forEach(row=>{
    lines.push(header.map(h=> csvEscape(row[h])).join(";"));
  });
  return lines.join("\r\n");
}
function downloadFile(filename, content, mime="text/plain;charset=utf-8"){
  const blob = new Blob([content], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 200);
}

// Privilegium: Admin nebo Podpora
function isMePrivileged(){
  return !!(ME && ( userHasRole(ME,"admin")
    || ((ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora")) ));
}

// ====== Seed ======
(function seed(){
  if(!localStorage.getItem(DB_ROLES)){
    saveRoles([
      { key:"ridic",       label:"≈òidiƒç",       isPublic:true },
      { key:"zza",         label:"ZZA",         isPublic:true },
      { key:"zdravotnik",  label:"Zdravotn√≠k",  isPublic:true },
    ]);
  }
  if(!localStorage.getItem(DB_USERS)){
    save(DB_USERS,[
    {id:"u1",name:"Podpora",password:"support",roles:["support","admin"],isActive:true},
    {id:"u2",name:"admin",password:"1111",roles:["admin"],isActive:true},
    {id:"u3",name:"Adam", password:"adam", roles:["ridic","zza"],isActive:true},
    {id:"u4",name:"B√°ra", password:"bara", roles:["zdravotnik"],isActive:true}
    ]);
  }
  if(!localStorage.getItem(DB_ACTIONS)){
    const pubs = getPublicRoleKeys();
    const capacity = {}; const signups={};
    pubs.forEach(k=>{ capacity[k]= (k==="ridic"?1:(k==="zza"?2: (k==="zdravotnik"?1:0))); signups[k]=[]; });
    save(DB_ACTIONS,[
      { id:"a1", date: today(), title:"Dozor ‚Äì fotbal", location:"Stadion Kladno", timeFrom:"15:00", timeTo:"20:00",
        capacity, signups, signupUnlock:null }
    ]);
  } else {
    // migrace: doplnit date/signupUnlock pokud chyb√≠ a role kl√≠ƒçe podle public rol√≠
    const pubs = getPublicRoleKeys();
    const acts = load(DB_ACTIONS);
    acts.forEach(a=>{
      a.date ||= today();
      a.capacity ||= {}; a.signups ||= {};
      // novƒõ: od kdy je p≈ôihla≈°ov√°n√≠ otev≈ôen√©; null/undefined => hned
      if(typeof a.signupUnlock === 'undefined') a.signupUnlock = null;
	  if(typeof a.isPaid === 'undefined') a.isPaid = false;
	  if(typeof a.adminNote === 'undefined') a.adminNote = "";
      pubs.forEach(k=>{ if(!(k in a.capacity)) a.capacity[k]=0; if(!(k in a.signups)) a.signups[k]=[]; });
      Object.keys(a.capacity).forEach(k=>{ if(!pubs.includes(k)) delete a.capacity[k]; });
      Object.keys(a.signups).forEach(k=>{ if(!pubs.includes(k)) delete a.signups[k]; });
    });
    save(DB_ACTIONS,acts);
  }
  if(!localStorage.getItem(DB_ACT)){
    saveAct([]);
  }
  if(!localStorage.getItem(DB_ARCHIVE)){
  saveArchive([]);
}
})();
// ====== Export ======
// U≈æivatel√© (bez hesel)
window.exportUsersCSV = function(){
  refreshStores();
  if(!(ME && ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") ))){
  alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora.");
  return;
}
  const rows = (USERS||[]).map(u=>({
    id: u.id,
    name: u.name || "",
    roles: (u.roles||[]).join(","),
    isActive: u.isActive ? 1 : 0,
    password_changed_at: u.passwordChangedAt || ""
  }));
  const header = ["id","name","roles","isActive","password_changed_at"];
  downloadFile(`users_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

// Ud√°losti (aktu√°ln√≠)
window.exportEventsCSV = function(){
  refreshStores();
  if(!(ME && ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") ))){
  alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora.");
  return;
}
  const pubs = getPublicRoleKeys();
  const header = ["id","date","title","location","timeFrom","timeTo","signupUnlock","isPaid","adminNote"]
    .concat(pubs.map(k=>"cap_"+k))
    .concat(pubs.map(k=>"signups_count_"+k))
    .concat(pubs.map(k=>"signups_names_"+k));

  const rows = (ACTIONS||[]).map(a=>{
    const row = {
      id:a.id, date:a.date, title:a.title||"", location:a.location||"",
      timeFrom:a.timeFrom||"", timeTo:a.timeTo||"",
      signupUnlock: a.signupUnlock||"",
      isPaid: a.isPaid?1:0,
      adminNote: a.adminNote||""
    };
    pubs.forEach(k=>{
      const cap = a.capacity?.[k] ?? 0;
      const list = a.signups?.[k] || [];
      const names = list.map(id=> (getUserById(id)||{}).name).filter(Boolean).join(", ");
      row["cap_"+k] = cap;
      row["signups_count_"+k] = list.length;
      row["signups_names_"+k] = names;
    });
    return row;
  });

  downloadFile(`events_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

// Archivovan√© ud√°losti
window.exportArchiveCSV = function(){
  refreshStores();
  if(!(ME && ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") ))){
  alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora.");
  return;
}
  const arc = loadArchive();
  const pubs = getPublicRoleKeys();
  const header = ["id","date","title","location","timeFrom","timeTo","signupUnlock","isPaid","adminNote"]
    .concat(pubs.map(k=>"cap_"+k))
    .concat(pubs.map(k=>"signups_count_"+k))
    .concat(pubs.map(k=>"signups_names_"+k));

  const rows = (arc||[]).map(a=>{
    const row = {
      id:a.id, date:a.date, title:a.title||"", location:a.location||"",
      timeFrom:a.timeFrom||"", timeTo:a.timeTo||"",
      signupUnlock: a.signupUnlock||"",
      isPaid: a.isPaid?1:0,
      adminNote: a.adminNote||""
    };
    pubs.forEach(k=>{
      const cap = a.capacity?.[k] ?? 0;
      const list = a.signups?.[k] || [];
      const names = list.map(id=> (getUserById(id)||{}).name).filter(Boolean).join(", ");
      row["cap_"+k] = cap;
      row["signups_count_"+k] = list.length;
      row["signups_names_"+k] = names;
    });
    return row;
  });

  downloadFile(`archive_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

// P≈ôihl√°≈°ky (≈ô√°dkovƒõ z obou sad)
window.exportSignupsCSV = function(){
  refreshStores();
  if(!(ME && ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") ))){
  alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora.");
  return;
}
  const pubs = getPublicRoleKeys();
  const rows = [];

  function pushFrom(source, arr){
    (arr||[]).forEach(a=>{
      pubs.forEach(k=>{
        (a.signups?.[k] || []).forEach(uid=>{
          const u = getUserById(uid)||{};
          rows.push({
            source, event_id:a.id, event_title:a.title||"", date:a.date||"",
            role:k, user_id:uid, user_name:u.name||"",
            isPaid: a.isPaid?1:0
          });
        });
      });
    });
  }
  pushFrom("active", ACTIONS);
  pushFrom("archive", loadArchive());

  const header = ["source","event_id","event_title","date","role","user_id","user_name","isPaid"];
  downloadFile(`signups_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

// Kompletn√≠ JSON z√°loha (vƒçetnƒõ hesel)
window.exportBackupJSON = function(){
  refreshStores();
  if(!(ME && ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") ))){
  alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora.");
  return;
}
  const payload = {
    version: 1,
    exportedAt: new Date().toISOString(),
    users: USERS || [],
    roles: loadRoles() || [],
    actions: ACTIONS || [],
    archive: loadArchive() || []
  };
  downloadFile(`backup_${today()}.json`, JSON.stringify(payload,null,2), "application/json;charset=utf-8");
};

// V≈°e najednou
window.exportAll = function(){
if(!(ME && ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") ))){
  alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora.");
  return;
}
  exportUsersCSV();
  exportEventsCSV();
  exportArchiveCSV();
  exportSignupsCSV();
  exportBackupJSON();
};

// ====== Stav ======
let USERS   = load(DB_USERS);
let ACTIONS = load(DB_ACTIONS);
let ME      = null;
let ACTIVE_ROLE = null;
let adminWatchTimer = null;

// ====== Helpery ======
function refreshStores(){ USERS = load(DB_USERS); ACTIONS = load(DB_ACTIONS); }
function getUserById(id){ return USERS.find(u=>u.id===id) || null; }
function userHasRole(u, r){ return (u.roles||[]).includes(r); }
function userPublicRoles(u){ const pubs = getPublicRoleKeys(); return (u.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){
  if(!ME) { ACTIVE_ROLE = null; return; }
  const prs = userPublicRoles(ME);
  if(!prs.length){ ACTIVE_ROLE = null; return; }
  if(!ACTIVE_ROLE || !prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE = prs[0];
}
function fmtDate(d){ return d || "‚Äî"; }
function fmtTime(t){ return t || "‚Äî"; }
function sortEvents(a,b){
  const A = (a.date||"") + " " + (a.timeFrom||"00:00");
  const B = (b.date||"") + " " + (b.timeFrom||"00:00");
  return A.localeCompare(B);
}
function safeHHMM(s){
  return /^\d{2}:\d{2}$/.test(s||"") ? s : "";
}
function eventEndMs(a){
  const d = a?.date || today();
  const end = safeHHMM(a?.timeTo) || safeHHMM(a?.timeFrom) || "23:59";
  const dt = new Date(`${d}T${end}`);
  const t = dt.getTime();
  return isNaN(t) ? new Date(`${d}T23:59`).getTime() : t;
}
function isPastEvent(a){
  return nowMs() > eventEndMs(a);
}

// Automatick√Ω p≈ôesun probƒõhl√Ωch akc√≠ do archivu
function archiveSweep(){
  refreshStores();
  let acts = load(DB_ACTIONS);
  let arc  = loadArchive();

  const toMove = acts.filter(isPastEvent);
  if(!toMove.length) return;

  const keep = acts.filter(a => !isPastEvent(a));
  ACTIONS = keep;
  save(DB_ACTIONS, ACTIONS);

  // Nov√© kusy dej na zaƒç√°tek archivu (nejnovƒõj≈°√≠ naho≈ôe)
  const moved = toMove.slice().sort(sortEvents).reverse();
  arc = [...moved, ...arc];
  saveArchive(arc);

  moved.forEach(a=>{
    logActivity({ type:"archiveEvent", userId:ME?.id, userName:ME?.name, eventId:a.id, eventTitle:a.title });
  });
}
function getUnlockMs(a){
  if(!a || !a.signupUnlock) return 0; // 0 => hned
  const ms = new Date(a.signupUnlock).getTime();
  return isNaN(ms) ? 0 : ms;
}

// ====== Toasty ======
function toast(msg, sub){
  const wrap=document.getElementById("toasts");
  const el=document.createElement("div");
  el.className="toast";
  el.innerHTML = `<div>${msg}</div>${sub?`<small>${sub}</small>`:""}`;
  wrap.appendChild(el);
  setTimeout(()=>{
    el.style.opacity="0"; el.style.transform="translateY(8px)"; el.style.transition="all .25s";
    setTimeout(()=>wrap.removeChild(el), 260);
  }, 3000);
}

// ====== Header ======
function renderHeader(){
  const el = document.getElementById("hdr");
  if(!ME){ el.innerHTML = ""; return; }
  ensureActiveRole();
  const prs = userPublicRoles(ME);
  const roleSel = ACTIVE_ROLE && prs.length
    ? `<select class="select" id="selActiveRole">${prs.map(r=>`<option value="${r}" ${r===ACTIVE_ROLE?"selected":''}>${roleLabel(r)}</option>`).join("")}</select>`
    : `<span class="muted">Bez ve≈ôejn√© role</span>`;
  el.innerHTML = `
    <div class="row">
      <span class="badge">${ME.name}</span>
      ${roleSel}
      ${userHasRole(ME,"admin") ? `
      <div class="menu" id="adminMenu">
        <button class="btn" id="adminBtn">Admin ‚ñæ</button>
        <div class="dropdown">
          <button onclick="viewEvents()">Ud√°losti</button>
		  <button onclick="viewPastEvents()">Probƒõhl√© akce</button>
          <button onclick="viewMembers()">ƒålenov√©</button>
          <button onclick="viewRoles()">Role</button>
          <button onclick="viewActivity()">Aktivita</button>
          <button onclick="viewCreateEvent()">Nov√° ud√°lost</button>
		  ${ isSupportUser(ME) ? `<button onclick="viewExport()">Export / Z√°loha</button>` : "" }
        </div>
      </div>` : ""}
      <button class="btn" onclick="logout()">Odhl√°sit</button>
    </div>`;
  const sel = document.getElementById("selActiveRole");
  if(sel){ sel.onchange = () => { ACTIVE_ROLE = sel.value; renderApp(); }; }
  const menu = document.getElementById("adminMenu");
  if(menu){
    const btn = document.getElementById("adminBtn");
    btn.addEventListener("click", (e)=>{ e.stopPropagation(); menu.classList.toggle("open"); });
    document.addEventListener("click", (e)=>{ if(!menu.contains(e.target)) menu.classList.remove("open"); });
  }
}

// ====== Login view ======
function viewLogin(){
  const app = document.getElementById("app");
  app.innerHTML = `
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>P≈ôihl√°≈°en√≠</h3>
      <input id="loginName" class="input" placeholder="Jm√©no">
      <div class="row" style="justify-content:space-between;width:100%">
        <input id="loginPass" class="input" type="password" placeholder="Heslo" style="flex:1">
        <button class="btn" id="togglePass">üëÅÔ∏è</button>
      </div>
      <button class="btn primary" id="btnLogin">P≈ôihl√°sit</button>
    </div>`;
  document.getElementById("togglePass").onclick = () => {
    const i = document.getElementById("loginPass"); i.type = (i.type==="password"?"text":"password");
  };
  document.getElementById("btnLogin").onclick = () => {
    refreshStores();
    const n = document.getElementById("loginName").value.trim();
    const p = document.getElementById("loginPass").value;
    const u = USERS.find(x=>x.name===n && x.password===p && x.isActive!==false);
    if(!u){ alert("Neplatn√© √∫daje"); return; }
    ME = u; setSession(ME.id); ensureActiveRole(); startAdminWatcher(); renderApp();
  };
}

// ====== Admin watcher (polling) ======
function startAdminWatcher(){
  if(adminWatchTimer) { clearInterval(adminWatchTimer); adminWatchTimer=null; }
  if(!ME || !userHasRole(ME,"admin")) return;
  // show latest unseen items every 3s
  adminWatchTimer = setInterval(()=>{
    const last = getLastSeen(ME.id);
    const list = loadAct();
    const unseen = list.filter(x=> x.ts > last);
    if(unseen.length){
      unseen.slice(-5).forEach(x=>{
        const who = x.userName || (getUserById(x.userId)?.name) || "u≈æivatel";
        const ev  = x.eventTitle || (ACTIONS.find(a=>a.id===x.eventId)?.title) || "ud√°lost";
        const role = x.roleKey ? ` (${roleLabel(x.roleKey)})` : "";
        const verb = x.type==="join"?"p≈ôihl√°sil":"odhl√°sil";
        const msg = (x.type==="join"||x.type==="leave")
          ? `${who} se ${verb} na ${ev}${role}`
          : x.type==="assign" ? `${who} p≈ôi≈ôazen na ${ev}${role}`
          : x.type==="remove" ? `${who} odebr√°n z ${ev}${role}`
          : x.type==="createEvent" ? `Vytvo≈ôena ud√°lost: ${ev}`
          : x.type==="updateEvent" ? `Upravena ud√°lost: ${ev}`
          : x.type==="deleteEvent" ? `Smaz√°na ud√°lost: ${ev}`
          : `Aktivita: ${ev}`;
        toast("Aktivita", msg);
      });
      setLastSeen(ME.id, unseen[unseen.length-1].ts);
    }
  }, 3000);
}

// ====== Activity log ======
function logActivity(entry){
  const list = loadAct();
  const item = Object.assign({ id: uid(), ts: Date.now() }, entry);
  list.push(item); saveAct(list);
  // vlastn√≠ toast pro u≈æivatele (potvrzen√≠)
  if(ME){
    const role = item.roleKey ? ` (${roleLabel(item.roleKey)})` : "";
    if(item.type==="join")   toast("P≈ôihl√°≈°en√≠ OK", `Na ${item.eventTitle}${role}`);
    if(item.type==="leave")  toast("Odhl√°≈°en√≠ OK", `Z ${item.eventTitle}${role}`);
    if(item.type==="assign") toast("P≈ôi≈ôazeno", `Na ${item.eventTitle}${role}`);
    if(item.type==="remove") toast("Odebr√°no", `Z ${item.eventTitle}${role}`);
    if(item.type==="createEvent") toast("Ud√°lost ulo≈æena", item.eventTitle||"");
    if(item.type==="updateEvent") toast("Ud√°lost ulo≈æena", item.eventTitle||"");
    if(item.type==="deleteEvent") toast("Ud√°lost smaz√°na", item.eventTitle||"");
  }
}

// ====== Events view ======
function viewEvents(){
  archiveSweep();
  const app = document.getElementById("app");
  ensureActiveRole();
  refreshStores();
  const pubRoles = getPublicRoleKeys();
  const cards = ACTIONS.slice().sort(sortEvents).map(a=>{
    const capHtml = pubRoles.map(r=>{
      const list = a.signups[r]||[];
      const names = list.map(id=> (getUserById(id)||{}).name ).filter(Boolean).join(", ");
      return `<li><b>${roleLabel(r)}</b>: ${list.length}/${a.capacity[r]||0} ‚Äî ${names||"‚Äî"}</li>`;
    }).join("");

const payBox = isMePrivileged() ? `
  <div class="admin-box" style="margin-top:8px">
    <div class="row" style="justify-content:space-between;align-items:center">
      <label class="row" style="gap:8px">
        <input type="checkbox" id="paid_${a.id}" ${a.isPaid?'checked':''}
               onchange="togglePaid('${a.id}', this.checked, 'active')">
        <b>Akce zaplacena</b>
      </label>
      <button class="btn" onclick="saveAdminNote('${a.id}', 'active')">Ulo≈æit pozn√°mku</button>
    </div>
    <textarea id="note_${a.id}" class="textarea" rows="2" placeholder="Pozn√°mka pro admina...">${a.adminNote||""}</textarea>
  </div>` : "";

    const adminManage = userHasRole(ME,"admin") ? renderAdminManageBox(a, pubRoles) : "";

    // P≈ôihla≈°ov√°n√≠ od/lock
    const unlockMs = getUnlockMs(a);
    const isOpen = unlockMs === 0 || nowMs() >= unlockMs;

    let actionBtn = "";
    if(!isOpen){
      const when = a.signupUnlock ? new Date(a.signupUnlock).toLocaleString() : "";
      actionBtn = `<span class="muted">P≈ôihla≈°ov√°n√≠ se otev≈ôe: <b>${when}</b></span>`;
    } else if(ACTIVE_ROLE){
      const myList = a.signups[ACTIVE_ROLE]||[];
      const isIn   = myList.includes(ME.id);
      if(isIn){
        actionBtn = `<button class="btn danger" onclick="leaveEvent('${a.id}')">Odhl√°sit se</button>`;
      }else{
        const full = (myList.length >= (a.capacity[ACTIVE_ROLE]||0));
        actionBtn = full ? `<span class="muted">Kapacita pro roli ${roleLabel(ACTIVE_ROLE)} je pln√°</span>`
                         : `<button class="btn primary" onclick="joinEvent('${a.id}')">P≈ôihl√°sit se</button>`;
      }
    }else{
      actionBtn = `<span class="muted">Nem√°te vybranou ve≈ôejnou roli</span>`;
    }

    const evHistory = renderEventHistory(a.id, 5);

    return `
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700">${a.title}</div>
            <div class="muted">${fmtDate(a.date)} ‚Ä¢ ${a.location||"‚Äî"} ‚Ä¢ ${(a.timeFrom||"")}${a.timeTo?("‚Äì"+a.timeTo):""}</div>
            ${a.signupUnlock ? `<div class="muted" style="font-size:12px">Odemknut√≠ p≈ôihla≈°ov√°n√≠: <b>${new Date(a.signupUnlock).toLocaleString()}</b></div>` : ''}
          </div>
          <div class="row">
            ${userHasRole(ME,"admin") ? `<button class="btn" onclick="editEvent('${a.id}')">Upravit</button>` : ""}
            ${userHasRole(ME,"admin") ? `<button class="btn danger" onclick="deleteEvent('${a.id}')">Smazat</button>` : ""}
          </div>
        </div>
        <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>
        <div class="row" style="margin-top:8px">${actionBtn}</div>
        ${payBox}
		${adminManage}
        ${evHistory}
      </div>`;
  }).join("");
  app.innerHTML = `<h3>Ud√°losti</h3>${cards || `<div class="card muted">≈Ω√°dn√© ud√°losti.</div>`}`;
}

function renderEventHistory(eventId, limit){
  const list = loadAct().filter(x=>x.eventId===eventId).slice(-limit);
  if(!list.length) return "";
  const items = list.map(x=>{
    const who = x.userName || (getUserById(x.userId)?.name) || "u≈æivatel";
    const role = x.roleKey ? ` (${roleLabel(x.roleKey)})` : "";
    const date = new Date(x.ts).toLocaleString();
    let txt = x.type;
    if(x.type==="join") txt = `p≈ôihl√°≈°en√≠${role}`;
    if(x.type==="leave") txt = `odhl√°≈°en√≠${role}`;
    if(x.type==="assign") txt = `p≈ôi≈ôazen${role}`;
    if(x.type==="remove") txt = `odebr√°n${role}`;
    if(x.type==="createEvent") txt = `vytvo≈ôen√≠ ud√°losti`;
    if(x.type==="updateEvent") txt = `√∫prava ud√°losti`;
    if(x.type==="deleteEvent") txt = `smaz√°n√≠ ud√°losti`;
    return `<li>${date}: <b>${who}</b> ‚Äì ${txt}</li>`;
  }).join("");
  return `<details class="admin-box"><summary><b>Historie ud√°losti</b></summary><ul class="list-plain" style="margin-top:8px">${items}</ul></details>`;
}

function renderAdminManageBox(a, pubRoles){
  const removeBlocks = pubRoles.map(r=>{
    const list = a.signups[r]||[];
    const items = list.map(uid=>{
      const u = getUserById(uid);
      const nm = u ? u.name : uid;
      return `<li>${nm} <button class="btn ghost danger" onclick="adminRemove('${a.id}','${r}','${uid}')">√ó</button></li>`;
    }).join("") || `<li class="muted">Nikdo</li>`;
    return `<div><b>${roleLabel(r)} ‚Äì odebrat:</b><ul class="list-plain">${items}</ul></div>`;
  }).join("");

  const assignForms = pubRoles.map(r=>{
    const signed = new Set(a.signups[r]||[]);
    const candidates = USERS
      .filter(u=> userHasRole(u,r) && !signed.has(u.id) )
      .map(u=> `<option value="${u.id}">${u.name}</option>`)
      .join("");
    return `<div class="grid2" style="margin-top:6px">
        <div><label>P≈ôi≈ôadit jako ${roleLabel(r)}:
          <select id="assign_${a.id}_${r}" class="select">
            <option value="">‚Äî vyberte ƒçlena ‚Äî</option>
            ${candidates}
          </select>
        </label></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" onclick="adminAssign('${a.id}','${r}')">P≈ôi≈ôadit</button>
        </div>
      </div>`;
  }).join("");

  return `<details class="admin-box"><summary><b>Spr√°va √∫ƒçasti (admin)</b></summary>
    <div style="margin-top:8px">
      ${removeBlocks}
      <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
      ${assignForms}
    </div>
  </details>`;
}
// ====== View Past events ======
function viewPastEvents(){
  // automatick√Ω p≈ôesun, kdyby nƒõco novƒõ dobƒõhlo
  archiveSweep();

  const app = document.getElementById("app");
  let arc = loadArchive();

  // self-heal: doplnit defaulty pro star√© polo≈æky v archivu
  let fixed = false;
  arc.forEach(a=>{
    if(typeof a.isPaid === "undefined"){ a.isPaid = false; fixed = true; }
    if(typeof a.adminNote === "undefined"){ a.adminNote = ""; fixed = true; }
  });
  if(fixed) saveArchive(arc);

  if(!arc.length){
    app.innerHTML = `<h3>Probƒõhl√© akce</h3><div class="card muted">Zat√≠m ≈æ√°dn√© probƒõhl√© akce.</div>`;
    return;
  }

  const cards = arc.map(a=>{
    const pubRoles = getPublicRoleKeys();

    const capHtml = pubRoles.map(r=>{
      const list = a.signups?.[r] || [];
      const names = list.map(id=> (getUserById(id)||{}).name).filter(Boolean).join(", ");
      const cap = a.capacity?.[r] ?? 0;
      return `<li><b>${roleLabel(r)}</b>: ${list.length}/${cap} ‚Äî ${names||"‚Äî"}</li>`;
    }).join("");

    const paidBadge = (isMePrivileged() && a.isPaid)
      ? `<span class="badge" style="margin-left:8px;background:#ecfdf5;border-color:#10b981;color:#065f46">Zaplaceno</span>`
      : "";

    // ‚¨áÔ∏è NOV√ù admin box ‚Äì vid√≠ jen admin/Podpora, EDITUJ√ç i v archivu
    const payBox = isMePrivileged() ? `
      <div class="admin-box" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px">
            <input type="checkbox" id="paid_${a.id}" ${a.isPaid?'checked':''}
                   onchange="togglePaid('${a.id}', this.checked, 'archive')">
            <b>Akce zaplacena</b>
          </label>
          <button class="btn" onclick="saveAdminNote('${a.id}', 'archive')">Ulo≈æit pozn√°mku</button>
        </div>
        <textarea id="note_${a.id}" class="textarea" rows="2" placeholder="Pozn√°mka pro admina...">${a.adminNote||""}</textarea>
      </div>` : "";

    const evHistory = renderEventHistory(a.id, 8);

    const adminBtns = isMePrivileged() ? `
  <div class="row">
    <button class="btn danger" onclick="deleteArchivedEvent('${a.id}')">Smazat z archivu</button>
  </div>
` : "";


    return `
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700">${a.title} ${paidBadge}</div>
            <div class="muted">${fmtDate(a.date)} ‚Ä¢ ${a.location||"‚Äî"} ‚Ä¢ ${(a.timeFrom||"")}${a.timeTo?("‚Äì"+a.timeTo):""}</div>
          </div>
          ${adminBtns}
        </div>
        <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>

        ${payBox}     <!-- ‚¨ÖÔ∏è EDITACE v archivu -->

        ${evHistory}
      </div>
    `;
  }).join("");

  app.innerHTML = `<h3>Probƒõhl√© akce</h3>${cards}`;
}

// ====== Export ======
function viewExport(){
  refreshStores();
  if(!isSupportUser(ME)){      
    alert("Export je povolen pouze pro √∫ƒçet Podpora.");
    viewEvents();
    return;
  }

  const app = document.getElementById("app");
  app.innerHTML = `
    <h3>Export / Z√°loha</h3>
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">CSV export</div>
          <div class="muted" style="font-size:12px">Oddƒõlovaƒç: st≈ôedn√≠k. Pozn.: CSV neobsahuj√≠ hesla.</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" onclick="exportUsersCSV()">U≈æivatel√©</button>
          <button class="btn" onclick="exportEventsCSV()">Ud√°losti</button>
          <button class="btn" onclick="exportArchiveCSV()">Archiv</button>
          <button class="btn" onclick="exportSignupsCSV()">P≈ôihl√°≈°ky</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:600">Pln√° z√°loha (JSON)</div>
          <div class="muted" style="font-size:12px">Obsahuje v≈°e (vƒçetnƒõ hesel). Chra≈àte soubor!</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn primary" onclick="exportBackupJSON()">St√°hnout backup.json</button>
          <button class="btn" onclick="exportAll()">St√°hnout v≈°e (4√óCSV + JSON)</button>
        </div>
      </div>
    </div>
  `;
}


// ====== Join / Leave ======
function joinEvent(aid){
  refreshStores();
  const a = ACTIONS.find(x=>x.id===aid); if(!a) return;
  // kontrola odemknut√≠
  const unlockMs = getUnlockMs(a);
  if(unlockMs !== 0 && nowMs() < unlockMs){
    alert("P≈ôihla≈°ov√°n√≠ je≈°tƒõ nen√≠ otev≈ôen√©.");
    return;
  }
  if(!ACTIVE_ROLE){ alert("Nem√°te vybranou ve≈ôejnou roli"); return; }
  a.signups[ACTIVE_ROLE] = a.signups[ACTIVE_ROLE] || [];
  if(a.signups[ACTIVE_ROLE].includes(ME.id)){ alert("U≈æ jste p≈ôihl√°≈°en/a"); return; }
  if((a.signups[ACTIVE_ROLE].length) >= (a.capacity[ACTIVE_ROLE]||0)){ alert("Kapacita pln√°"); return; }
  a.signups[ACTIVE_ROLE].push(ME.id);
  save(DB_ACTIONS,ACTIONS);
  logActivity({ type:"join", userId:ME.id, userName:ME.name, roleKey:ACTIVE_ROLE, eventId:a.id, eventTitle:a.title });
  viewEvents();
}
function leaveEvent(aid){
  refreshStores();
  const a = ACTIONS.find(x=>x.id===aid); if(!a) return;
  if(!ACTIVE_ROLE) return;
  a.signups[ACTIVE_ROLE] = (a.signups[ACTIVE_ROLE]||[]).filter(id=>id!==ME.id);
  save(DB_ACTIONS,ACTIONS);
  logActivity({ type:"leave", userId:ME.id, userName:ME.name, roleKey:ACTIVE_ROLE, eventId:a.id, eventTitle:a.title });
  viewEvents();
}
// ====== Admin: Pozn√°mka platba ======
function isMePrivileged(){
  // viditeln√© pro admin + Podpora (Podpora m≈Ø≈æe/nemus√≠ m√≠t 'support', ale obvykle m√° i 'admin')
  return !!(ME && (userHasRole(ME,"admin") || ( (ME.roles||[]).includes("support") || ((ME.name||"").trim().toLowerCase()==="podpora") )));
}

function isMePrivileged(){
  return !!(ME && (userHasRole(ME,"admin") ||
         ( (ME.roles||[]).includes("support") ||
           ((ME.name||"").trim().toLowerCase()==="podpora"))));
}

function togglePaid(aid, val, origin){
  refreshStores();
  let changed = false;

  // Zkus nejd≈ô√≠v aktu√°ln√≠ akce
  let a = ACTIONS.find(x=>x.id===aid);
  if(a){
    a.isPaid = !!val;
    save(DB_ACTIONS, ACTIONS);
    changed = true;
  } else {
    // Zkus archiv
    let arc = loadArchive();
    const idx = arc.findIndex(x=>x.id===aid);
    if(idx>=0){
      arc[idx].isPaid = !!val;
      saveArchive(arc);
      changed = true;
    }
  }

  if(changed){
    const title = a ? a.title : (loadArchive().find(x=>x.id===aid)?.title || "Ud√°lost");
    logActivity({ type:"markPaid", userId:ME?.id, userName:ME?.name, eventId:aid, eventTitle:title, value:!!val });
    if(origin === "archive")      { viewPastEvents(); }
    else if(origin === "active")  { viewEvents(); }
    else                          { renderApp(); }
  }
}

function saveAdminNote(aid, origin){
  refreshStores();
  let updated = false; let title = "Ud√°lost";

  // Aktu√°ln√≠ akce
  let a = ACTIONS.find(x=>x.id===aid);
  if(a){
    const el = document.getElementById(`note_${aid}`);
    a.adminNote = el ? el.value : "";
    save(DB_ACTIONS, ACTIONS);
    updated = true; title = a.title;
  } else {
    // Archiv
    let arc = loadArchive();
    const idx = arc.findIndex(x=>x.id===aid);
    if(idx>=0){
      const el = document.getElementById(`note_${aid}`);
      arc[idx].adminNote = el ? el.value : "";
      title = arc[idx].title || title;
      saveArchive(arc);
      updated = true;
    }
  }

  if(updated){
    logActivity({ type:"adminNote", userId:ME?.id, userName:ME?.name, eventId:aid, eventTitle:title });
    toast("Pozn√°mka ulo≈æena", title);
    if(origin === "archive")      { viewPastEvents(); }
    else if(origin === "active")  { viewEvents(); }
    else                          { renderApp(); }
  }
}

// ====== Admin: p≈ôi≈ôadit / odebrat ======
function adminAssign(aid, role){
  refreshStores();
  const a = ACTIONS.find(x=>x.id===aid); if(!a) return;
  const sel = document.getElementById(`assign_${aid}_${role}`);
  const uid = sel && sel.value ? sel.value : "";
  if(!uid){ alert("Vyberte ƒçlena"); return; }
  a.signups[role] = a.signups[role] || [];
  if(a.signups[role].includes(uid)){ alert("ƒålen u≈æ je p≈ôihl√°≈°en v t√©to roli"); return; }
  if(a.signups[role].length >= (a.capacity[role]||0)){ alert("Kapacita pro tuto roli je pln√°"); return; }
  a.signups[role].push(uid);
  save(DB_ACTIONS,ACTIONS);
  const userName = (getUserById(uid)||{}).name || uid;
  logActivity({ type:"assign", userId:uid, userName, roleKey:role, eventId:a.id, eventTitle:a.title });
  viewEvents();
}
function adminRemove(aid, role, uid){
  refreshStores();
  const a = ACTIONS.find(x=>x.id===aid); if(!a) return;
  a.signups[role] = (a.signups[role]||[]).filter(id=>id!==uid);
  save(DB_ACTIONS,ACTIONS);
  const userName = (getUserById(uid)||{}).name || uid;
  logActivity({ type:"remove", userId:uid, userName, roleKey:role, eventId:a.id, eventTitle:a.title });
  viewEvents();
}

// ====== Delete/Edit/Create Event (admin) ======
function deleteEvent(aid){
  if(!confirm("Opravdu smazat tuto ud√°lost?")) return;
  refreshStores();
  const a = ACTIONS.find(x=>x.id===aid);
  ACTIONS = ACTIONS.filter(x=>x.id!==aid);
  save(DB_ACTIONS, ACTIONS);
  logActivity({ type:"deleteEvent", userId:ME.id, userName:ME.name, eventId:aid, eventTitle:a?a.title:"Ud√°lost" });
  viewEvents();
}
function editEvent(id){ viewCreateEvent(id); }

function viewCreateEvent(editId){
  refreshStores();
  const a = editId ? ACTIONS.find(x=>x.id===editId) : null;
  const vals = (a||{});
  const app = document.getElementById("app");
  const pubs = getPublicRoleKeys();

  // p≈ôevod ISO -> value pro datetime-local
  const unlockVal = a && a.signupUnlock ? new Date(a.signupUnlock) : null;
  const pad = n => String(n).padStart(2,'0');
  const toLocalDTVal = (d) => {
    if(!d) return '';
    const y=d.getFullYear(); const m=pad(d.getMonth()+1); const da=pad(d.getDate());
    const h=pad(d.getHours()); const mi=pad(d.getMinutes());
    return `${y}-${m}-${da}T${h}:${mi}`;
  };

  app.innerHTML = `
    <h3>${a?"Upravit ud√°lost":"Nov√° ud√°lost"}</h3>
    <div class="card">
      <div class="grid3">
        <input id="evTitle" class="input" placeholder="N√°zev" value="${a?vals.title:""}">
        <input id="evLocation" class="input" placeholder="M√≠sto" value="${a?vals.location:""}">
        <input id="evDate" class="input" type="date" value="${a?(vals.date||today()):today()}">
      </div>
	  <div class="grid3" style="margin-top:8px">
		<input id="evTitle" class="input" placeholder="Poƒçet aut" value="${a?vals.title:""}">
		<input id="evTitle" class="input" placeholder="Pozn√°mka" value="${a?vals.title:""}">
		</div>
      <div class="grid3" style="margin-top:8px">ƒåas od - do</div>
        <input id="evFrom" class="input" type="time" value="${a?(vals.timeFrom||"" ): ""}">
        <input id="evTo" class="input" type="time" value="${a?(vals.timeTo||"" ): ""}">
	  <div class="grid3" style="margin-top:8px">Odemknut√≠ p≈ôihl√°≈°en√≠ od</div>
        <input id="evUnlock" class="input" type="datetime-local" value="${toLocalDTVal(unlockVal)}" placeholder="Odemknut√≠ p≈ôihla≈°ov√°n√≠">
	  <div class="grid3" style="margin-top:8px">
        ${pubs.map(r=>`
          <div>
            <div class="muted" style="font-size:12px">${roleLabel(r)}</div>
            <input id="cap_${r}" class="input" type="number" min="0" value="${a?(vals.capacity&&vals.capacity[r]||0):0}">
          </div>`).join("")}
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" onclick="viewEvents()">Zpƒõt</button>
        <button class="btn primary" onclick="${a?`saveEvent('${a.id}')`:`saveEvent(null)`}">Ulo≈æit</button>
      </div>
	  <div class="muted" style="margin-top:6px;font-size:12px;color:red">NEZAPOME≈á NA POƒåTY ƒåLEN≈Æ.</div>
    </div>`;
}
function saveEvent(editId){
  refreshStores();
  const pubs = getPublicRoleKeys();
  const title = (document.getElementById("evTitle").value||"").trim();
  if(!title){ alert("Zadejte n√°zev ud√°losti"); return; }
  const capacity = {}; pubs.forEach(r=> capacity[r] = parseInt(document.getElementById("cap_"+r).value||"0",10) );
  const date = document.getElementById("evDate").value || today();
  const unlockInput = document.getElementById("evUnlock").value;
  const unlockIso = unlockInput ? new Date(unlockInput).toISOString() : null;

  let ev;
  if(editId){
    const old = ACTIONS.find(x=>x.id===editId) || {signups:{}};
    const signups = {}; pubs.forEach(r=> signups[r] = (old.signups[r]||[]) );
    ev = {
      id: editId,
      date,
      title,
      location: document.getElementById("evLocation").value||"",
      timeFrom: document.getElementById("evFrom").value||"",
      timeTo: document.getElementById("evTo").value||"",
      signupUnlock: unlockIso,
      capacity, signups,
      // ‚¨á‚¨á D≈ÆLE≈ΩIT√â: zachovat stav platby a pozn√°mku
      isPaid: (typeof old.isPaid === "boolean") ? old.isPaid : false,
      adminNote: (typeof old.adminNote === "string") ? old.adminNote : ""
    };
    ACTIONS = ACTIONS.map(x=> x.id===editId ? ev : x);
    save(DB_ACTIONS,ACTIONS);
    logActivity({ type:"updateEvent", userId:ME.id, userName:ME.name, eventId:ev.id, eventTitle:ev.title });
  }else{
    const signups={}; pubs.forEach(r=> signups[r]=[] );
    ev = {
      id: uid(),
      date,
      title,
      location: document.getElementById("evLocation").value||"",
      timeFrom: document.getElementById("evFrom").value||"",
      timeTo: document.getElementById("evTo").value||"",
      signupUnlock: unlockIso,
      capacity, signups,
      // ‚¨á‚¨á D≈ÆLE≈ΩIT√â: nov√© akce inicializovat
      isPaid: false,
      adminNote: ""
    };
    ACTIONS = [ev, ...ACTIONS];
    save(DB_ACTIONS,ACTIONS);
    logActivity({ type:"createEvent", userId:ME.id, userName:ME.name, eventId:ev.id, eventTitle:ev.title });
  }
  ME = getUserById(getSession()) || ME;
  ensureActiveRole();
  viewEvents();
}


// ====== Members (admin) ======
function isSupportUser(u){
  if(!u) return false;
  const byRole = Array.isArray(u.roles) && u.roles.includes("support");
  const byName = (u.name || "").trim().toLowerCase() === "podpora";
  return byRole || byName;
}

function viewMembers(){
  try{
    refreshStores();
    const app   = document.getElementById("app");
    const roles = Array.isArray(loadRoles()) ? loadRoles() : [];
const meIsSupport = !!(ME && (
  (ME.roles || []).includes("support") ||
  ((ME.name || "").trim().toLowerCase() === "podpora")
));


    // Formul√°≈ô "Vytvo≈ôit ƒçlena"
    const create = `
      <div class="card">
        <h4>Vytvo≈ôit ƒçlena</h4>
        <div class="grid2">
          <input id="newName" class="input" placeholder="Jm√©no">
          <div class="row">
            <input id="newPass" class="input" type="password" placeholder="Heslo" style="flex:1">
            <button class="btn" id="toggleNewPass">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          ${roles.map(r=>`
            <label class="pill"><input type="checkbox" id="role_${r.key}"><span>${r.label}</span></label>
          `).join("")}
          ${meIsSupport
            ? `<label class="pill"><input type="checkbox" id="role_admin"><span>Admin</span></label>`
            : `<label class="pill"><input type="checkbox" id="role_admin" disabled title="Admin m≈Ø≈æe p≈ôidat jen Podpora"><span>Admin</span></label>`
          }
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn primary" onclick="createUser()">Vytvo≈ôit</button>
        </div>
      </div>`;

    // Admin (bez support) neuvid√≠ √∫ƒçet Podpora
    const visibleUsers = meIsSupport ? USERS : USERS.filter(u => !isSupportUser(u));

    const list = visibleUsers.map(u=>{
      const rid = "pw_"+u.id;

      // Heslo √∫ƒçtu Podpora sm√≠ vidƒõt/mƒõnit jen p≈ôihl√°≈°en√° Podpora
      const canSeePw = meIsSupport || !isSupportUser(u);
      const pwValue  = canSeePw ? (u.password || "") : "";
      const pwAttrs  = canSeePw ? "" : 'placeholder="********" disabled';

      const roleChk = (r) => `
        <label class="pill">
          <input type="checkbox" id="edit_${u.id}_${r.key}" ${(u.roles||[]).includes(r.key) ? "checked" : ""}>
          <span>${r.label}</span>
        </label>`;

      const adminChecked = (u.roles||[]).includes("admin");
      const adminChk = meIsSupport
        ? `<label class="pill"><input type="checkbox" id="edit_${u.id}_admin" ${adminChecked?"checked":""}><span>Admin</span></label>`
        : `<label class="pill"><input type="checkbox" id="edit_${u.id}_admin" ${adminChecked?"checked":""} disabled title="Admin m≈Ø≈æe mƒõnit jen Podpora"><span>Admin</span></label>`;

      const delBtn = isSupportUser(u)
        ? `<button class="btn danger" disabled title="√öƒçet Podpora nelze smazat">Smazat</button>`
        : `<button class="btn danger" onclick="deleteUser('${u.id}')">Smazat</button>`;

      return `
        <div class="card">
          <div class="grid2">
            <input id="name_${u.id}" class="input" value="${u.name || ""}">
            <div class="row">
              <input id="${rid}" class="input" type="password" value="${pwValue}" ${pwAttrs} style="flex:1">
              ${canSeePw ? `<button class="btn" onclick="toggleInput('${rid}')">üëÅÔ∏è</button>` : ``}
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            ${roles.map(roleChk).join("")}
            ${adminChk}
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn" onclick="saveUser('${u.id}')">Ulo≈æit</button>
            ${delBtn}
          </div>
        </div>`;
    }).join("");

    app.innerHTML = `<h3>ƒålenov√©</h3>${create}${list || `<div class="card muted">≈Ω√°dn√≠ ƒçlenov√©.</div>`}`;

    const tnp = document.getElementById("toggleNewPass");
    if(tnp){ tnp.onclick = ()=> toggleInput("newPass"); }
  }catch(err){
    console.error("viewMembers() error:", err);
    alert("Chyba p≈ôi naƒç√≠t√°n√≠ ƒçlen≈Ø: " + (err?.message || err));
  }
}

function toggleInput(id){
  const i=document.getElementById(id); if(!i) return; i.type = (i.type==="password"?"text":"password");
}

function createUser(){
  refreshStores();
  const roles = loadRoles();
  const name = (document.getElementById("newName")?.value || "").trim();
  const pass = (document.getElementById("newPass")?.value || "");
const meIsSupport = !!(ME && (
  (ME.roles || []).includes("support") ||
  ((ME.name || "").trim().toLowerCase() === "podpora")
));

  if(!name || !pass){ alert("Jm√©no a heslo jsou povinn√©"); return; }

  const roleKeys = roles.map(r=>r.key);
  let selected = roleKeys.filter(k=> document.getElementById("role_"+k)?.checked );

  // Admin m≈Ø≈æe p≈ôidat jen Podpora (UI to u≈æ blokuje, tady pro jistotu)
  const wantsAdmin = !!document.getElementById("role_admin")?.checked;
  if(meIsSupport && wantsAdmin){ selected.push("admin"); }

  if(!selected.length){ alert("Vyberte alespo≈à jednu roli"); return; }

  const u = { id:uid(), name, password:pass, roles:Array.from(new Set(selected)), isActive:true, passwordChangedAt:nowIso() };
  USERS.push(u); save(DB_USERS,USERS);
  alert("ƒålen vytvo≈ôen");
  viewMembers();
}

function saveUser(uidx){
  try{
    refreshStores();

    const rolesArr = Array.isArray(loadRoles()) ? loadRoles() : [];
    const u = USERS.find(x=>x.id===uidx);
    if(!u){ alert("U≈æivatel nenalezen."); return; }

const meIsSupport = !!(ME && (
  (ME.roles || []).includes("support") ||
  ((ME.name || "").trim().toLowerCase() === "podpora")
));
    const targetIsSupport = isSupportUser(u);

    // Jm√©no + heslo (heslo m≈Ø≈æe chybƒõt v DOM, je to OK)
    const newName = (document.getElementById("name_"+u.id)?.value || "").trim();
    const pwEl    = document.getElementById("pw_"+u.id);
    const newPass = pwEl ? pwEl.value : "";

    // Seber za≈°krtnut√© role z checkbox≈Ø: ve≈ôejn√© + "admin"
    const roleKeys = rolesArr.map(r=>r.key).concat(["admin"]);
    let selected   = roleKeys.filter(k => !!document.getElementById(`edit_${u.id}_${k}`)?.checked);

    // --- Pravidla pro admin roli ---
    if(!meIsSupport){
      // Ne-Podpora NESM√ç mƒõnit admin
      if((u.roles||[]).includes("admin") && !selected.includes("admin")){
        selected.push("admin"); // vr√°tit zpƒõt odebran√©ho admina
      }
      if(!(u.roles||[]).includes("admin") && selected.includes("admin")){
        selected = selected.filter(r => r !== "admin"); // zru≈°it pokus o p≈ôid√°n√≠
      }
    }else{
      // Podpora SM√ç admin mƒõnit; ale √∫ƒçet Podpora je nedotknuteln√Ω: v≈ædy support+admin
      if(targetIsSupport){
        if(!selected.includes("support")) selected.push("support");
        if(!selected.includes("admin"))   selected.push("admin");
      }
    }

    // Validace: u≈æivatel mus√≠ m√≠t aspo≈à jednu roli
    if(selected.length === 0){
      alert("U≈æivatel mus√≠ m√≠t alespo≈à jednu roli.");
      return;
    }

    // Ulo≈æ jm√©no
    u.name = newName || u.name;

    // Heslo: mƒõnit sm√≠ Podpora, nebo kdokoli u c√≠le, kter√Ω nen√≠ Podpora
    if(meIsSupport || !targetIsSupport){
      if(newPass && newPass !== u.password){
        u.password = newPass;
        u.passwordChangedAt = nowIso();
      }
    }

    // Ulo≈æ role
    u.roles = selected;
    save(DB_USERS, USERS);

    // Pokud si nƒõkdo editoval s√°m sebe, obnov session a aktivn√≠ roli
    if(ME && ME.id===u.id){
      ME = u; setSession(ME.id); ensureActiveRole();
    }

    alert("Ulo≈æeno");
    viewMembers();
  }catch(err){
    console.error("saveUser() error:", err);
    alert("Chyba p≈ôi ukl√°d√°n√≠ u≈æivatele: " + (err?.message || err));
  }
}

function deleteUser(uidx){
  if(ME && ME.id===uidx){ alert("Nelze smazat s√°m sebe."); return; }
  refreshStores();
  const u = getUserById(uidx);
  if(!u) return;

  // Z√°kaz maz√°n√≠ Podpory
  if(isSupportUser(u)){
    alert("U≈æivatel Podpora nem≈Ø≈æe b√Ωt smaz√°n.");
    return;
  }

  // Z√°kaz maz√°n√≠ admina (bez ohledu na to, kdo ma≈æe)
  if((u.roles||[]).includes("admin")){
    alert("U≈æivatel s rol√≠ Admin nem≈Ø≈æe b√Ωt smaz√°n.");
    return;
  }

  if(!confirm("Opravdu smazat ƒçlena?")) return;

  USERS = USERS.filter(x=>x.id!==uidx); 
  save(DB_USERS,USERS);

  // odstranit z p≈ôihl√°≈°ek ve v≈°ech ud√°lostech
  const pubRoles = getPublicRoleKeys();
  ACTIONS.forEach(a=> pubRoles.forEach(r=>{
    a.signups[r] = (a.signups[r]||[]).filter(id=>id!==uidx);
  }));
  save(DB_ACTIONS,ACTIONS);

  viewMembers();
}
// ====== /Members (admin) ======


// ====== Roles management (admin) ======
const RESERVED_ROLE_KEYS = ["admin","support"];

function viewRoles(){
  try{
    refreshStores();
    const app = document.getElementById("app");
    const roles = Array.isArray(loadRoles()) ? loadRoles() : [];

    const addForm = `
      <div class="card">
        <h4>P≈ôidat novou roli</h4>
        <div class="grid2">
          <label>Kl√≠ƒç (bez diakritiky):
            <input id="roleKey" class="input" placeholder="nap≈ô. koordinator">
          </label>
          <label>N√°zev (zobrazen√Ω):
            <input id="roleLabel" class="input" placeholder="Koordin√°tor">
          </label>
        </div>
        <label class="row" style="margin-top:6px">
          <input id="rolePublic" type="checkbox" checked> Ve≈ôejn√° role
        </label>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn primary" onclick="createRole()">P≈ôidat roli</button>
        </div>
      </div>`;

    const list = roles.map(r=>{
      const isReserved = RESERVED_ROLE_KEYS.includes(r.key);
      return `
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="row" style="gap:12px">
              <span class="key">${r.key}</span>
              <input id="label_${r.key}" class="input" value="${r.label}" style="min-width:220px" ${isReserved?'disabled':''}>
              <label class="row">
                <input type="checkbox" id="pub_${r.key}" ${r.isPublic?"checked":""} ${isReserved?'disabled':''}>
                Ve≈ôejn√°
              </label>
            </div>
            <div class="row">
              <button class="btn" onclick="saveRole('${r.key}')" ${isReserved?'disabled title="Tuto roli nelze upravit"':''}>Ulo≈æit</button>
              <button class="btn danger" onclick="deleteRole('${r.key}')" ${isReserved?'disabled title="Tuto roli nelze smazat"':''}>Smazat</button>
            </div>
          </div>
        </div>`;
    }).join("");

    app.innerHTML = `<h3>Role</h3>${addForm}${list || `<div class="card muted">≈Ω√°dn√© role.</div>`}`;
  }catch(err){
    console.error("viewRoles error:", err);
    alert("Chyba p≈ôi naƒç√≠t√°n√≠ rol√≠: " + (err?.message || err));
  }
}

function createRole(){
  try{
    refreshStores();
    let key   = slugify(document.getElementById("roleKey")?.value || "");
    const label   = (document.getElementById("roleLabel")?.value || "").trim();
    const isPublic= !!document.getElementById("rolePublic")?.checked;

    if(!key || !label){ alert("Vypl≈àte kl√≠ƒç i n√°zev role."); return; }
    if(RESERVED_ROLE_KEYS.includes(key)){ alert(`Kl√≠ƒç '${key}' je vyhrazen.`); return; }

    const roles = loadRoles();
    if(roles.some(r=>r.key===key)){ alert("Tento kl√≠ƒç role u≈æ existuje."); return; }

    roles.push({ key, label, isPublic });
    saveRoles(roles);

    // doplnit do v≈°ech ud√°lost√≠ kapacity a signups
    const acts = load(DB_ACTIONS) || [];
    acts.forEach(a=>{
      a.capacity ||= {};
      a.signups  ||= {};
      a.capacity[key] = 0;
      a.signups[key]  = [];
    });
    save(DB_ACTIONS, acts);

    toast("Role p≈ôid√°na", label);
    viewRoles();
  }catch(err){
    console.error("createRole error:", err);
    alert("Chyba p≈ôi p≈ôid√°n√≠ role: " + (err?.message || err));
  }
}

function saveRole(key){
  try{
    refreshStores();
    const roles = loadRoles();
    const r = roles.find(x=>x.key===key);
    if(!r) return;

    if(RESERVED_ROLE_KEYS.includes(key)){
      alert("Tuto roli nelze upravit.");
      viewRoles();
      return;
    }

    r.label   = (document.getElementById("label_"+key)?.value || r.label).trim();
    r.isPublic= !!document.getElementById("pub_"+key)?.checked;
    saveRoles(roles);

    // synchronizace ud√°lost√≠ podle aktu√°ln√≠ch public rol√≠
    const pubs = getPublicRoleKeys();
    const acts = load(DB_ACTIONS) || [];
    acts.forEach(a=>{
      a.capacity ||= {};
      a.signups  ||= {};
      pubs.forEach(k=>{ if(!(k in a.capacity)) a.capacity[k]=0; if(!(k in a.signups)) a.signups[k]=[]; });
      Object.keys(a.capacity).forEach(k=>{ if(!pubs.includes(k)) delete a.capacity[k]; });
      Object.keys(a.signups).forEach(k=>{ if(!pubs.includes(k)) delete a.signups[k]; });
    });
    save(DB_ACTIONS, acts);

    toast("Role upravena", r.label);
    viewRoles();
  }catch(err){
    console.error("saveRole error:", err);
    alert("Chyba p≈ôi ukl√°d√°n√≠ role: " + (err?.message || err));
  }
}

function deleteRole(key){
  try{
    if(RESERVED_ROLE_KEYS.includes(key)){
      alert("Tuto roli nelze smazat.");
      return;
    }
    if(!confirm("Opravdu smazat roli? Bude odebr√°na i z u≈æivatel≈Ø a ud√°lost√≠.")) return;

    refreshStores();

    // odeber z role listu
    const roles = loadRoles().filter(r=>r.key!==key);
    saveRoles(roles);

    // odeber z u≈æivatel≈Ø
    USERS.forEach(u=>{
      u.roles = (u.roles || []).filter(k=>k!==key);
    });
    save(DB_USERS, USERS);

    // odeber z ud√°lost√≠
    const acts = load(DB_ACTIONS) || [];
    acts.forEach(a=>{
      if(a.capacity) delete a.capacity[key];
      if(a.signups)  delete a.signups[key];
    });
    save(DB_ACTIONS, acts);

    if(ACTIVE_ROLE===key){ ACTIVE_ROLE=null; ensureActiveRole(); }

    toast("Role smaz√°na", key);
    viewRoles();
    renderHeader();
  }catch(err){
    console.error("deleteRole error:", err);
    alert("Chyba p≈ôi maz√°n√≠ role: " + (err?.message || err));
  }
}
// ====== /Roles management (admin) ======


// ====== Activity page (admin) ======
function viewActivity(){
  refreshStores();
  const app = document.getElementById("app");
  const list = loadAct();
  const rows = list.slice().reverse().map(x=>{
    const who = x.userName || (getUserById(x.userId)?.name) || "u≈æivatel";
    const ev  = x.eventTitle || (ACTIONS.find(a=>a.id===x.eventId)?.title) || "ud√°lost";
    const role= x.roleKey ? ` (${roleLabel(x.roleKey)})` : "";
    const date = new Date(x.ts).toLocaleString();
    const typeMap = {join:"P≈ôihl√°≈°en√≠",leave:"Odhl√°≈°en√≠",assign:"P≈ôi≈ôazen√≠",remove:"Odebr√°n√≠",createEvent:"Vytvo≈ôen√≠",updateEvent:"√öprava",deleteEvent:"Smaz√°n√≠"};
    return `<tr><td>${date}</td><td>${typeMap[x.type]||x.type}</td><td>${who}</td><td>${ev}${role}</td></tr>`;
  }).join("");
  app.innerHTML = `
    <h3>Aktivita</h3>
    <div class="card" style="overflow:auto">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">ƒåas</th>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">Typ</th>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">Kdo</th>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">Detail</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="4" class="muted" style="padding:8px">≈Ω√°dn√© z√°znamy.</td></tr>`}</tbody>
      </table>
    </div>`;
}

// ====== Logout ======
function logout(){
  if(adminWatchTimer){ clearInterval(adminWatchTimer); adminWatchTimer=null; }
  setSession(null);
  ME = null;
  ACTIVE_ROLE = null;
  renderHeader();
  viewLogin();
}

// ====== Init ======
(async function init(){
  await bootSync();
  const sid = getSession();
  if(sid){ ME = getUserById(sid); }
  archiveSweep();
  if(!ME){
    renderHeader();
    viewLogin();
  }else{
    ensureActiveRole();
    renderHeader();
    startAdminWatcher();
    viewEvents();
  }
})();

// ====== Re-render app ======
function renderApp(){
  renderHeader();
  viewEvents();
}
</script>
</body>
</html>


<script>
// Ensure our load/save override wins even if original redefines later
if (typeof window.load !== "function") {
  window.load = (k)=>{ try{return JSON.parse(localStorage.getItem(k)||"[]")}catch(e){return []} };
}
if (typeof window.save !== "function") {
  window.save = (k,v)=>{ try{localStorage.setItem(k, JSON.stringify(v));}catch(e){}; kvUpsert(k,v); };
}
</script>
