<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smƒõn√°≈ô ‚Äì cloud verze (Supabase)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0f14; --panel:#111720; --muted:#9aa4b2; --text:#e8eef7; --accent:#7cacf8; --ok:#2ecc71; --err:#e74c3c; --warn:#f39c12;
      --card:#0e141d; --line:#1c2430; --chip:#162132; --chip2:#1b2a3f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial; color:var(--text); background:radial-gradient(1200px 600px at 10% -10%, #123, transparent), var(--bg);} 
    a{color:var(--accent)}
    .wrap{max-width:1100px; margin:0 auto; padding:20px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 16px; background:rgba(17,23,32,.6); backdrop-filter: blur(8px); border:1px solid var(--line); border-radius:16px; position:sticky; top:10px; z-index:5}
    header h1{font-size:16px; margin:0; font-weight:600}
    .row{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    .muted{color:var(--muted)}
    .btn{appearance:none; border:1px solid var(--line); background:linear-gradient(180deg, #162131, #0f1a2a); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.pri{background:linear-gradient(180deg, #2a3f62, #1c2b45); border-color:#2a3f62}
    .btn.warn{background:#41270d; border-color:#704113}
    .btn.ghost{background:transparent}
    input, select, textarea{background:#0c1421; border:1px solid #1f2a3a; color:var(--text); padding:8px 10px; border-radius:10px; outline:none}
    textarea{min-height:88px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px}
    .cards{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .span12{grid-column:span 12}
    .span6{grid-column:span 6}
    .span4{grid-column:span 4}
    .span3{grid-column:span 3}
    @media (max-width:900px){.span6,.span4,.span3{grid-column:span 12}}
    .tag{display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid var(--line); color:#cdd7e5; border-radius:999px; padding:4px 8px; font-size:12px}
    .tag.ok{background:#0f2a1b; border-color:#1b5b3a; color:#cfeedd}
    .tag.err{background:#2a0f12; border-color:#70333a; color:#ffd6d6}
    .tag.warn{background:#2a2210; border-color:#6b5a11}
    .list{display:flex; flex-direction:column; gap:10px}
    .hl{border-top:1px dashed var(--line); margin:10px 0}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 10px; border-bottom:1px solid var(--line); text-align:left}
    .kpi{display:flex; gap:8px; align-items:center}
    .kpi b{font-size:18px}
    .pill{display:flex; gap:8px; flex-wrap:wrap}

    /* debug footer */
    #dbbar{position:fixed; bottom:12px; right:12px; background:rgba(14,20,29,.95); border:1px solid var(--line); border-radius:12px; padding:8px 10px; display:flex; align-items:center; gap:10px; z-index:10}
    #dbdot{width:10px; height:10px; border-radius:50%; background:#666}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row">
        <h1>üóìÔ∏è Smƒõn√°≈ô</h1>
        <span class="tag" id="roleTag">role: <span id="roleLabel">‚Äî</span></span>
        <span class="tag" id="userTag">u≈æivatel: <span id="userLabel">‚Äî</span></span>
      </div>
      <div class="row">
        <button class="btn" id="btnLogin">P≈ôihl√°sit</button>
        <button class="btn ghost" id="btnLogout" style="display:none">Odhl√°sit</button>
        <button class="btn pri" id="btnNewEvent" style="display:none">+ Nov√° akce</button>
        <button class="btn" id="btnExport">üì§ Export</button>
        <button class="btn" id="btnImport">üì• Import</button>
      </div>
    </header>

    <div class="cards" style="margin-top:16px">
      <section class="card span6" id="loginCard" style="display:none"></section>
      <section class="card span6" id="adminCard" style="display:none"></section>

      <section class="card span12" id="eventsUpcoming">
        <h3 style="margin-top:0">Nadch√°zej√≠c√≠ akce</h3>
        <div id="upcomingList" class="list"></div>
      </section>
      <section class="card span12" id="eventsPast">
        <h3 style="margin-top:0">Probƒõhl√© akce</h3>
        <div id="pastList" class="list"></div>
      </section>

      <section class="card span6" id="rolesCard">
        <h3 style="margin-top:0">Role</h3>
        <div class="pill" id="roleChips"></div>
        <div class="hl"></div>
        <div class="row">
          <input id="roleInput" placeholder="Nov√° role (nap≈ô. ≈òidiƒç)" />
          <button class="btn" id="addRoleBtn">P≈ôidat roli</button>
        </div>
      </section>

      <section class="card span6" id="activityCard">
        <h3 style="margin-top:0">Aktivita</h3>
        <div id="activityList" class="list"></div>
      </section>
    </div>
  </div>

  <div id="dbbar" class="small">
    <div id="dbdot"></div>
    <div id="dbmsg">Checking DB‚Ä¶</div>
    <button class="btn" id="dbtest">DB test</button>
  </div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />

<script>
// ====== Supabase config (TV√â KL√çƒåE) ======
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcHlhdndoenB2ZGJ4ZGlkZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDQxNzYsImV4cCI6MjA3MjQyMDE3Nn0.baWqIwQrlz8KJ6CfOt7-md7FZvBDSXagFXNpHy_eOH4";
let sb = null;
try{ sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }catch(e){ console.warn("Supabase init failed", e); }

// ====== Kl√≠ƒçe v KV (Supabase + localStorage) ======
const DB_USERS    = 'smenar.users';
const DB_ROLES    = 'smenar.roles';
const DB_ACTIONS  = 'smenar.actions';
const DB_ACTIVITY = 'smenar.activity';
const DB_ARCHIVE  = 'smenar.actions.archive';
const SYNC_KEYS = [DB_USERS, DB_ROLES, DB_ACTIONS, DB_ACTIVITY, DB_ARCHIVE];

// ====== Pomocn√© ======
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
const todayISO = () => new Date().toISOString();
const toDate = (s) => new Date(s);
const fmtDate = (s) => new Date(s).toLocaleString('cs-CZ', { dateStyle:'short', timeStyle:'short' });
const now = () => new Date();

function setDot(ok, msg){
  const dot = $('#dbdot'); const m = $('#dbmsg');
  dot.style.background = ok? 'var(--ok)' : 'var(--err)';
  if(msg) m.textContent = msg;
}

// ====== KV helpery ======
async function kvGet(key){
  if(!sb) return null;
  const { data, error } = await sb.from('kv').select('val').eq('key', key).single();
  if(error && error.code !== 'PGRST116'){ console.error('kvGet error', key, error); }
  return data?.val ?? null;
}
async function kvUpsert(key, val){
  if(!sb) return;
  const { error } = await sb.from('kv').upsert({ key, val });
  if(error){ console.error('kvUpsert error', key, error); }
}
async function bootSync(){
  if(!sb) return;
  const { data, error } = await sb.from('kv').select('key,val').in('key', SYNC_KEYS);
  if(error){ console.warn('bootSync error', error); return; }
  (data||[]).forEach(r=>localStorage.setItem(r.key, JSON.stringify(r.val ?? [])));
}
async function safeBootSync(timeoutMs=3000){
  try{
    await Promise.race([
      bootSync(),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), timeoutMs))
    ]);
  }catch(e){ console.warn('safeBootSync', e.message); }
}

// ====== Local API (sync) ======
const _loadLocal = k => { try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(e){return []} };
const _saveLocal = (k,v) => { try{localStorage.setItem(k, JSON.stringify(v));}catch(e){} };
function load(k){ return _loadLocal(k); }
function save(k,v){ _saveLocal(k,v); kvUpsert(k,v); }

// ====== Stav ======
let USERS=[], ROLES=[], ACTIONS=[], ACTIVITY=[], ARCHIVE=[];
let ME=null; // p≈ôihl√°≈°en√Ω u≈æivatel {id,name,isAdmin,roles:[]}
let CURRENT_ROLE = null;

function getSession(){ try{return JSON.parse(localStorage.getItem('smenar.session')||'null')}catch(_){return null} }
function setSession(id){ localStorage.setItem('smenar.session', JSON.stringify(id)); }

// ====== Login & u≈æivatel√© ======
function ensureRoleSelected(){
  if(ME && (!CURRENT_ROLE || !ME.roles.includes(CURRENT_ROLE))){ CURRENT_ROLE = ME.roles[0] || null; }
  $('#roleLabel').textContent = CURRENT_ROLE || '‚Äî';
  $('#userLabel').textContent = ME? ME.name : '‚Äî';
  $('#userTag').style.display = ME? '' : 'none';
  $('#roleTag').style.display = ME? '' : 'none';
}

function renderLogin(){
  const card = $('#loginCard'); card.style.display='block';
  const opts = USERS.map(u=>`<option value="${u.id}">${u.name}${u.isAdmin?' ‚Ä¢ admin':''}</option>`).join('');
  card.innerHTML = `
    <h3 style="margin-top:0">P≈ôihl√°≈°en√≠</h3>
    <div class="row">
      <select id="loginSelect"><option value="">‚Äî vyber ‚Äî</option>${opts}</select>
      <button class="btn pri" id="doLogin">P≈ôihl√°sit</button>
    </div>
    <div class="hl"></div>
    <h4>Nov√Ω u≈æivatel</h4>
    <div class="row">
      <input id="newUserName" placeholder="Jm√©no" />
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="newUserAdmin"/> admin</label>
      <button class="btn" id="createUser">Vytvo≈ôit</button>
    </div>
  `;
  $('#doLogin').onclick = ()=>{
    const id = $('#loginSelect').value; if(!id) return;
    ME = USERS.find(u=>u.id===id)||null; setSession(ME?.id||null); ensureRoleSelected(); paintHeader(); hideLogin(); renderAll(); act(`${ME.name} se p≈ôihl√°sil`);
  };
  $('#createUser').onclick = ()=>{
    const name = $('#newUserName').value.trim(); if(!name) return;
    const u = { id:uid(), name, isAdmin:$('#newUserAdmin').checked, roles:[] };
    USERS.push(u); save(DB_USERS, USERS); renderLogin(); renderUsersRoles();
  };
}
function hideLogin(){ $('#loginCard').style.display='none'; }

function paintHeader(){
  $('#btnLogin').style.display = ME? 'none' : '';
  $('#btnLogout').style.display = ME? '' : 'none';
  $('#btnNewEvent').style.display = (ME&&ME.isAdmin)? '' : 'none';
  ensureRoleSelected();
}

// ====== Role ======
function renderUsersRoles(){
  // role list chips
  const chips = $('#roleChips'); chips.innerHTML='';
  ROLES.forEach(r=>{
    const el = document.createElement('span'); el.className='tag'; el.textContent=r; chips.appendChild(el);
  });
}
$('#addRoleBtn').onclick = ()=>{
  const v = $('#roleInput').value.trim(); if(!v) return; if(ROLES.includes(v)) return;
  ROLES.push(v); save(DB_ROLES, ROLES); $('#roleInput').value=''; renderUsersRoles(); act(`P≈ôid√°na role: ${v}`);
};

// ====== Aktivita ======
function act(msg){ ACTIVITY.unshift({ ts: todayISO(), user: ME?ME.name:'‚Äî', msg }); save(DB_ACTIVITY, ACTIVITY); renderActivity(); }
function renderActivity(){ const box=$('#activityList'); box.innerHTML = ACTIVITY.slice(0,50).map(a=>`<div class="row"><span class="muted">${fmtDate(a.ts)}</span> <div>${a.user} ‚Äî ${a.msg}</div></div>`).join(''); }

// ====== Akce ======
function isPast(ev){ const end = toDate(ev.dateTo||ev.dateFrom||ev.date); return end < now(); }
function canSignup(ev){ if(!ev.signupOpenAt) return true; return now() >= toDate(ev.signupOpenAt); }
function renderEvents(){
  const up = ACTIONS.filter(a=>!isPast(a));
  const past = ACTIONS.filter(a=>isPast(a));
  const render = (ev)=>{
    const capTxt = ev.capacity? `<span class="tag">kapacita ${ev.attendees.length}/${ev.capacity}</span>` : '';
    const openTxt = ev.signupOpenAt? `<span class="tag ${canSignup(ev)?'ok':'warn'}">p≈ôihl√°≈°en√≠ ${canSignup(ev)?'otev≈ôeno':'od '+fmtDate(ev.signupOpenAt)}</span>` : '';
    const meIn = ME && ev.attendees.includes(ME.id);
    return `<div class="card"> 
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:10px">
          <b>${ev.title}</b>
          <span class="tag">${fmtDate(ev.dateFrom)} ‚Üí ${fmtDate(ev.dateTo||ev.dateFrom)}</span>
          ${capTxt} ${openTxt}
        </div>
        <div class="row">
          ${ME? `<button class="btn" data-join="${ev.id}" ${(!canSignup(ev) || (ev.capacity && ev.attendees.length>=ev.capacity) || meIn)?'disabled':''}>P≈ôihl√°sit</button>`:''}
          ${ME? `<button class="btn" data-leave="${ev.id}" ${meIn?'':'disabled'}>Odhl√°sit</button>`:''}
          ${ME&&ME.isAdmin? `<button class="btn" data-edit="${ev.id}">Upravit</button>`:''}
        </div>
      </div>
      <div class="muted" style="margin-top:6px">${ev.note||''}</div>
      <div class="muted" style="margin-top:6px">P≈ôihl√°≈°eni: ${(ev.attendees.map(id=>USERS.find(u=>u.id===id)?.name||'??').join(', '))||'‚Äî'}</div>
    </div>`;
  };
  $('#upcomingList').innerHTML = up.map(render).join('') || '<div class="muted">≈Ω√°dn√© nadch√°zej√≠c√≠ akce</div>';
  $('#pastList').innerHTML = past.map(render).join('') || '<div class="muted">≈Ω√°dn√© probƒõhl√© akce</div>';

  // wire buttons
  $$('#upcomingList [data-join], #pastList [data-join]').forEach(b=>b.onclick=()=>joinEvent(b.dataset.join));
  $$('#upcomingList [data-leave], #pastList [data-leave]').forEach(b=>b.onclick=()=>leaveEvent(b.dataset.leave));
  $$('#upcomingList [data-edit], #pastList [data-edit]').forEach(b=>b.onclick=()=>editEvent(b.dataset.edit));
}

function joinEvent(id){ if(!ME) return; const ev=ACTIONS.find(x=>x.id===id); if(!ev) return;
  if(ev.capacity && ev.attendees.length>=ev.capacity){ alert('Kapacita pln√°'); return; }
  if(ev.attendees.includes(ME.id)) return;
  ev.attendees.push(ME.id); save(DB_ACTIONS, ACTIONS); renderEvents(); act(`${ME.name} se p≈ôihl√°sil na ${ev.title}`);
}
function leaveEvent(id){ if(!ME) return; const ev=ACTIONS.find(x=>x.id===id); if(!ev) return;
  ev.attendees = ev.attendees.filter(x=>x!==ME.id); save(DB_ACTIONS, ACTIONS); renderEvents(); act(`${ME.name} se odhl√°sil z ${ev.title}`);
}

function newEvent(){ editEvent(null); }
function editEvent(id){
  const isNew = !id; const ev = isNew? { id:uid(), title:'', dateFrom:todayISO(), dateTo:todayISO(), signupOpenAt:'', capacity:'', note:'', attendees:[] } : (ACTIONS.find(x=>x.id===id));
  const dlg = document.createElement('div');
  dlg.className='card'; dlg.style.position='fixed'; dlg.style.top='50%'; dlg.style.left='50%'; dlg.style.transform='translate(-50%,-50%)'; dlg.style.zIndex='20'; dlg.style.minWidth='min(680px, 96vw)';
  dlg.innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center">
      <h3 style="margin:0">${isNew?'+ Nov√° akce':'Upravit akci'}</h3>
      <button class="btn" id="x">‚úñ</button>
    </div>
    <div class="row" style="margin-top:8px; flex-wrap:wrap">
      <label style="flex:1 1 260px">N√°zev<br><input id="fTitle" value="${ev.title}" /></label>
      <label style="flex:1 1 260px">Od (datum/ƒças)<br><input type="datetime-local" id="fFrom" value="${toLocalDT(ev.dateFrom)}"/></label>
      <label style="flex:1 1 260px">Do (datum/ƒças)<br><input type="datetime-local" id="fTo" value="${toLocalDT(ev.dateTo)}"/></label>
      <label style="flex:1 1 260px">P≈ôihla≈°ov√°n√≠ od<br><input type="datetime-local" id="fOpen" value="${toLocalDT(ev.signupOpenAt)}"/></label>
      <label style="flex:1 1 160px">Kapacita<br><input type="number" id="fCap" min="0" step="1" value="${ev.capacity||''}"/></label>
    </div>
    <div style="margin-top:8px">
      <label>Pozn√°mka<br><textarea id="fNote">${ev.note||''}</textarea></label>
    </div>
    <div class="row" style="justify-content:flex-end; margin-top:12px">
      ${!isNew? `<button class="btn warn" id="del">Smazat</button>`:''}
      <button class="btn pri" id="ok">Ulo≈æit</button>
    </div>
  `;
  document.body.appendChild(dlg);
  $('#x').onclick = ()=>dlg.remove();
  $('#del') && ($('#del').onclick = ()=>{ if(confirm('Smazat akci?')){ ACTIONS = ACTIONS.filter(x=>x.id!==ev.id); save(DB_ACTIONS, ACTIONS); dlg.remove(); renderEvents(); act(`Smaz√°na akce ${ev.title}`); } });
  $('#ok').onclick = ()=>{
    ev.title = $('#fTitle').value.trim();
    ev.dateFrom = toISO($('#fFrom').value);
    ev.dateTo   = toISO($('#fTo').value);
    ev.signupOpenAt = toISO($('#fOpen').value);
    ev.capacity = Number($('#fCap').value||0)||null;
    ev.note = $('#fNote').value.trim();
    if(isNew) ACTIONS.push(ev);
    save(DB_ACTIONS, ACTIONS); dlg.remove(); renderEvents(); act(`${isNew?'Vytvo≈ôena akce':'Upravena akce'} ${ev.title}`);
  };
}
function toLocalDT(iso){ if(!iso) return ''; const d=new Date(iso); const tzOff = d.getTimezoneOffset(); const d2 = new Date(d.getTime()-tzOff*60000); return d2.toISOString().slice(0,16); }
function toISO(localDT){ if(!localDT) return ''; const d=new Date(localDT); const tzOff = d.getTimezoneOffset(); const d2 = new Date(d.getTime()+tzOff*60000); return d2.toISOString(); }

// ====== Export / Import ======
$('#btnExport').onclick = ()=>{
  const payload = { USERS, ROLES, ACTIONS, ACTIVITY, ARCHIVE, exportedAt: todayISO() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'smenar_export.json'; a.click();
};
$('#btnImport').onclick = ()=>{ $('#importFile').click(); };
$('#importFile').onchange = async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const txt = await file.text();
  try{ const d = JSON.parse(txt);
    USERS = d.USERS||USERS; ROLES = d.ROLES||ROLES; ACTIONS = d.ACTIONS||ACTIONS; ACTIVITY = d.ACTIVITY||ACTIVITY; ARCHIVE = d.ARCHIVE||ARCHIVE;
    save(DB_USERS, USERS); save(DB_ROLES, ROLES); save(DB_ACTIONS, ACTIONS); save(DB_ACTIVITY, ACTIVITY); save(DB_ARCHIVE, ARCHIVE);
    renderAll(); alert('Import hotov');
  }catch(err){ alert('Import selhal: ' + err.message); }
};

// ====== Admin panel ======
function renderAdmin(){
  const box = $('#adminCard');
  if(!ME || !ME.isAdmin){ box.style.display='none'; return; }
  box.style.display='block';
  const usersHtml = USERS.map(u=>`<tr>
    <td>${u.name}</td>
    <td>${u.isAdmin? 'admin':'‚Äî'}</td>
    <td>${(u.roles||[]).join(', ')||'‚Äî'}</td>
    <td>
      <button class="btn" data-roles="${u.id}">Role</button>
      <button class="btn warn" data-deluser="${u.id}">Smazat</button>
    </td>
  </tr>`).join('');
  box.innerHTML = `
    <h3 style="margin-top:0">Admin</h3>
    <div class="row kpi"><b>${USERS.length}</b><span class="muted">u≈æivatel≈Ø</span></div>
    <div class="row" style="justify-content:space-between; margin:8px 0">
      <div class="row">
        <button class="btn pri" id="adminNewEvent">+ Nov√° akce</button>
      </div>
    </div>
    <div class="hl"></div>
    <h4>U≈æivatel√©</h4>
    <table><thead><tr><th>Jm√©no</th><th>Admin</th><th>Role</th><th></th></tr></thead><tbody>${usersHtml}</tbody></table>
  `;
  $('#adminNewEvent').onclick = ()=>newEvent();
  $$('#adminCard [data-roles]').forEach(b=>b.onclick=()=>editUserRoles(b.dataset.roles));
  $$('#adminCard [data-deluser]').forEach(b=>b.onclick=()=>delUser(b.dataset.deluser));
}
function delUser(id){ if(!confirm('Smazat u≈æivatele?')) return; USERS = USERS.filter(u=>u.id!==id); save(DB_USERS, USERS); renderAll(); }
function editUserRoles(id){
  const u = USERS.find(x=>x.id===id); if(!u) return;
  const dlg = document.createElement('div'); dlg.className='card'; dlg.style.position='fixed'; dlg.style.top='50%'; dlg.style.left='50%'; dlg.style.transform='translate(-50%,-50%)'; dlg.style.zIndex='20'; dlg.style.minWidth='min(520px,96vw)';
  const boxes = ROLES.map(r=>{
    const chk = (u.roles||[]).includes(r)?'checked':'';
    return `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" value="${r}" ${chk}/> ${r}</label>`;
  }).join('');
  dlg.innerHTML = `
    <div class="row" style="justify-content:space-between; align-items:center">
      <h3 style="margin:0">Role: ${u.name}</h3>
      <button class="btn" id="x">‚úñ</button>
    </div>
    <div class="list" style="margin-top:8px">${boxes || '<div class="muted">≈Ω√°dn√© role ‚Äì p≈ôidej je vlevo v panelu Role</div>'}</div>
    <div class="row" style="justify-content:flex-end; margin-top:12px"><button class="btn pri" id="ok">Ulo≈æit</button></div>
  `;
  document.body.appendChild(dlg);
  $('#x').onclick = ()=>dlg.remove();
  $('#ok').onclick = ()=>{
    const sel = Array.from(dlg.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
    u.roles = sel; save(DB_USERS, USERS); dlg.remove(); renderAll(); act(`Upraveny role: ${u.name}`);
  };
}

// ====== Render ALL ======
function renderAll(){ paintHeader(); renderUsersRoles(); renderAdmin(); renderEvents(); renderActivity(); }

// ====== Wire header buttons ======
$('#btnLogin').onclick = ()=>renderLogin();
$('#btnLogout').onclick = ()=>{ ME=null; setSession(null); paintHeader(); renderAll(); };
$('#btnNewEvent').onclick = ()=>newEvent();

// ====== Debug bar ======
$('#dbtest').onclick = async ()=>{
  try{ await kvUpsert('smenar.debug.heartbeat', {t:todayISO()}); const val = await kvGet('smenar.debug.heartbeat'); alert('DB test: '+ JSON.stringify(val)); }catch(e){ alert('DB test fail: '+e.message); }
};

// ====== INIT ======
(async function init(){
  try{
    setDot(false,'Checking DB‚Ä¶');
    await safeBootSync();
    // po syncu naƒçti data do pamƒõti
    USERS = load(DB_USERS); ROLES = load(DB_ROLES); ACTIONS = load(DB_ACTIONS); ACTIVITY = load(DB_ACTIVITY); ARCHIVE = load(DB_ARCHIVE);

    // auto seed (kdy≈æ nic nen√≠)
    if(USERS.length===0){ USERS = [
      {id:uid(), name:'Admin', isAdmin:true, roles:['≈òidiƒç','ZZA']},
      {id:uid(), name:'Tester', isAdmin:false, roles:['ZZA']},
    ]; save(DB_USERS, USERS); }
    if(ROLES.length===0){ ROLES=['≈òidiƒç','ZZA','Podpora']; save(DB_ROLES, ROLES); }
    if(ACTIONS.length===0){ ACTIONS=[
      {id:uid(), title:'Cviƒçen√≠ TCCC', dateFrom:new Date(Date.now()+86400000).toISOString(), dateTo:new Date(Date.now()+90000000).toISOString(), signupOpenAt:'', capacity:6, note:'Praktick√© drilly', attendees:[]}
    ]; save(DB_ACTIONS, ACTIONS); }

    const sid = getSession();
    if(sid) ME = USERS.find(u=>u.id===sid)||null;

    // ping DB bar
    if(sb){
      try{ const { error } = await sb.from('kv').select('key').limit(1); setDot(!error, error? 'DB error' : 'DB connected'); }catch(e){ setDot(false, 'DB fail'); }
    }else setDot(false,'Client missing');

    renderAll();
  }catch(e){ console.error(e); renderAll(); }
})();
</script>
</body>
</html>
