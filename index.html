<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <title>Smƒõn√°≈ô - Medic √öst√≠ nad Labem</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .textarea{min-height:64px;resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    details summary{cursor:pointer; user-select:none; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .admin-box{border:1px dashed var(--border); border-radius:10px; padding:10px; margin-top:10px; background:#fafbff}
    .pub-box{border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}
    .db-ind{position:fixed;right:12px;bottom:12px;z-index:60;background:#111827;color:#fff;border-radius:10px;padding:8px 10px;font-size:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08)}
    .db-dot{width:8px;height:8px;border-radius:999px;background:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
    .db-dot.ok{background:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,.25)}
    .db-muted{color:#cbd5e1}
    .event-mine{border-color:#10b981 !important;box-shadow:0 8px 30px rgba(16,185,129,.25)}
    .mine-pill{background:#ecfdf5;border-color:#10b981;color:#065f46;font-weight:600}
    #err {position:fixed;left:12px;right:12px;bottom:68px;z-index:70;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;display:none}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin:2px 4px;background:#fff}
    .chip .x{border:0;background:transparent;cursor:pointer;font-weight:700}
    .small{font-size:12px}
    .paid{background:#ecfdf5;border-color:#10b981;color:#065f46}
    .prewrap{white-space:pre-wrap; word-break:break-word}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border:1px solid var(--border); padding:6px 8px; text-align:left}
    .table th{background:#f8fafc}

    /* ==== PUSH-UP MODAL - mobile friendly ==== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(15,23,42,.45);
      display:none; align-items:flex-end; z-index:80;
      height:100dvh; overflow:hidden;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      background:#fff; border-top-left-radius:14px; border-top-right-radius:14px;
      width:100%; max-width:1100px; margin:0 auto; padding:0;
      box-shadow:0 -12px 30px rgba(0,0,0,.15);
      animation:slideUp .18s ease-out;
      max-height:calc(100dvh - 12px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      touch-action:pan-y;
    }
    @keyframes slideUp{ from{ transform:translateY(30px); opacity:.8 } to{ transform:translateY(0); opacity:1 } }
    .modal-header{
      position:sticky; top:0; z-index:1;
      background:#fff; border-bottom:1px solid var(--border);
      padding:12px 16px;
    }
    .modal-body{ padding:12px 16px 16px 16px; }

    /* Jedno≈ô√°dkov√© akce v mƒõs√≠ƒçn√≠m listu */
    .event-row{
      display:grid; grid-template-columns: 90px 1fr auto; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border);
      cursor:pointer; background:#fff; transition:background .15s ease;
    }
    .event-row:hover{ background:#f8fafc; }
    .event-row.mine-row{ background:#ecfdf5; }
    .event-row.mine-row:hover{ background:#d1fae5; }
    .event-date{font-weight:600; white-space:nowrap;}
    .event-title{font-weight:600;}
    .event-meta{color:var(--muted); font-size:12px;}
    .month-header{margin-top:12px; font-weight:800; font-size:18px; padding:8px 4px;}

    /* Obsazenost per role (na ≈ô√°dku) */
    .occ-wrap{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}
    .occ-role{font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; background:#fff}
    .occ-ok{color:#6b7280}
    .occ-missing{color:#b91c1c; border-color:#fecaca; background:#fef2f2; font-weight:600}
  </style>
</head>
<body>
  <div id="dbInd" class="db-ind" title="Stav datab√°ze">
    <span id="dbDot" class="db-dot"></span>
    <span><b>DB:</b> <span id="dbState">Offline</span></span>
    <span class="db-muted">‚Ä¢</span>
    <span class="db-muted">naposledy: <span id="dbLast">‚Äî</span></span>
  </div>
  <div id="err"></div>

  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>

  <main><div id="app"></div></main>
  <div class="toast-wrap" id="toasts"></div>

  <!-- Modal pro ud√°losti -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="if(event.target.id==='modalBackdrop'){ closeEventModal(); }">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="evModalTitle">
      <div class="modal-header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="evModalTitle" style="margin:0">Ud√°lost</h3>
          <button class="btn" type="button" onclick="closeEventModal()">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="evModalContent"></div>
      </div>
    </div>
  </div>

  <!-- Modal pro kurzy -->
  <div id="modalBackdropCourse" class="modal-backdrop" onclick="if(event.target.id==='modalBackdropCourse'){ closeCourseModal(); }">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="courseModalTitle">
      <div class="modal-header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="courseModalTitle" style="margin:0">Kurz</h3>
          <button class="btn" type="button" onclick="closeCourseModal()">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="courseModalContent"></div>
      </div>
    </div>
  </div>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* ===== Supabase ===== */
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cZc‚Ä¶"; // tv≈Øj p≈Øvodn√≠ ANON kl√≠ƒç zkop√≠ruj
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Stav ===== */
const DB_USERS="users", DB_ACTIONS="actions", DB_ROLES="roles", DB_SESSION="session", DB_ACTIVITY="activity", DB_ARCHIVE="archive", DB_FORCED="forced";
const DB_COURSES="courses", DB_COURSE_ARCHIVE="course_archive";

let USERS=[], ACTIONS=[], ROLES=[], ACTIVITY=[], ARCHIVE=[], FORCED=[];
let COURSES = [], COURSE_ARCHIVE = [];

let ME=null, ACTIVE_ROLE=null;
let CURRENT_VIEW='events', CURRENT_EDIT_ID=null;
let DB_ONLINE=false, DB_LAST_TS=0, DB_LAST_SRC='‚Äî';

const $=s=>document.querySelector(s);
const today=()=>new Date().toISOString().slice(0,10);
const nowMs=()=>Date.now();
const uid=()=>crypto.randomUUID?crypto.randomUUID():('id'+Date.now()+Math.random().toString(16).slice(2));

function h(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function toast(msg,sub){ const w=$('#toasts'); const d=document.createElement('div'); d.className='toast'; d.innerHTML=`<div>${msg}</div>${sub? `<small>${sub}</small>`:''}`; w.appendChild(d); setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(8px)'; d.style.transition='all .25s'; setTimeout(()=>w.removeChild(d),260); },3000); }
function showErr(msg){ const el=document.getElementById('err'); el.textContent=String(msg); el.style.display='block'; console.error(msg); }
window.addEventListener('error', (e)=>{ showErr(e.message || 'Nezn√°m√° chyba'); });
window.addEventListener('unhandledrejection', (e)=>{ showErr(e.reason?.message || e.reason || 'Nezachycen√© odm√≠tnut√≠ Promise'); });

function fmtAgo(ts){ if(!ts) return "‚Äî"; const s=Math.max(0,Math.floor((Date.now()-ts)/1000)); if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m ${s%60}s`; const h=Math.floor(m/60); return `${h}h ${m%60}m`; }
function fmtAbs(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return "‚Äî"; } }
function renderDbInd(){ const dot=$('#dbDot'), st=$('#dbState'), last=$('#dbLast'); st.textContent=DB_ONLINE?'Online':'Offline'; dot.classList.toggle('ok', DB_ONLINE); last.textContent=`${fmtAgo(DB_LAST_TS)} (${DB_LAST_SRC})`; const wrap=$('#dbInd'); if(wrap) wrap.title=`DB: ${DB_ONLINE?'Online':'Offline'} ‚Ä¢ naposledy: ${fmtAbs(DB_LAST_TS)} (${DB_LAST_SRC})`; }
setInterval(renderDbInd,1000);

/* ===== KV helpery ===== */
async function kvLoad(key){
  const {data, error} = await supabase.from('kv').select('data').eq('key', key).single();
  if(error && error.code!=='PGRST116') throw error;
  return data?.data ?? [];
}
async function kvSave(key, value){
  const { error } = await supabase.from('kv').upsert({ key, data: value, updated_at: new Date().toISOString() });
  if(error) throw error;
  DB_ONLINE = true; DB_LAST_TS = Date.now(); DB_LAST_SRC='save';
}

/* ===== Realtime + watchdog ===== */
let _lastRealtime = Date.now();
function subscribeRealtime(){
  supabase
    .channel('kv-realtime')
    .on('postgres_changes', { event:'*', schema:'public', table:'kv',
      filter:`key=in.(${DB_USERS},${DB_ROLES},${DB_ACTIONS},${DB_ARCHIVE},${DB_ACTIVITY},${DB_FORCED},${DB_COURSES},${DB_COURSE_ARCHIVE})`}, (payload)=>{
        const row = payload.new || payload.old;
        if(!row?.key) return;
        if(CURRENT_VIEW==='create' || CURRENT_VIEW==='login' || CURRENT_VIEW==='create_course') return;
        const arr = row.data||[];
        switch(row.key){
          case DB_USERS: USERS = arr; break;
          case DB_ROLES: ROLES = arr; break;
          case DB_ACTIONS: ACTIONS = arr; break;
          case DB_ARCHIVE: ARCHIVE = arr; break;
          case DB_ACTIVITY: ACTIVITY = arr; break;
          case DB_FORCED: FORCED = arr; break;
          case DB_COURSES: COURSES = arr; break;
          case DB_COURSE_ARCHIVE: COURSE_ARCHIVE = arr; break;
        }
        DB_ONLINE=true; DB_LAST_TS=Date.now(); DB_LAST_SRC='realtime';
        _lastRealtime = Date.now();
        renderApp();
    }).subscribe(st=>{
      DB_ONLINE = (st==='SUBSCRIBED');
      DB_LAST_TS = Date.now();
      DB_LAST_SRC = 'sub';
      _lastRealtime = Date.now();
    });

  setInterval(()=>{
    const FIVE_MIN = 5 * 60 * 1000;
    if(Date.now() - _lastRealtime > FIVE_MIN && !['login','create','create_course'].includes(CURRENT_VIEW)){
      refreshFromDB().catch(()=>{});
      _lastRealtime = Date.now();
    }
  }, 60*1000);
}

const _eq = (a,b) => JSON.stringify(a) === JSON.stringify(b);
async function refreshFromDB(){
  try{
    const [u, r, a, ar, ac, fo, c, car] = await Promise.all([
      kvLoad(DB_USERS), kvLoad(DB_ROLES), kvLoad(DB_ACTIONS),
      kvLoad(DB_ARCHIVE), kvLoad(DB_ACTIVITY), kvLoad(DB_FORCED),
      kvLoad(DB_COURSES), kvLoad(DB_COURSE_ARCHIVE)
    ]);
    let changed=false;
    if(!_eq(USERS, u)){ USERS = u; changed = true; }
    if(!_eq(ROLES, r)){ ROLES = r; changed = true; }
    if(!_eq(ACTIONS, a)){ ACTIONS = a; changed = true; }
    if(!_eq(ARCHIVE, ar)){ ARCHIVE = ar; changed = true; }
    if(!_eq(ACTIVITY, ac)){ ACTIVITY = ac; changed = true; }
    if(!_eq(FORCED, fo)){ FORCED = fo; changed = true; }
    if(!_eq(COURSES, c)){ COURSES = c; changed = true; }
    if(!_eq(COURSE_ARCHIVE, car)){ COURSE_ARCHIVE = car; changed = true; }
    if(changed){
      DB_ONLINE = true;
      DB_LAST_TS = Date.now();
      DB_LAST_SRC = 'fallback';
      renderApp();
    }
  } catch(e){
    console.warn('refreshFromDB error', e);
    DB_ONLINE = false;
    DB_LAST_TS = Date.now();
    DB_LAST_SRC = 'error';
  }
}

/* ===== Seed & init ===== */
async function seedIfEmpty(){
  let changed = false;

  if(!ROLES.length){
    ROLES=[
      {key:'ridic',label:'≈òidiƒç',isPublic:true},
      {key:'zza',label:'ZZA',isPublic:true},
      {key:'zdravotnik',label:'Zdravotn√≠k',isPublic:true},
      {key:'admin',label:'Admin',isPublic:false},
      {key:'support',label:'Podpora',isPublic:false}
    ];
    await kvSave(DB_ROLES, ROLES);
    changed = true;
  }

  if(!USERS.length){
    USERS=[
      {id:'u1',name:'Podpora',password:'support',roles:['support','admin'],isActive:true},
      {id:'u2',name:'admin',password:'1111',roles:['admin'],isActive:true},
    ];
    await kvSave(DB_USERS, USERS);
    changed = true;
  }

  if(!ARCHIVE.length){ await kvSave(DB_ARCHIVE, []); changed = true; }
  if(!ACTIVITY.length){ await kvSave(DB_ACTIVITY, []); changed = true; }
  if(!FORCED.length){ await kvSave(DB_FORCED, []); changed = true; }

  // Novinky pro kurzy
  if(!COURSES.length){ await kvSave(DB_COURSES, []); changed = true; }
  if(!COURSE_ARCHIVE.length){ await kvSave(DB_COURSE_ARCHIVE, []); changed = true; }

  if(changed){
    DB_LAST_SRC='seed';
    DB_LAST_TS=Date.now();
  }
}

async function init(){
  try{
    [USERS, ROLES, ACTIONS, ARCHIVE, ACTIVITY, FORCED, COURSES, COURSE_ARCHIVE] = await Promise.all([
      kvLoad(DB_USERS), kvLoad(DB_ROLES), kvLoad(DB_ACTIONS),
      kvLoad(DB_ARCHIVE), kvLoad(DB_ACTIVITY), kvLoad(DB_FORCED),
      kvLoad(DB_COURSES), kvLoad(DB_COURSE_ARCHIVE)
    ]);
    DB_ONLINE=true;
    DB_LAST_TS=Date.now();
    DB_LAST_SRC='init';
    await seedIfEmpty();
    subscribeRealtime();
    renderApp();
    checkForcedLogout();
  } catch(e){
    showErr('Chyba p≈ôipojen√≠ k DB: ' + (e.message||e));
    DB_ONLINE=false;
    DB_LAST_TS=Date.now();
    DB_LAST_SRC='error';
  }
}

/* ===== Role / Pr√°va ===== */
function userHasRole(u,r){ return (u?.roles||[]).includes(r); }
function isSupportUser(u){ return !!u && ((u.roles||[]).includes('support') || ((u?.name||'').trim().toLowerCase()==='podpora')); }
function isPrivileged(){ return ME && (userHasRole(ME,'admin') || userHasRole(ME,'support')); }
function getPublicRoleKeys(){ return (ROLES||[]).filter(r=>r.isPublic).map(r=>r.key); }
function roleLabel(k){ return (ROLES||[]).find(r=>r.key===k)?.label||k; }
function getUserById(id){ return (USERS||[]).find(u=>u.id===id)||null; }
function userPublicRoles(u){ const pubs=getPublicRoleKeys(); return (u?.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){ if(!ME){ ACTIVE_ROLE=null; return;} const prs = userPublicRoles(ME); if(!prs.length){ ACTIVE_ROLE=null; return;} if(!ACTIVE_ROLE || !prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE = prs[0]; }
function canSeeRoleKey(key){ return !(key==='support' && !isSupportUser(ME)); }
function canSeeRoleObj(r){ return canSeeRoleKey(r?.key); }
function canSeeUser(u){ if(isSupportUser(ME)) return true; return !userHasRole(u,'support'); }

/* ===== Aktivita ===== */
async function logActivity(type, eventId, eventTitle, detail){
  ACTIVITY.push({ ts:Date.now(), type, eventId, eventTitle, detail, userId:ME?.id, userName:ME?.name });
  await kvSave(DB_ACTIVITY, ACTIVITY);
}

/* ===== Login/Logout helpery ===== */
function lastLoginTsForUser(uid){
  let ts=0;
  for(const a of ACTIVITY){ if(a.userId===uid && a.type==='login' && a.ts>ts) ts=a.ts; }
  return ts||null;
}
function lastLogoutTsForUser(uid){
  let ts=0;
  for(const a of ACTIVITY){ if(a.userId===uid && a.type==='logout' && a.ts>ts) ts=a.ts; }
  return ts||null;
}
function isUserCurrentlyLogged(uid){
  const li = lastLoginTsForUser(uid);
  const lo = lastLogoutTsForUser(uid);
  const logged = !!li && (!lo || li < lo);
  return { logged, since: logged ? li : null };
}

/* ===== Force logout klienta ===== */
let LAST_FORCED_TS = parseInt(localStorage.getItem('lastForcedTs')||'0',10);
function latestForcedFor(uid){
  const hits = (FORCED||[]).filter(f=>f && f.uid===uid);
  if(!hits.length) return 0;
  return Math.max(...hits.map(f=>parseInt(f.ts||0,10)).filter(n=>!isNaN(n)));
}
function checkForcedLogout(){
  if(!ME) return;
  const ts = latestForcedFor(ME.id);
  if(ts>LAST_FORCED_TS){
    LAST_FORCED_TS = ts;
    localStorage.setItem('lastForcedTs', String(LAST_FORCED_TS));
    alert('Byl jste odhl√°≈°en podporou.');
    logout();
  }
}
setInterval(checkForcedLogout, 3000);

/* ===== Event helpers ===== */
// (tu je v≈°echno, co jsi mƒõl pro ud√°losti ‚Äì joinEvent, leaveEvent, assignMember, removeMember, openEventModal, deleteEvent, viewCreateEvent, saveEvent, atd.)

// ===== Kurzov√© funkce =====
function courseEndMs(c){
  if(!c || !c.endDate) return 0;
  const t = new Date(c.endDate + 'T23:59:59').getTime();
  return isNaN(t) ? 0 : t;
}
function isPastCourse(c){
  return nowMs() > courseEndMs(c);
}
async function courseArchiveSweep(){
  const toMove = COURSES.filter(c => isPastCourse(c));
  if(toMove.length === 0) return;
  COURSES = COURSES.filter(c => !isPastCourse(c));
  await kvSave(DB_COURSES, COURSES);
  COURSE_ARCHIVE = [...toMove.slice().sort((a,b)=> b.endDate.localeCompare(a.endDate)), ...COURSE_ARCHIVE];
  await kvSave(DB_COURSE_ARCHIVE, COURSE_ARCHIVE);
}
function renderCourseList(source, title, opts = { monthsDesc:false }){
  const app = $('#app');
  const list = (source||[]).slice().filter(c => c.startDate);
  if(!list.length){
    app.innerHTML = `<h3>${title}</h3><div class="card muted">≈Ω√°dn√© kurzy.</div>`;
    return;
  }
  const toKeyVal = (dStr) => {
    const d = new Date(dStr+'T00:00:00');
    if(isNaN(d)) return { mk:'Nezn√°m√©', ym:0 };
    return { mk: monthKey(dStr), ym: d.getFullYear()*100 + (d.getMonth()+1) };
  };
  const groups = new Map();
  for(const c of list){
    const { mk, ym } = toKeyVal(c.startDate);
    if(!groups.has(mk)) groups.set(mk, { ym, items: [] });
    groups.get(mk).items.push(c);
  }
  const monthBlocks = Array.from(groups.entries())
    .sort(([,A],[,B]) => opts.monthsDesc ? (B.ym - A.ym) : (A.ym - B.ym));
  let out = `<h3>${title}</h3><div class="card" style="padding:0">`;
  for(const [mk, data] of monthBlocks){
    data.items.sort((a,b)=> a.startDate.localeCompare(b.startDate));
    out += `<div class="month-header">${h(mk)}</div>`;
    out += data.items.map(c=>{
      const sub = [c.location||'‚Äî', `max ${c.maxMembers} ƒçlen≈Ø`].filter(Boolean).join(' ‚Ä¢ ');
      const datePart = fmtDM(c.startDate);
      const mine = c.members && ME ? c.members.includes(ME.id) : false;
      return `
        <div class="event-row ${mine?'mine-row':''}" onclick="openCourseModal('${c.id}')">
          <div class="event-date">${datePart}</div>
          <div>
            <div class="event-title">${h(c.title)}</div>
            <div class="event-meta">${h(sub)}</div>
          </div>
          <div class="event-meta" style="text-align:right">${(c.members?c.members.length:0)}/${c.maxMembers}</div>
        </div>
      `;
    }).join('');
  }
  out += `</div>`;
  app.innerHTML = out;
}
function viewCourses(){
  CURRENT_VIEW = 'courses';
  courseArchiveSweep().catch(console.warn);
  renderCourseList(COURSES, 'Kurzy', { monthsDesc:false });
}
function viewPastCourses(){
  CURRENT_VIEW = 'past_courses';
  courseArchiveSweep().catch(console.warn);
  renderCourseList(COURSE_ARCHIVE, 'Probƒõhl√© kurzy', { monthsDesc:true });
}
function viewCreateCourse(editId = null){
  if(!isPrivileged()) return;
  CURRENT_VIEW = 'create_course';
  CURRENT_EDIT_ID = editId;
  const c = editId ? (COURSES.find(x=>x.id===editId) || COURSE_ARCHIVE.find(x=>x.id===editId)) : null;
  const start = c?.startDate || today();
  const end = c?.endDate || today();
  const title = c?.title || '';
  const location = c?.location || '';
  const max = c?.maxMembers ?? 1;
  const note = c?.notePublic || '';

  $('#app').innerHTML = `
    <h3>${editId? 'Upravit kurz' : 'Nov√Ω kurz'}</h3>
    <div class="card">
      <div class="grid2">
        <label>Zaƒç√°tek (datum)<input id="cr_start" class="input" type="date" value="${start}"></label>
        <label>Konec (datum)<input id="cr_end" class="input" type="date" value="${end}"></label>
      </div>
      <div class="grid2" style="margin-top:8px">
        <label>N√°zev<input id="cr_title" class="input" value="${title}"></label>
        <label>M√≠sto<input id="cr_loc" class="input" value="${location}"></label>
      </div>
      <div style="margin-top:8px">
        <label>Maxim√°ln√≠ poƒçet ƒçlen≈Ø<input id="cr_max" class="input" type="number" min="1" value="${max}"></label>
      </div>
      <div style="margin-top:8px">
        <label>Pozn√°mka (ve≈ôejn√°)<textarea id="cr_note" class="textarea">${h(note)}</textarea></label>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" type="button" onclick="viewCourses()">Zpƒõt</button>
        <button class="btn primary" type="button" onclick="saveCourse('${editId||''}')">${editId? 'Ulo≈æit zmƒõny' : 'Vytvo≈ôit kurz'}</button>
      </div>
    </div>
  `;
}
async function updateCourseBoth(cid, updater){
  let changed = false;
  let c = COURSES.find(x=>x.id===cid);
  if(c){
    updater(c);
    changed = true;
    await kvSave(DB_COURSES, COURSES);
  }
  let ca = COURSE_ARCHIVE.find(x=>x.id===cid);
  if(ca){
    updater(ca);
    changed = true;
    await kvSave(DB_COURSE_ARCHIVE, COURSE_ARCHIVE);
  }
  if(changed) renderApp();
}
async function saveCourse(editId){
  if(!isPrivileged()){ alert('Jen admin/podpora'); return; }
  const start = $('#cr_start').value.trim();
  const end = $('#cr_end').value.trim();
  const title = $('#cr_title').value.trim();
  const location = $('#cr_loc').value.trim();
  const max = parseInt($('#cr_max').value,10) || 0;
  const note = $('#cr_note').value.trim();

  if(!title){ alert('Vypl≈à n√°zev kurzu'); return; }
  if(!start || !end){ alert('Vypl≈à zaƒç√°tek i konec'); return; }
  if(end < start){ alert('Datum konce mus√≠ b√Ωt stejn√Ω nebo po zaƒç√°tku'); return; }

  if(editId){
    await updateCourseBoth(editId, c=>{
      c.startDate = start;
      c.endDate = end;
      c.title = title;
      c.location = location;
      c.maxMembers = max;
      c.notePublic = note;
    });
    const cobj = COURSES.find(x=>x.id===editId) || COURSE_ARCHIVE.find(x=>x.id===editId);
    toast('Kurz upraven', cobj.title);
    if(isPastCourse(cobj)){
      viewPastCourses();
    } else {
      viewCourses();
    }
  } else {
    const cnew = {
      id: uid(),
      startDate: start,
      endDate: end,
      title: title,
      location: location,
      maxMembers: max,
      members: [],
      notePublic: note
    };
    COURSES.push(cnew);
    await kvSave(DB_COURSES, COURSES);
    toast('Kurz vytvo≈ôen', cnew.title);
    viewCourses();
  }
}
function openCourseModal(cid){
  const c = COURSES.find(x=>x.id===cid) || COURSE_ARCHIVE.find(x=>x.id===cid);
  if(!c) return;

  const dateRange = `${c.startDate}${c.endDate && c.endDate !== c.startDate ? ' ‚Äí ' + c.endDate : ''}`;
  const location = c.location || '‚Äî';
  const note = c.notePublic || '‚Äî';
  const membersList = (c.members||[]).map(uid=>h(getUserById(uid)?.name || uid)).join(', ') || '<span class="muted">≈Ω√°dn√≠ ƒçlenov√©</span>';
  const memberCount = c.members ? c.members.length : 0;

  const adminSection = isPrivileged()? `
    <div class="admin-box small" style="margin-top:10px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div></div>
        <div class="row" style="gap:8px">
          <button class="btn" type="button" onclick="closeCourseModal(); viewCreateCourse('${c.id}')">Upravit</button>
          <button class="btn danger" type="button" onclick="closeCourseModal(); deleteCourse('${c.id}')">Smazat</button>
        </div>
      </div>
      <div style="margin-top:6px">
        <label>P≈ôidat ƒçlena</label>
        <div class="row" style="gap:6px; margin-top:4px">
          <select id="sel_course_member_${c.id}" class="select">
            ${(USERS.filter(u=>u.isActive && !(c.members||[]).includes(u.id)).map(u=>`<option value="${u.id}">${h(u.name)}</option>`)).join('')}
          </select>
          <button class="btn" type="button" onclick="(function(){
            const v=document.getElementById('sel_course_member_${c.id}').value;
            if(v) addCourseMember('${c.id}', v);
          })()">P≈ôidat</button>
        </div>
      </div>
    </div>
  ` : '';

  const html = `
    <div class="muted">${dateRange} ‚Ä¢ ${location}</div>
    <h4 style="margin:10px 0 6px 0">${h(c.title)}</h4>
    <div class="row" style="margin-bottom:8px">
      <div class="pub-box small"><b>Pozn√°mka</b><div class="prewrap" style="margin-top:4px">${h(note)}</div></div>
    </div>
    <div><b>ƒålenov√© (${memberCount}/${c.maxMembers})</b></div>
    <div class="small" style="margin-top:4px">${membersList}</div>
    ${adminSection}
  `;

  const mb = document.getElementById('modalBackdropCourse');
  document.getElementById('courseModalTitle').textContent = c.title;
  document.getElementById('courseModalContent').innerHTML = html;
  if(mb){
    mb.classList.add('open');
    document.body.style.overflow = 'hidden';
  }
}

function closeCourseModal(){
  const mb = document.getElementById('modalBackdropCourse');
  if(mb){
    mb.classList.remove('open');
    document.body.style.overflow = '';
  }
}

async function deleteCourse(cid){
  if(!isPrivileged()) return;
  if(!confirm('Smazat kurz?')) return;
  let removed = '';
  const idx = COURSES.findIndex(c=>c.id===cid);
  if(idx > -1){
    removed = COURSES[idx].title;
    COURSES.splice(idx,1);
    await kvSave(DB_COURSES, COURSES);
  }
  const ia = COURSE_ARCHIVE.findIndex(c=>c.id===cid);
  if(ia > -1){
    removed = removed || COURSE_ARCHIVE[ia].title;
    COURSE_ARCHIVE.splice(ia,1);
    await kvSave(DB_COURSE_ARCHIVE, COURSE_ARCHIVE);
  }
  toast('Kurz smaz√°n', removed);
  viewCourses();
}

async function addCourseMember(cid, uidMember){
  if(!isPrivileged()) return;
  const c = COURSES.find(c=>c.id===cid);
  if(!c) return;
  if(c.members.includes(uidMember)) return;
  if(c.members.length >= c.maxMembers){
    alert('Maxim√°ln√≠ poƒçet ƒçlen≈Ø dosa≈æen.');
    return;
  }
  c.members.push(uidMember);
  await kvSave(DB_COURSES, COURSES);
  toast('ƒålen p≈ôid√°n', getUserById(uidMember)?.name);
  openCourseModal(cid);
}

async function removeCourseMember(cid, uidMember){
  if(!isPrivileged()) return;
  const c = COURSES.find(c=>c.id===cid) || COURSE_ARCHIVE.find(c=>c.id===cid);
  if(!c) return;
  c.members = (c.members||[]).filter(u=>u!==uidMember);
  if(COURSES.some(x=>x.id===cid)){
    await kvSave(DB_COURSES, COURSES);
  } else {
    await kvSave(DB_COURSE_ARCHIVE, COURSE_ARCHIVE);
  }
  toast('ƒålen odebr√°n', getUserById(uidMember)?.name);
  openCourseModal(cid);
}

/* ===== Upraven√Ω renderHeader ===== */
function renderHeader(){
  const el=$('#hdr'); if(!ME){ el.innerHTML=''; return; }
  ensureActiveRole();
  const prs=userPublicRoles(ME);
  const roleSel=(ACTIVE_ROLE && prs.length)?`<select class="select" id="selActiveRole">${prs.map(r=>`<option value="${r}" ${r===ACTIVE_ROLE?'selected':''}>${roleLabel(r)}</option>`).join('')}</select>`:`<span class="muted">Bez ve≈ôejn√© role</span>`;

  const publicNav = `
    <div class="row">
      <button class="btn" type="button" onclick="viewEvents()">Ud√°losti</button>
      <button class="btn" type="button" onclick="viewPastEvents()">Probƒõhl√©</button>
      ${isPrivileged()? `<button class="btn" type="button" onclick="viewCourses()">Kurzy</button><button class="btn" type="button" onclick="viewPastCourses()">Probƒõhl√© kurzy</button>` : ''}
      <button class="btn" type="button" onclick="viewPassword()">Zmƒõna hesla</button>
    </div>`;

  el.innerHTML=`<div class="row">
      <span class="badge">${ME.name}</span>
      ${roleSel}
      ${publicNav}
      ${isPrivileged()? `
        <div class="menu" id="adminMenu">
          <button class="btn" id="adminBtn" type="button">Admin ‚ñæ</button>
          <div class="dropdown">
            <button type="button" onclick="viewEvents()">Ud√°losti</button>
            <button type="button" onclick="viewPastEvents()">Probƒõhl√© akce</button>
            <button type="button" onclick="viewMembers()">ƒålenov√©</button>
            <button type="button" onclick="viewRoles()">Role</button>
            ${isSupportUser(ME)? `<button type="button" onclick="viewLogins()">Loginy</button><button type="button" onclick="viewActivity()">Aktivita</button>` : ''}
            <button type="button" onclick="viewCreateEvent()">Nov√° ud√°lost</button>
            <button type="button" onclick="viewCreateCourse()">Nov√Ω kurz</button>
            ${isSupportUser(ME)? `<button type="button" onclick="viewExport()">Export / Z√°loha</button>` : '' }
          </div>
        </div>` : '' }
      <button class="btn" type="button" onclick="logout()">Odhl√°sit</button>
    </div>`;

  const sel = document.getElementById('selActiveRole');
  if(sel) sel.onchange = ()=>{
    ACTIVE_ROLE = sel.value;
    renderApp();
  };
  const menu = document.getElementById('adminMenu');
  if(menu){
    const btn = document.getElementById('adminBtn');
    btn.addEventListener('click', e=>{ e.stopPropagation(); menu.classList.toggle('open'); });
    document.addEventListener('click', e=>{
      if(!menu.contains(e.target)) menu.classList.remove('open');
    });
  }
}

/* ===== Upraven√Ω renderApp ===== */
function renderApp(){
  try{
    renderHeader();
    if(!ME){
      const sid = localStorage.getItem(DB_SESSION);
      if(sid){ const u = getUserById(sid); if(u && u.isActive !== false){ ME = u; ensureActiveRole(); } else localStorage.removeItem(DB_SESSION); }
    }
    if(!ME){ viewLogin(); return; }
    if((CURRENT_VIEW==='export' || CURRENT_VIEW==='logins') && !isSupportUser(ME)) CURRENT_VIEW='events';

    switch(CURRENT_VIEW){
      case 'create': viewCreateEvent(CURRENT_EDIT_ID); break;
      case 'create_course': viewCreateCourse(CURRENT_EDIT_ID); break;
      case 'courses': viewCourses(); break;
      case 'past_courses': viewPastCourses(); break;
      case 'members': viewMembers(); break;
      case 'roles': viewRoles(); break;
      case 'activity': viewActivity(); break;
      case 'past': viewPastEvents(); break;
      case 'export': viewExport(); break;
      case 'logins': viewLogins(); break;
      case 'password': viewPassword(); break;
      default: viewEvents();
    }

    if(ME) resetAutoLogoutTimer();
  } catch(e){
    showErr('Render error: '+(e.message||e));
  }
}

/* ===== Expose funkc√≠ ===== */
window.viewCourses = viewCourses;
window.viewPastCourses = viewPastCourses;
window.viewCreateCourse = viewCreateCourse;
window.saveCourse = saveCourse;
window.openCourseModal = openCourseModal;
window.closeCourseModal = closeCourseModal;
window.deleteCourse = deleteCourse;
window.addCourseMember = addCourseMember;
window.removeCourseMember = removeCourseMember;

// plus v≈°echny p≈Øvodn√≠ window.xxx funkce:
window.viewCreateEvent=viewCreateEvent;
window.saveEvent=saveEvent;
window.viewEvents=viewEvents;
window.viewPastEvents=viewPastEvents;
window.viewMembers=viewMembers;
window.viewRoles=viewRoles;
window.viewActivity=viewActivity;
window.viewExport=viewExport;
window.viewLogins=viewLogins;
window.joinEvent=joinEvent;
window.leaveEvent=leaveEvent;
window.assignMember=assignMember;
window.removeMember=removeMember;
window.setEventPaid=setEventPaid;
window.saveEventNote=saveEventNote;
window.deleteEvent=deleteEvent;

window.deleteUser=deleteUser;
window.addUser=addUser;
window.toggleUserRole=toggleUserRole;
window.saveUserInline=saveUserInline;
window.toggleActive=toggleActive;

window.editRoleOpen=editRoleOpen;
window.saveRole=saveRole;
window.deleteRole=deleteRole;
window.addRole=addRole;

window.downloadJson = downloadJson;
window.adminLogoutUser = adminLogoutUser;
window.adminLogoutAll  = adminLogoutAll;

window.viewPassword=viewPassword;
window.saveMyPassword=saveMyPassword;
window.logout=logout;

/* ===== Auto logout (30 min) ===== */
let autoLogoutTimer = null;
const AUTO_LOGOUT_MS = 30 * 60 * 1000;
function resetAutoLogoutTimer(){
  if(autoLogoutTimer) clearTimeout(autoLogoutTimer);
  if(ME){
    autoLogoutTimer = setTimeout(()=>{ alert("Byl jste automaticky odhl√°≈°en po 30 minut√°ch neƒçinnosti."); logout(); }, AUTO_LOGOUT_MS);
  }
}
['click','keydown','mousemove','scroll','touchstart'].forEach(ev=>{ window.addEventListener(ev, resetAutoLogoutTimer, true); });

/* ===== Logout ===== */
async function logout(){
  await logActivity('logout', null, null, 'u≈æivatel se odhl√°sil');
  localStorage.removeItem(DB_SESSION);
  ME=null; ACTIVE_ROLE=null;
  CURRENT_VIEW='events'; CURRENT_EDIT_ID=null;
  renderHeader();
  viewLogin();
}

renderApp();
init();

  </script>
</body>
</html>
