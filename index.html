<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smƒõn√°≈ô</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>
  <main><div id="app"></div></main>
  <div class="toast-wrap" id="toasts"></div>

<script>
/* ========= Supabase p≈ôipojen√≠ ========= */
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcHlhdndoenB2ZGJ4ZGlkZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDQxNzYsImV4cCI6MjA3MjQyMDE3Nn0.baWqIwQrlz8KJ6CfOt7-md7FZvBDSXagFXNpHy_eOH4";
let sb = null;
try{ sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }catch(e){ console.warn(e); }

/* ========= Jednotn√© kl√≠ƒçe ========= */
const DB_USERS    = "smenar.users";
const DB_ROLES    = "smenar.roles";
const DB_ACTIONS  = "smenar.actions";
const DB_ACTIVITY = "smenar.activity";
const DB_ARCHIVE  = "smenar.actions.archive";
const DB_SESSION  = "smenar.session";
const SYNC_KEYS   = [DB_USERS, DB_ROLES, DB_ACTIONS, DB_ACTIVITY, DB_ARCHIVE];

/* ========= KV helpery ========= */
async function kvUpsert(key,val){ if(!sb) return; const {error}=await sb.from("kv").upsert({key,val}); if(error) console.warn(error); }
async function bootSync(){
  if(!sb) return;
  const {data,error}=await sb.from("kv").select("key,val").in("key", SYNC_KEYS);
  if(error){ console.warn(error); return; }
  (data||[]).forEach(r=>{ try{ localStorage.setItem(r.key, JSON.stringify(r.val ?? [])); }catch(_){} });
}

/* ========= Realtime (bod 3) ========= */
let kvChannel = null;
function applyKvRow(row){
  if(!row || !row.key || !row.key.startsWith("smenar.")) return;
  try{
    if(row.val==null) localStorage.removeItem(row.key);
    else localStorage.setItem(row.key, JSON.stringify(row.val));
  }catch(_){}
}
function refreshFromLocalAndRender(){
  USERS   = load(DB_USERS);
  ROLES   = load(DB_ROLES);
  ACTIONS = load(DB_ACTIONS);
  ACTIVITY= load(DB_ACTIVITY);
  ARCHIVE = load(DB_ARCHIVE);
  // nep≈ôihla≈°uj automaticky
  renderHeader?.();
  if (ME) renderApp?.(); else viewLogin?.();
}
async function startRealtime(){
  if(!sb) return;
  if(kvChannel){ try{ await sb.removeChannel(kvChannel); }catch(_){} kvChannel=null; }
  kvChannel = sb.channel("kv-changes").on(
    "postgres_changes",
    { event: "*", schema: "public", table: "kv" },
    (payload)=>{
      const row = payload.new && Object.keys(payload.new).length ? payload.new : payload.old;
      applyKvRow(row);
      refreshFromLocalAndRender();
    }
  );
  await kvChannel.subscribe();
}

/* ========= Local API ========= */
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||"[]"); }catch(_){ return []; } }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} kvUpsert(k,v); }

/* ========= Utility ========= */
const $=s=>document.querySelector(s);
function toast(msg,sub){const w=$("#toasts");const d=document.createElement("div");d.className="toast";d.innerHTML=`<div>${msg}</div>${sub?`<small>${sub}</small>`:""}`;w.appendChild(d);setTimeout(()=>{d.style.opacity="0";d.style.transform="translateY(8px)";d.style.transition="all .25s";setTimeout(()=>w.removeChild(d),260);},3000);}
const uid=()=>crypto.randomUUID?crypto.randomUUID():"id"+Date.now();
const today=()=>new Date().toISOString().slice(0,10);

/* ========= Stav ========= */
let USERS=load(DB_USERS);
let ROLES=load(DB_ROLES);
let ACTIONS=load(DB_ACTIONS);
let ACTIVITY=load(DB_ACTIVITY);
let ARCHIVE=load(DB_ARCHIVE);
let ME=null, ACTIVE_ROLE=null;

/* ========= Seed ========= */
(function seed(){
  if(!ROLES.length){ ROLES=[{key:"ridic",label:"≈òidiƒç",isPublic:true},{key:"zza",label:"ZZA",isPublic:true},{key:"zdravotnik",label:"Zdravotn√≠k",isPublic:true}]; save(DB_ROLES,ROLES); }
  if(!USERS.length){ USERS=[{id:"u1",name:"Podpora",password:"support",roles:["support","admin"],isActive:true},{id:"u2",name:"admin",password:"1111",roles:["admin"],isActive:true}]; save(DB_USERS,USERS); }
  if(!ACTIONS.length){
    const cap={}, su={}; ["ridic","zza","zdravotnik"].forEach(k=>{cap[k]=k==="zza"?2:1; su[k]=[];});
    ACTIONS=[{id:"a1",date:today(),title:"Dozor ‚Äì fotbal",location:"Stadion",timeFrom:"15:00",timeTo:"20:00",capacity:cap,signups:su,signupUnlock:null,isPaid:false,adminNote:""}];
    save(DB_ACTIONS,ACTIONS);
  }
  if(!ACTIVITY.length) save(DB_ACTIVITY,[]);
  if(!ARCHIVE.length)  save(DB_ARCHIVE,[]);
})();

/* ========= Header/Login ========= */
function getPublicRoleKeys(){ return (ROLES||[]).filter(r=>r.isPublic).map(r=>r.key); }
function roleLabel(k){ return (ROLES||[]).find(r=>r.key===k)?.label || k; }
function userPublicRoles(u){ const pubs=getPublicRoleKeys(); return (u?.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){ if(!ME){ACTIVE_ROLE=null;return;} const prs=userPublicRoles(ME); if(!prs.length){ACTIVE_ROLE=null;return;} if(!ACTIVE_ROLE||!prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE=prs[0]; }
function userHasRole(u,r){ return (u?.roles||[]).includes(r); }
function isSupportUser(u){ return !!u && ((u.roles||[]).includes("support") || ((u?.name||"").trim().toLowerCase()==="podpora")); }

function renderHeader(){
  const el=$("#hdr"); if(!ME){ el.innerHTML=""; return; }
  ensureActiveRole(); const prs=userPublicRoles(ME);
  const roleSel = (ACTIVE_ROLE && prs.length)
    ? `<select class="select" id="selActiveRole">${prs.map(r=>`<option value="${r}" ${r===ACTIVE_ROLE?"selected":""}>${roleLabel(r)}</option>`).join("")}</select>`
    : `<span class="muted">Bez ve≈ôejn√© role</span>`;
  el.innerHTML = `<div class="row">
    <span class="badge">${ME.name}</span>
    ${roleSel}
    ${userHasRole(ME,"admin")? `<div class="menu" id="adminMenu">
      <button class="btn" id="adminBtn">Admin ‚ñæ</button>
      <div class="dropdown">
        <button onclick="viewEvents()">Ud√°losti</button>
        <button onclick="viewMembers()">ƒålenov√©</button>
        <button onclick="viewRoles()">Role</button>
      </div>
    </div>` : ""}
    <button class="btn" onclick="logout()">Odhl√°sit</button>
  </div>`;
  const sel=document.getElementById("selActiveRole"); if(sel) sel.onchange=()=>{ ACTIVE_ROLE=sel.value; renderApp(); };
  const menu=document.getElementById("adminMenu"); if(menu){ const btn=document.getElementById("adminBtn"); btn.addEventListener("click",(e)=>{e.stopPropagation();menu.classList.toggle("open");}); document.addEventListener("click",(e)=>{ if(!menu.contains(e.target)) menu.classList.remove("open"); }); }
}

function viewLogin(){
  const app=$("#app");
  app.innerHTML=`<div class="card" style="max-width:420px;margin:40px auto">
    <h3>P≈ôihl√°≈°en√≠</h3>
    <input id="loginName" class="input" placeholder="Jm√©no">
    <div class="row" style="justify-content:space-between;width:100%">
      <input id="loginPass" class="input" type="password" placeholder="Heslo" style="flex:1">
      <button class="btn" id="togglePass">üëÅÔ∏è</button>
    </div>
    <button class="btn primary" id="btnLogin">P≈ôihl√°sit</button>
  </div>`;
  document.getElementById("togglePass").onclick=()=>{ const i=document.getElementById("loginPass"); i.type=(i.type==="password"?"text":"password"); };
  document.getElementById("btnLogin").onclick=()=>{
    const n=document.getElementById("loginName").value.trim();
    const p=document.getElementById("loginPass").value;
    const u=USERS.find(x=>x.name===n && x.password===p && x.isActive!==false);
    if(!u){ alert("Neplatn√© √∫daje"); return; }
    ME=u; localStorage.setItem(DB_SESSION, ME.id); ensureActiveRole(); renderApp();
  };
}
function logout(){ localStorage.removeItem(DB_SESSION); ME=null; ACTIVE_ROLE=null; renderHeader(); viewLogin(); }

/* ========= Ud√°losti ========= */
function nowMs(){ return Date.now(); }
function safeHHMM(s){ return /^\d{2}:\d{2}$/.test(s||"")?s:""; }
function eventEndMs(a){ const d=a?.date||today(); const end=safeHHMM(a?.timeTo)||safeHHMM(a?.timeFrom)||"23:59"; const t=new Date(`${d}T${end}`).getTime(); return isNaN(t)?new Date(`${d}T23:59`).getTime():t; }
function isPastEvent(a){ return nowMs()>eventEndMs(a); }
function getUnlockMs(a){ if(!a||!a.signupUnlock) return 0; const ms=new Date(a.signupUnlock).getTime(); return isNaN(ms)?0:ms; }
function getUnlockOpen(a){ const u=getUnlockMs(a); return (u===0)||(nowMs()>=u); }
function sortEvents(a,b){ const A=(a.date||"")+" "+(a.timeFrom||"00:00"); const B=(b.date||"")+" "+(b.timeFrom||"00:00"); return A.localeCompare(B); }

function viewEvents(){
  const app=$("#app");
  const pubs=getPublicRoleKeys();
  const cards = (ACTIONS||[]).slice().sort(sortEvents).map(a=>{
    const capHtml = pubs.map(r=>{
      const list=a.signups?.[r]||[]; const names=list.map(id=> (USERS.find(u=>u.id===id)||{}).name ).filter(Boolean).join(", ");
      return `<li><b>${roleLabel(r)}</b>: ${list.length}/${(a.capacity?.[r]||0)} ‚Äî ${names||"‚Äî"}</li>`;
    }).join("");
    const isOpen=getUnlockOpen(a);
    let actionBtn="";
    if(!ME) actionBtn=`<span class="muted">P≈ôihla≈°ov√°n√≠ a≈æ po p≈ôihl√°≈°en√≠</span>`;
    else if(!isOpen) actionBtn=`<span class="muted">P≈ôihla≈°ov√°n√≠ se otev≈ôe: <b>${a.signupUnlock?new Date(a.signupUnlock).toLocaleString():""}</b></span>`;
    else if(ACTIVE_ROLE){
      const myList=a.signups[ACTIVE_ROLE]||[]; const isIn=myList.includes(ME.id);
      actionBtn = isIn ? `<button class="btn danger" onclick="leaveEvent('${a.id}')">Odhl√°sit se</button>`
                       : (myList.length>=(a.capacity[ACTIVE_ROLE]||0) ? `<span class="muted">Kapacita pro roli ${roleLabel(ACTIVE_ROLE)} je pln√°</span>`
                                                                     : `<button class="btn primary" onclick="joinEvent('${a.id}')">P≈ôihl√°sit se</button>`);
    } else actionBtn=`<span class="muted">Nem√°te vybranou ve≈ôejnou roli</span>`;
    return `<div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div><div style="font-weight:700">${a.title}</div><div class="muted">${a.date} ‚Ä¢ ${a.location||"‚Äî"} ‚Ä¢ ${(a.timeFrom||"")}${a.timeTo?("‚Äì"+a.timeTo):""}</div></div>
        ${userHasRole(ME,"admin")?`<div class="row"><button class="btn" onclick="editEvent('${a.id}')">Upravit</button><button class="btn danger" onclick="deleteEvent('${a.id}')">Smazat</button></div>`:""}
      </div>
      <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>
      <div class="row" style="margin-top:8px">${actionBtn}</div>
    </div>`;
  }).join("");
  app.innerHTML = `<h3>Ud√°losti</h3>${cards || `<div class="card muted">≈Ω√°dn√© ud√°losti.</div>`}`;
}
function joinEvent(aid){
  const a=ACTIONS.find(x=>x.id===aid); if(!a||!ME) return;
  if(!getUnlockOpen(a)){ alert("P≈ôihla≈°ov√°n√≠ je≈°tƒõ nen√≠ otev≈ôen√©."); return; }
  if(!ACTIVE_ROLE){ alert("Nem√°te vybranou ve≈ôejnou roli"); return; }
  a.signups[ACTIVE_ROLE]=a.signups[ACTIVE_ROLE]||[];
  if(a.signups[ACTIVE_ROLE].includes(ME.id)) return;
  if(a.signups[ACTIVE_ROLE].length>=(a.capacity[ACTIVE_ROLE]||0)){ alert("Kapacita pln√°"); return; }
  a.signups[ACTIVE_ROLE].push(ME.id);
  save(DB_ACTIONS,ACTIONS); viewEvents(); toast("P≈ôihl√°≈°en√≠ OK", a.title);
}
function leaveEvent(aid){
  const a=ACTIONS.find(x=>x.id===aid); if(!a||!ME||!ACTIVE_ROLE) return;
  a.signups[ACTIVE_ROLE]=(a.signups[ACTIVE_ROLE]||[]).filter(id=>id!==ME.id);
  save(DB_ACTIONS,ACTIONS); viewEvents(); toast("Odhl√°≈°en√≠ OK", a.title);
}
function deleteEvent(aid){
  if(!confirm("Opravdu smazat?")) return;
  ACTIONS=ACTIONS.filter(x=>x.id!==aid);
  save(DB_ACTIONS,ACTIONS); viewEvents(); toast("Ud√°lost smaz√°na");
}
function editEvent(id){
  const a = id ? ACTIONS.find(x=>x.id===id) : null;
  const pubs=getPublicRoleKeys();
  const toLocalDTVal = (d)=>{ if(!d) return ""; const Y=d.getFullYear(),M=String(d.getMonth()+1).padStart(2,"0"),D=String(d.getDate()).padStart(2,"0"),h=String(d.getHours()).padStart(2,"0"),m=String(d.getMinutes()).padStart(2,"0"); return `${Y}-${M}-${D}T${h}:${m}`; };
  const unlockVal = a && a.signupUnlock ? new Date(a.signupUnlock) : null;
  $("#app").innerHTML = `
    <h3>${a?"Upravit ud√°lost":"Nov√° ud√°lost"}</h3>
    <div class="card">
      <div class="grid3">
        <input id="evTitle" class="input" placeholder="N√°zev" value="${a?a.title:""}">
        <input id="evLocation" class="input" placeholder="M√≠sto" value="${a?a.location:""}">
        <input id="evDate" class="input" type="date" value="${a?(a.date||today()):today()}">
      </div>
      <div class="grid3" style="margin-top:8px">
        <input id="evFrom" class="input" type="time" value="${a?(a.timeFrom||""): ""}">
        <input id="evTo"   class="input" type="time" value="${a?(a.timeTo  ||""): ""}">
        <input id="evUnlock" class="input" type="datetime-local" value="${toLocalDTVal(unlockVal)}" placeholder="Odemknut√≠ p≈ôihla≈°ov√°n√≠">
      </div>
      <div class="grid3" style="margin-top:8px">
        ${pubs.map(r=>`<div><div class="muted" style="font-size:12px">${roleLabel(r)}</div><input id="cap_${r}" class="input" type="number" min="0" value="${a?(a.capacity?.[r]||0):0}"></div>`).join("")}
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" onclick="viewEvents()">Zpƒõt</button>
        <button class="btn primary" onclick="${a?`saveEvent('${a.id}')`:`saveEvent(null)`}">Ulo≈æit</button>
      </div>
    </div>`;
}
function saveEvent(editId){
  const pubs=getPublicRoleKeys();
  const title=($("#evTitle").value||"").trim(); if(!title){ alert("Zadejte n√°zev"); return; }
  const capacity={}; pubs.forEach(r=> capacity[r]=parseInt($("#cap_"+r).value||"0",10) );
  const date = $("#evDate").value || today();
  const unlockInput = $("#evUnlock").value; const unlockIso = unlockInput ? new Date(unlockInput).toISOString() : null;
  let ev;
  if(editId){
    const old=ACTIONS.find(x=>x.id===editId) || {signups:{}};
    const signups={}; pubs.forEach(r=> signups[r]=(old.signups[r]||[]) );
    ev={ id:editId, date, title, location:$("#evLocation").value||"", timeFrom:$("#evFrom").value||"", timeTo:$("#evTo").value||"", signupUnlock:unlockIso, capacity, signups, isPaid:(typeof old.isPaid==="boolean")?old.isPaid:false, adminNote:(typeof old.adminNote==="string")?old.adminNote:"" };
    ACTIONS=ACTIONS.map(x=>x.id===editId?ev:x);
  }else{
    const signups={}; pubs.forEach(r=> signups[r]=[] );
    ev={ id:uid(), date, title, location:$("#evLocation").value||"", timeFrom:$("#evFrom").value||"", timeTo:$("#evTo").value||"", signupUnlock:unlockIso, capacity, signups, isPaid:false, adminNote:"" };
    ACTIONS=[ev, ...ACTIONS];
  }
  save(DB_ACTIONS,ACTIONS); viewEvents(); toast("Ud√°lost ulo≈æena", title);
}

/* ========= Members & Roles (zkr√°ceno) ========= */
function viewMembers(){
  const app=$("#app"); const roles=ROLES||[];
  const create = `
    <div class="card">
      <h4>Vytvo≈ôit ƒçlena</h4>
      <div class="grid2">
        <input id="newName" class="input" placeholder="Jm√©no">
        <div class="row"><input id="newPass" class="input" type="password" placeholder="Heslo" style="flex:1"><button class="btn" id="toggleNewPass">üëÅÔ∏è</button></div>
      </div>
      <div class="row" style="margin-top:6px">${roles.map(r=>`<label class="pill"><input type="checkbox" id="role_${r.key}"><span>${r.label}</span></label>`).join("")}
        <label class="pill"><input type="checkbox" id="role_admin"><span>Admin</span></label>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px"><button class="btn primary" onclick="createUser()">Vytvo≈ôit</button></div>
    </div>`;
  const list = (USERS||[]).map(u=>{
    const rid="pw_"+u.id;
    return `<div class="card">
      <div class="grid2">
        <input id="name_${u.id}" class="input" value="${u.name||""}">
        <div class="row"><input id="${rid}" class="input" type="password" value="${u.password||""}" style="flex:1"><button class="btn" onclick="toggleInput('${rid}')">üëÅÔ∏è</button></div>
      </div>
      <div class="row" style="margin-top:6px">${roles.map(r=>`<label class="pill"><input type="checkbox" id="edit_${u.id}_${r.key}" ${(u.roles||[]).includes(r.key)?"checked":""}><span>${r.label}</span></label>`).join("")}
        <label class="pill"><input type="checkbox" id="edit_${u.id}_admin" ${(u.roles||[]).includes("admin")?"checked":""}><span>Admin</span></label>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" onclick="saveUser('${u.id}')">Ulo≈æit</button>
        <button class="btn danger" onclick="deleteUser('${u.id}')">Smazat</button>
      </div>
    </div>`;
  }).join("");
  app.innerHTML = `<h3>ƒålenov√©</h3>${create}${list}`;
  const tnp=document.getElementById("toggleNewPass"); if(tnp) tnp.onclick=()=>toggleInput("newPass");
}
function toggleInput(id){ const i=document.getElementById(id); if(i) i.type=(i.type==="password"?"text":"password"); }
function createUser(){
  const name=($("#newName")?.value||"").trim(); const pass=($("#newPass")?.value||"");
  if(!name||!pass){ alert("Jm√©no a heslo jsou povinn√©"); return; }
  const roleKeys=(ROLES||[]).map(r=>r.key); let selected=roleKeys.filter(k=> $("#role_"+k)?.checked ); if($("#role_admin")?.checked) selected.push("admin");
  const u={id:uid(),name,password:pass,roles:Array.from(new Set(selected)),isActive:true}; USERS.push(u); save(DB_USERS,USERS); viewMembers(); toast("ƒålen vytvo≈ôen", name);
}
function saveUser(uidx){
  const u=USERS.find(x=>x.id===uidx); if(!u) return;
  const rolesArr=(ROLES||[]).map(r=>r.key).concat(["admin"]); let selected=rolesArr.filter(k=> !!$("#edit_"+u.id+"_"+k)?.checked );
  u.name = ($("#name_"+u.id)?.value||u.name).trim(); const pw=$("#pw_"+u.id); if(pw && pw.value) u.password=pw.value; u.roles=selected;
  save(DB_USERS,USERS); viewMembers(); toast("Ulo≈æeno", u.name);
}
function deleteUser(uidx){
  if(!confirm("Opravdu smazat ƒçlena?")) return;
  USERS=USERS.filter(x=>x.id!==uidx);
  const pubs=getPublicRoleKeys(); (ACTIONS||[]).forEach(a=> pubs.forEach(r=>{ a.signups[r]=(a.signups[r]||[]).filter(id=>id!==uidx); }));
  save(DB_USERS,USERS); save(DB_ACTIONS,ACTIONS); viewMembers(); toast("ƒålen smaz√°n");
}

function viewRoles(){
  const app=$("#app"); const roles=ROLES||[];
  const addForm = `<div class="card"><h4>P≈ôidat roli</h4>
    <div class="grid2"><input id="roleKey" class="input" placeholder="kl√≠ƒç bez diakritiky"><input id="roleLabel" class="input" placeholder="N√°zev"></div>
    <label class="row" style="margin-top:6px"><input id="rolePublic" type="checkbox" checked> Ve≈ôejn√° role</label>
    <div class="row" style="justify-content:flex-end;margin-top:10px"><button class="btn primary" onclick="createRole()">P≈ôidat</button></div></div>`;
  const list = roles.map(r=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:12px"><span class="badge">${r.key}</span>
          <input id="label_${r.key}" class="input" value="${r.label}" style="min-width:220px">
          <label class="row"><input type="checkbox" id="pub_${r.key}" ${r.isPublic?"checked":""}> Ve≈ôejn√°</label>
        </div>
        <div class="row">
          <button class="btn" onclick="saveRole('${r.key}')">Ulo≈æit</button>
          <button class="btn danger" onclick="deleteRole('${r.key}')">Smazat</button>
        </div>
      </div>
    </div>`).join("");
  app.innerHTML = `<h3>Role</h3>${addForm}${list||`<div class="card muted">≈Ω√°dn√© role.</div>`}`;
}
function slugify(s){return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,"");}
function createRole(){
  let key=slugify($("#roleKey")?.value||""); const label=($("#roleLabel")?.value||"").trim(); const isPublic=!!$("#rolePublic")?.checked;
  if(!key||!label){ alert("Vypl≈àte kl√≠ƒç i n√°zev role."); return; }
  if((ROLES||[]).some(r=>r.key===key)){ alert("Kl√≠ƒç u≈æ existuje."); return; }
  ROLES.push({key,label,isPublic}); save(DB_ROLES,ROLES);
  const acts=ACTIONS||[]; acts.forEach(a=>{ a.capacity ||= {}; a.signups ||= {}; a.capacity[key]=0; a.signups[key]=[]; }); save(DB_ACTIONS,acts);
  viewRoles(); toast("Role p≈ôid√°na", label);
}
function saveRole(key){
  const r=(ROLES||[]).find(x=>x.key===key); if(!r) return;
  r.label=($("#label_"+key)?.value||r.label).trim(); r.isPublic=!!$("#pub_"+key)?.checked; save(DB_ROLES,ROLES);
  const pubs=getPublicRoleKeys(); const acts=ACTIONS||[]; acts.forEach(a=>{ a.capacity ||= {}; a.signups ||= {}; pubs.forEach(k=>{ if(!(k in a.capacity)) a.capacity[k]=0; if(!(k in a.signups)) a.signups[k]=[]; }); Object.keys(a.capacity).forEach(k=>{ if(!pubs.includes(k)) delete a.capacity[k]; }); Object.keys(a.signups).forEach(k=>{ if(!pubs.includes(k)) delete a.signups[k]; }); });
  save(DB_ACTIONS,acts); viewRoles(); toast("Role upravena", r.label);
}
function deleteRole(key){
  if(!confirm("Smazat roli?")) return;
  ROLES = (ROLES||[]).filter(r=>r.key!==key); save(DB_ROLES,ROLES);
  (USERS||[]).forEach(u=>{ u.roles=(u.roles||[]).filter(k=>k!==key); }); save(DB_USERS,USERS);
  (ACTIONS||[]).forEach(a=>{ if(a.capacity) delete a.capacity[key]; if(a.signups) delete a.signups[key]; }); save(DB_ACTIONS,ACTIONS);
  if(ACTIVE_ROLE===key){ ACTIVE_ROLE=null; }
  renderApp(); toast("Role smaz√°na", key);
}

/* ========= Init / Render ========= */
function renderApp(){
  renderHeader();
  if(!ME){ viewLogin(); return; }  // <-- d≈Øle≈æit√© (nep≈ôep√≠nej bez p≈ôihl√°≈°en√≠)
  viewEvents();
}

(async function init(){
  // 1) St√°hni DB ‚Üí localStorage (max 3s)
  try{ await Promise.race([bootSync(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("bootSync timeout")),3000))]); }catch(_){}
  // 2) Realtime kan√°l
  startRealtime();
  // 3) Fallback: polling ka≈æd√Ωch 15 s (kdyby Realtime nebƒõ≈æel)
  setInterval(()=> bootSync().then(refreshFromLocalAndRender).catch(()=>{}), 15000);

  // 4) Session a render
  const sid = localStorage.getItem(DB_SESSION);
  if(sid){ ME = (USERS||[]).find(u=>u.id===sid) || null; }
  renderApp();
})();
</script>
</body>
</html>
