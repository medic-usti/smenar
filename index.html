<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smƒõn√°≈ô ‚Äì dynamick√© role + datum + aktivita + odemknut√≠ p≈ôihla≈°ov√°n√≠</title>

  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    details summary{cursor:pointer; user-select:none; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .admin-box{border:1px dashed var(--border); border-radius:10px; padding:10px; margin-top:10px; background:#fafbff}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}
  </style>

  <!-- Supabase klient -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>
  <main>
    <div id="app"></div>
  </main>
  <div class="toast-wrap" id="toasts"></div>

<script>
// === Supabase cloud-sync (minimal) ===
// TV√â HODNOTY:
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcHlhdndoenB2ZGJ4ZGlkZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDQxNzYsImV4cCI6MjA3MjQyMDE3Nn0.baWqIwQrlz8KJ6CfOt7-md7FZvBDSXagFXNpHy_eOH4";
let sb = null;
try{ sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }catch(_) {}

// ---- Jedin√° sada kl√≠ƒç≈Ø (≈æ√°dn√© duplicity) ----
const DB_USERS    = "smenar.users";
const DB_ROLES    = "smenar.roles";
const DB_ACTIONS  = "smenar.actions";
const DB_ACTIVITY = "smenar.activity";
const DB_ARCHIVE  = "smenar.actions.archive";
const DB_SESSION  = "smenar.session";
const SYNC_KEYS   = [DB_USERS, DB_ROLES, DB_ACTIONS, DB_ACTIVITY, DB_ARCHIVE];

// ---- KV helpery (DB) ----
async function kvUpsert(key,val){
  if(!sb) return;
  const { error } = await sb.from("kv").upsert({ key, val });
  if(error) console.warn("kvUpsert error", error);
}
async function bootSync(){
  if(!sb) return;
  const { data, error } = await sb.from("kv").select("key,val").in("key", SYNC_KEYS);
  if(error){ console.warn("bootSync error", error); return; }
  (data||[]).forEach(r=>{ try{ localStorage.setItem(r.key, JSON.stringify(r.val ?? [])); }catch(_){} });
}

// ---- Local API: load/save (dual-write) ----
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||"[]"); }catch(_){ return []; } }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){} kvUpsert(k,v); }

// ---- Utility ----
const uid = () => (crypto.randomUUID ? crypto.randomUUID() : ("id"+Date.now()));
const nowIso = () => new Date().toISOString();
const today = () => new Date().toISOString().slice(0,10);
const nowMs = () => Date.now();
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>Array.from(document.querySelectorAll(s));
function toast(msg, sub){ const w=$("#toasts"); const d=document.createElement("div"); d.className="toast"; d.innerHTML=`<div>${msg}</div>${sub?`<small>${sub}</small>`:""}`; w.appendChild(d); setTimeout(()=>{d.style.opacity="0"; d.style.transform="translateY(8px)"; d.style.transition="all .25s"; setTimeout(()=>w.removeChild(d),260);},3000); }
function fmtDate(d){ return d || "‚Äî"; }
function getSession(){ return localStorage.getItem(DB_SESSION); }
function setSession(id){ if(id) localStorage.setItem(DB_SESSION,id); else localStorage.removeItem(DB_SESSION); }

// ---- Role helpers ----
function loadRoles(){ return load(DB_ROLES); }
function saveRoles(r){ save(DB_ROLES,r); }
function slugify(s){ return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9_]+/g,"_").replace(/^_+|_+$/g,""); }
function getPublicRoleKeys(){ return (loadRoles()||[]).filter(r=>r.isPublic).map(r=>r.key); }
function roleLabel(key){ return (loadRoles()||[]).find(r=>r.key===key)?.label || key; }

// ---- Aktivita ----
function loadAct(){ try{ return JSON.parse(localStorage.getItem(DB_ACTIVITY)||"[]"); }catch(_){ return []; } }
function saveAct(a){ localStorage.setItem(DB_ACTIVITY, JSON.stringify(a)); }
function lastSeenKey(uid){ return `smenar.activity.lastseen.${uid}`; }
function getLastSeen(uid){ return parseInt(localStorage.getItem(lastSeenKey(uid))||"0",10); }
function setLastSeen(uid, ts){ localStorage.setItem(lastSeenKey(uid), String(ts||Date.now())); }

// ---- Archiv ----
function loadArchive(){ try{ return JSON.parse(localStorage.getItem(DB_ARCHIVE)||"[]"); }catch(_){ return []; } }
function saveArchive(a){ localStorage.setItem(DB_ARCHIVE, JSON.stringify(a)); }

// ---- Stav ----
let USERS   = load(DB_USERS);
let ACTIONS = load(DB_ACTIONS);
let ME      = null;
let ACTIVE_ROLE = null;
let adminWatchTimer = null;

// ---- Helpery ----
function refreshStores(){ USERS = load(DB_USERS); ACTIONS = load(DB_ACTIONS); }
function getUserById(id){ return USERS.find(u=>u.id===id) || null; }
function userHasRole(u,r){ return (u?.roles||[]).includes(r); }
function isSupportUser(u){ if(!u) return false; return (u.roles||[]).includes("support") || ((u.name||"").trim().toLowerCase()==="podpora"); }
function userPublicRoles(u){ const pubs = getPublicRoleKeys(); return (u?.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){ if(!ME){ ACTIVE_ROLE=null; return; } const prs=userPublicRoles(ME); if(!prs.length){ ACTIVE_ROLE=null; return; } if(!ACTIVE_ROLE || !prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE=prs[0]; }
function safeHHMM(s){ return /^\d{2}:\d{2}$/.test(s||"") ? s : ""; }
function eventEndMs(a){ const d=a?.date||today(); const end=safeHHMM(a?.timeTo)||safeHHMM(a?.timeFrom)||"23:59"; const t=new Date(`${d}T${end}`).getTime(); return isNaN(t)? new Date(`${d}T23:59`).getTime():t; }
function isPastEvent(a){ return nowMs() > eventEndMs(a); }
function sortEvents(a,b){ const A=(a.date||"")+" "+(a.timeFrom||"00:00"); const B=(b.date||"")+" "+(b.timeFrom||"00:00"); return A.localeCompare(B); }
function getUnlockMs(a){ if(!a||!a.signupUnlock) return 0; const ms=new Date(a.signupUnlock).getTime(); return isNaN(ms)?0:ms; }

// ---- Seed (prvn√≠ spu≈°tƒõn√≠) ----
(function seed(){
  if(!localStorage.getItem(DB_ROLES)){
    saveRoles([
      { key:"ridic", label:"≈òidiƒç", isPublic:true },
      { key:"zza",   label:"ZZA",   isPublic:true },
      { key:"zdravotnik", label:"Zdravotn√≠k", isPublic:true },
    ]);
  }
  if(!localStorage.getItem(DB_USERS)){
    save(DB_USERS,[
      {id:"u1",name:"Podpora",password:"support",roles:["support","admin"],isActive:true},
      {id:"u2",name:"admin",password:"1111",roles:["admin"],isActive:true},
      {id:"u3",name:"Adam", password:"adam", roles:["ridic","zza"],isActive:true},
      {id:"u4",name:"B√°ra", password:"bara", roles:["zdravotnik"],isActive:true}
    ]);
  }
  if(!localStorage.getItem(DB_ACTIONS)){
    const pubs = getPublicRoleKeys(); const capacity={}, signups={};
    pubs.forEach(k=>{ capacity[k]=(k==="ridic"?1:(k==="zza"?2:(k==="zdravotnik"?1:0))); signups[k]=[]; });
    save(DB_ACTIONS,[{ id:"a1", date: today(), title:"Dozor ‚Äì fotbal", location:"Stadion Kladno", timeFrom:"15:00", timeTo:"20:00", capacity, signups, signupUnlock:null, isPaid:false, adminNote:"" }]);
  }else{
    const pubs = getPublicRoleKeys(); const acts=load(DB_ACTIONS);
    acts.forEach(a=>{
      a.date ||= today();
      a.capacity ||= {}; a.signups ||= {};
      if(typeof a.signupUnlock === "undefined") a.signupUnlock = null;
      if(typeof a.isPaid === "undefined") a.isPaid = false;
      if(typeof a.adminNote === "undefined") a.adminNote = "";
      pubs.forEach(k=>{ if(!(k in a.capacity)) a.capacity[k]=0; if(!(k in a.signups)) a.signups[k]=[]; });
      Object.keys(a.capacity).forEach(k=>{ if(!pubs.includes(k)) delete a.capacity[k]; });
      Object.keys(a.signups).forEach(k=>{ if(!pubs.includes(k)) delete a.signups[k]; });
    });
    save(DB_ACTIONS,acts);
  }
  if(!localStorage.getItem(DB_ACTIVITY)) saveAct([]);
  if(!localStorage.getItem(DB_ARCHIVE))  saveArchive([]);
})();

// ---- Exporty (jen Podpora) ----
function csvEscape(val){ if(val==null) return ""; const s=String(val).replace(/\r?\n/g," "); return /[";,\t]/.test(s)? `"${s.replace(/"/g,'""')}"` : s; }
function toCSV(rows, header){ const lines=[header.join(";")]; rows.forEach(r=>lines.push(header.map(h=>csvEscape(r[h])).join(";"))); return lines.join("\r\n"); }
function downloadFile(filename, content, mime="text/plain;charset=utf-8"){ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},200); }

function isMePrivileged(){
  return !!(ME && ( userHasRole(ME,"admin") || isSupportUser(ME) ));
}

window.exportUsersCSV = function(){
  if(!isMePrivileged()){ alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora."); return; }
  refreshStores();
  const rows = (USERS||[]).map(u=>({id:u.id, name:u.name||"", roles:(u.roles||[]).join(","), isActive:u.isActive?1:0, password_changed_at:u.passwordChangedAt||""}));
  const header=["id","name","roles","isActive","password_changed_at"];
  downloadFile(`users_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

window.exportEventsCSV = function(){
  if(!isMePrivileged()){ alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora."); return; }
  refreshStores();
  const pubs=getPublicRoleKeys();
  const header=["id","date","title","location","timeFrom","timeTo","signupUnlock","isPaid","adminNote"]
    .concat(pubs.map(k=>"cap_"+k)).concat(pubs.map(k=>"signups_count_"+k)).concat(pubs.map(k=>"signups_names_"+k));
  const rows=(ACTIONS||[]).map(a=>{
    const row={ id:a.id,date:a.date,title:a.title||"",location:a.location||"",timeFrom:a.timeFrom||"",timeTo:a.timeTo||"",signupUnlock:a.signupUnlock||"",isPaid:a.isPaid?1:0,adminNote:a.adminNote||"" };
    pubs.forEach(k=>{ const list=a.signups?.[k]||[]; row["cap_"+k]=a.capacity?.[k]??0; row["signups_count_"+k]=list.length; row["signups_names_"+k]=list.map(id=> (getUserById(id)||{}).name).filter(Boolean).join(", "); });
    return row;
  });
  downloadFile(`events_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

window.exportArchiveCSV = function(){
  if(!isMePrivileged()){ alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora."); return; }
  const arc=loadArchive(); const pubs=getPublicRoleKeys();
  const header=["id","date","title","location","timeFrom","timeTo","signupUnlock","isPaid","adminNote"]
    .concat(pubs.map(k=>"cap_"+k)).concat(pubs.map(k=>"signups_count_"+k)).concat(pubs.map(k=>"signups_names_"+k));
  const rows=(arc||[]).map(a=>{
    const row={ id:a.id,date:a.date,title:a.title||"",location:a.location||"",timeFrom:a.timeFrom||"",timeTo:a.timeTo||"",signupUnlock:a.signupUnlock||"",isPaid:a.isPaid?1:0,adminNote:a.adminNote||"" };
    pubs.forEach(k=>{ const list=a.signups?.[k]||[]; row["cap_"+k]=a.capacity?.[k]??0; row["signups_count_"+k]=list.length; row["signups_names_"+k]=list.map(id=> (getUserById(id)||{}).name).filter(Boolean).join(", "); });
    return row;
  });
  downloadFile(`archive_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

window.exportSignupsCSV = function(){
  if(!isMePrivileged()){ alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora."); return; }
  refreshStores();
  const pubs=getPublicRoleKeys(); const rows=[];
  function pushFrom(source, arr){ (arr||[]).forEach(a=>{ pubs.forEach(k=>{ (a.signups?.[k]||[]).forEach(uid=>{ const u=getUserById(uid)||{}; rows.push({source, event_id:a.id, event_title:a.title||"", date:a.date||"", role:k, user_id:uid, user_name:u.name||"", isPaid:a.isPaid?1:0}); }); }); }); }
  pushFrom("active", ACTIONS); pushFrom("archive", loadArchive());
  const header=["source","event_id","event_title","date","role","user_id","user_name","isPaid"];
  downloadFile(`signups_${today()}.csv`, toCSV(rows,header), "text/csv;charset=utf-8");
};

window.exportBackupJSON = function(){
  if(!isMePrivileged()){ alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora."); return; }
  refreshStores();
  const payload={ version:1, exportedAt:new Date().toISOString(), users:USERS||[], roles:loadRoles()||[], actions:ACTIONS||[], archive:loadArchive()||[] };
  downloadFile(`backup_${today()}.json`, JSON.stringify(payload,null,2), "application/json;charset=utf-8");
};

window.exportAll = function(){
  if(!isMePrivileged()){ alert("Export m≈Ø≈æe prov√°dƒõt pouze Podpora."); return; }
  exportUsersCSV(); exportEventsCSV(); exportArchiveCSV(); exportSignupsCSV(); exportBackupJSON();
};

// ---- Aktivita / Logov√°n√≠ ----
function logActivity(entry){
  const list=loadAct(); const item=Object.assign({ id:uid(), ts: Date.now() }, entry);
  list.push(item); saveAct(list);
  if(ME){
    const role=item.roleKey?` (${roleLabel(item.roleKey)})`:"";
    if(item.type==="join")   toast("P≈ôihl√°≈°en√≠ OK", `Na ${item.eventTitle}${role}`);
    if(item.type==="leave")  toast("Odhl√°≈°en√≠ OK", `Z ${item.eventTitle}${role}`);
    if(item.type==="assign") toast("P≈ôi≈ôazeno", `Na ${item.eventTitle}${role}`);
    if(item.type==="remove") toast("Odebr√°no", `Z ${item.eventTitle}${role}`);
    if(item.type==="createEvent") toast("Ud√°lost ulo≈æena", item.eventTitle||"");
    if(item.type==="updateEvent") toast("Ud√°lost ulo≈æena", item.eventTitle||"");
    if(item.type==="deleteEvent") toast("Ud√°lost smaz√°na", item.eventTitle||"");
  }
}

// ---- Admin watcher ----
function startAdminWatcher(){
  if(adminWatchTimer){ clearInterval(adminWatchTimer); adminWatchTimer=null; }
  if(!ME || !userHasRole(ME,"admin")) return;
  adminWatchTimer = setInterval(()=>{
    const last=getLastSeen(ME.id); const list=loadAct(); const unseen=list.filter(x=>x.ts>last);
    if(unseen.length){
      unseen.slice(-5).forEach(x=>{
        const who=x.userName || (getUserById(x.userId)?.name) || "u≈æivatel";
        const ev =x.eventTitle || (ACTIONS.find(a=>a.id===x.eventId)?.title) || "ud√°lost";
        const role=x.roleKey ? ` (${roleLabel(x.roleKey)})` : "";
        const verb = x.type==="join"?"p≈ôihl√°sil": x.type==="leave"?"odhl√°sil":"provedl";
        const msg = (x.type==="join"||x.type==="leave") ? `${who} se ${verb} ${ev}${role}` : `Aktivita: ${ev}`;
        toast("Aktivita", msg);
      });
      setLastSeen(ME.id, unseen[unseen.length-1].ts);
    }
  }, 3000);
}

// ---- Ud√°losti: join/leave ----
function getUnlockOpen(a){ const u=getUnlockMs(a); return (u===0) || (nowMs()>=u); }
function joinEvent(aid){
  refreshStores();
  const a=ACTIONS.find(x=>x.id===aid); if(!a) return;
  if(!getUnlockOpen(a)){ alert("P≈ôihla≈°ov√°n√≠ je≈°tƒõ nen√≠ otev≈ôen√©."); return; }
  if(!ACTIVE_ROLE){ alert("Nem√°te vybranou ve≈ôejnou roli"); return; }
  a.signups[ACTIVE_ROLE]=a.signups[ACTIVE_ROLE]||[];
  if(a.signups[ACTIVE_ROLE].includes(ME.id)){ alert("U≈æ jste p≈ôihl√°≈°en/a"); return; }
  if(a.signups[ACTIVE_ROLE].length >= (a.capacity[ACTIVE_ROLE]||0)){ alert("Kapacita pln√°"); return; }
  a.signups[ACTIVE_ROLE].push(ME.id);
  save(DB_ACTIONS,ACTIONS);
  logActivity({ type:"join", userId:ME.id, userName:ME.name, roleKey:ACTIVE_ROLE, eventId:a.id, eventTitle:a.title });
  viewEvents();
}
function leaveEvent(aid){
  refreshStores();
  const a=ACTIONS.find(x=>x.id===aid); if(!a) return;
  if(!ACTIVE_ROLE) return;
  a.signups[ACTIVE_ROLE]=(a.signups[ACTIVE_ROLE]||[]).filter(id=>id!==ME.id);
  save(DB_ACTIONS,ACTIONS);
  logActivity({ type:"leave", userId:ME.id, userName:ME.name, roleKey:ACTIVE_ROLE, eventId:a.id, eventTitle:a.title });
  viewEvents();
}

// ---- Admin: Paid/Note i v archivu ----
function togglePaid(aid, val, origin){
  refreshStores();
  let changed=false; let title="Ud√°lost";
  let a=ACTIONS.find(x=>x.id===aid);
  if(a){ a.isPaid=!!val; save(DB_ACTIONS,ACTIONS); changed=true; title=a.title; }
  else { let arc=loadArchive(); const idx=arc.findIndex(x=>x.id===aid); if(idx>=0){ arc[idx].isPaid=!!val; saveArchive(arc); changed=true; title=arc[idx].title||title; } }
  if(changed){
    logActivity({ type:"markPaid", userId:ME?.id, userName:ME?.name, eventId:aid, eventTitle:title, value:!!val });
    if(origin==="archive") viewPastEvents(); else if(origin==="active") viewEvents(); else renderApp();
  }
}
function saveAdminNote(aid, origin){
  refreshStores(); let updated=false; let title="Ud√°lost";
  let a=ACTIONS.find(x=>x.id===aid);
  if(a){ const el=$("#note_"+aid); a.adminNote=el?el.value:""; save(DB_ACTIONS,ACTIONS); updated=true; title=a.title; }
  else { let arc=loadArchive(); const idx=arc.findIndex(x=>x.id===aid); if(idx>=0){ const el=$("#note_"+aid); arc[idx].adminNote=el?el.value:""; title=arc[idx].title||title; saveArchive(arc); updated=true; } }
  if(updated){
    logActivity({ type:"adminNote", userId:ME?.id, userName:ME?.name, eventId:aid, eventTitle:title });
    toast("Pozn√°mka ulo≈æena", title);
    if(origin==="archive") viewPastEvents(); else if(origin==="active") viewEvents(); else renderApp();
  }
}

// ---- Admin: ruƒçn√≠ p≈ôi≈ôazen√≠/odebr√°n√≠ ----
function adminAssign(aid, role){
  refreshStores();
  const a=ACTIONS.find(x=>x.id===aid); if(!a) return;
  const sel = document.getElementById(`assign_${aid}_${role}`);
  const uid = sel && sel.value ? sel.value : "";
  if(!uid){ alert("Vyberte ƒçlena"); return; }
  a.signups[role]=a.signups[role]||[];
  if(a.signups[role].includes(uid)){ alert("ƒålen u≈æ je p≈ôihl√°≈°en v t√©to roli"); return; }
  if(a.signups[role].length >= (a.capacity[role]||0)){ alert("Kapacita pro tuto roli je pln√°"); return; }
  a.signups[role].push(uid);
  save(DB_ACTIONS,ACTIONS);
  const userName=(getUserById(uid)||{}).name || uid;
  logActivity({ type:"assign", userId:uid, userName, roleKey:role, eventId:a.id, eventTitle:a.title });
  viewEvents();
}
function adminRemove(aid, role, uid){
  refreshStores();
  const a=ACTIONS.find(x=>x.id===aid); if(!a) return;
  a.signups[role]=(a.signups[role]||[]).filter(id=>id!==uid);
  save(DB_ACTIONS,ACTIONS);
  const userName=(getUserById(uid)||{}).name || uid;
  logActivity({ type:"remove", userId:uid, userName, roleKey:role, eventId:a.id, eventTitle:a.title });
  viewEvents();
}

// ---- Admin: maz√°n√≠ ud√°lost√≠ ----
function deleteEvent(aid){
  if(!confirm("Opravdu smazat tuto ud√°lost?")) return;
  refreshStores();
  const a=ACTIONS.find(x=>x.id===aid);
  ACTIONS = ACTIONS.filter(x=>x.id!==aid); save(DB_ACTIONS,ACTIONS);
  logActivity({ type:"deleteEvent", userId:ME.id, userName:ME.name, eventId:aid, eventTitle:a?a.title:"Ud√°lost" });
  viewEvents();
}

// ---- Admin: edit/create ----
function viewCreateEvent(editId){
  refreshStores();
  const a = editId ? ACTIONS.find(x=>x.id===editId) : null;
  const vals = (a||{});
  const app=$("#app");
  const pubs=getPublicRoleKeys();

  const toLocalDTVal = (d)=>{ if(!d) return ""; const Y=d.getFullYear(),M=String(d.getMonth()+1).padStart(2,"0"),D=String(d.getDate()).padStart(2,"0"),h=String(d.getHours()).padStart(2,"0"),m=String(d.getMinutes()).padStart(2,"0"); return `${Y}-${M}-${D}T${h}:${m}`; };
  const unlockVal = a && a.signupUnlock ? new Date(a.signupUnlock) : null;

  app.innerHTML = `
    <h3>${a?"Upravit ud√°lost":"Nov√° ud√°lost"}</h3>
    <div class="card">
      <div class="grid3">
        <input id="evTitle" class="input" placeholder="N√°zev" value="${a?vals.title:""}">
        <input id="evLocation" class="input" placeholder="M√≠sto" value="${a?vals.location:""}">
        <input id="evDate" class="input" type="date" value="${a?(vals.date||today()):today()}">
      </div>
      <div class="grid3" style="margin-top:8px">
        <input id="evFrom" class="input" type="time" value="${a?(vals.timeFrom||""): ""}">
        <input id="evTo"   class="input" type="time" value="${a?(vals.timeTo  ||""): ""}">
        <input id="evUnlock" class="input" type="datetime-local" value="${toLocalDTVal(unlockVal)}" placeholder="Odemknut√≠ p≈ôihla≈°ov√°n√≠">
      </div>
      <div class="grid3" style="margin-top:8px">
        ${pubs.map(r=>`
          <div>
            <div class="muted" style="font-size:12px">${roleLabel(r)}</div>
            <input id="cap_${r}" class="input" type="number" min="0" value="${a?(vals.capacity&&vals.capacity[r]||0):0}">
          </div>`).join("")}
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" onclick="viewEvents()">Zpƒõt</button>
        <button class="btn primary" onclick="${a?`saveEvent('${a.id}')`:`saveEvent(null)`}">Ulo≈æit</button>
      </div>
      <div class="muted" style="margin-top:6px;font-size:12px;color:red">NEZAPOME≈á NA POƒåTY ƒåLEN≈Æ.</div>
    </div>`;
}
function saveEvent(editId){
  refreshStores(); const pubs=getPublicRoleKeys();
  const title=($("#evTitle").value||"").trim(); if(!title){ alert("Zadejte n√°zev ud√°losti"); return; }
  const capacity={}; pubs.forEach(r=> capacity[r]=parseInt($("#cap_"+r).value||"0",10));
  const date = $("#evDate").value || today();
  const unlockInput = $("#evUnlock").value; const unlockIso = unlockInput ? new Date(unlockInput).toISOString() : null;

  let ev;
  if(editId){
    const old=ACTIONS.find(x=>x.id===editId) || {signups:{}};
    const signups={}; pubs.forEach(r=> signups[r]=(old.signups[r]||[]));
    ev = { id:editId, date, title, location:$("#evLocation").value||"", timeFrom:$("#evFrom").value||"", timeTo:$("#evTo").value||"", signupUnlock:unlockIso, capacity, signups, isPaid:(typeof old.isPaid==="boolean")?old.isPaid:false, adminNote:(typeof old.adminNote==="string")?old.adminNote:"" };
    ACTIONS = ACTIONS.map(x=> x.id===editId ? ev : x);
    save(DB_ACTIONS,ACTIONS);
    logActivity({ type:"updateEvent", userId:ME.id, userName:ME.name, eventId:ev.id, eventTitle:ev.title });
  }else{
    const signups={}; pubs.forEach(r=> signups[r]=[]);
    ev = { id:uid(), date, title, location:$("#evLocation").value||"", timeFrom:$("#evFrom").value||"", timeTo:$("#evTo").value||"", signupUnlock:unlockIso, capacity, signups, isPaid:false, adminNote:"" };
    ACTIONS = [ev, ...ACTIONS]; save(DB_ACTIONS,ACTIONS);
    logActivity({ type:"createEvent", userId:ME.id, userName:ME.name, eventId:ev.id, eventTitle:ev.title });
  }
  ME = getUserById(getSession()) || ME; ensureActiveRole(); viewEvents();
}

// ---- Members (admin) ----
function viewMembers(){
  try{
    refreshStores();
    const app=$("#app"); const roles=loadRoles()||[];
    const meIsSupport = isSupportUser(ME);

    const create = `
      <div class="card">
        <h4>Vytvo≈ôit ƒçlena</h4>
        <div class="grid2">
          <input id="newName" class="input" placeholder="Jm√©no">
          <div class="row">
            <input id="newPass" class="input" type="password" placeholder="Heslo" style="flex:1">
            <button class="btn" id="toggleNewPass">üëÅÔ∏è</button>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          ${roles.map(r=>`<label class="pill"><input type="checkbox" id="role_${r.key}"><span>${r.label}</span></label>`).join("")}
          ${meIsSupport ? `<label class="pill"><input type="checkbox" id="role_admin"><span>Admin</span></label>` : `<label class="pill"><input type="checkbox" id="role_admin" disabled title="Admin m≈Ø≈æe p≈ôidat jen Podpora"><span>Admin</span></label>`}
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn primary" onclick="createUser()">Vytvo≈ôit</button>
        </div>
      </div>`;

    const visibleUsers = meIsSupport ? USERS : USERS.filter(u=>!isSupportUser(u));
    const list = visibleUsers.map(u=>{
      const canSeePw = meIsSupport || !isSupportUser(u);
      const pwValue  = canSeePw ? (u.password||"") : "";
      const pwAttrs  = canSeePw ? "" : 'placeholder="********" disabled';
      const rid = "pw_"+u.id;
      const roleChk = (r)=>`<label class="pill"><input type="checkbox" id="edit_${u.id}_${r.key}" ${(u.roles||[]).includes(r.key)?"checked":""}><span>${r.label}</span></label>`;
      const adminChecked=(u.roles||[]).includes("admin");
      const adminChk = meIsSupport
        ? `<label class="pill"><input type="checkbox" id="edit_${u.id}_admin" ${adminChecked?"checked":""}><span>Admin</span></label>`
        : `<label class="pill"><input type="checkbox" id="edit_${u.id}_admin" ${adminChecked?"checked":""} disabled title="Admin m≈Ø≈æe mƒõnit jen Podpora"><span>Admin</span></label>`;
      const delBtn = isSupportUser(u) ? `<button class="btn danger" disabled title="√öƒçet Podpora nelze smazat">Smazat</button>` : `<button class="btn danger" onclick="deleteUser('${u.id}')">Smazat</button>`;
      return `
        <div class="card">
          <div class="grid2">
            <input id="name_${u.id}" class="input" value="${u.name||""}">
            <div class="row">
              <input id="${rid}" class="input" type="password" value="${pwValue}" ${pwAttrs} style="flex:1">
              ${canSeePw ? `<button class="btn" onclick="toggleInput('${rid}')">üëÅÔ∏è</button>` : ``}
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            ${roles.map(roleChk).join("")}
            ${adminChk}
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn" onclick="saveUser('${u.id}')">Ulo≈æit</button>
            ${delBtn}
          </div>
        </div>`;
    }).join("");

    app.innerHTML = `<h3>ƒålenov√©</h3>${create}${list || `<div class="card muted">≈Ω√°dn√≠ ƒçlenov√©.</div>`}`;
    const tnp=$("#toggleNewPass"); if(tnp) tnp.onclick=()=>toggleInput("newPass");
  }catch(err){ console.error("viewMembers() error:", err); alert("Chyba p≈ôi naƒç√≠t√°n√≠ ƒçlen≈Ø: "+(err?.message||err)); }
}
function toggleInput(id){ const i=document.getElementById(id); if(i) i.type=(i.type==="password"?"text":"password"); }
function createUser(){
  refreshStores();
  const roles=loadRoles()||[]; const name=($("#newName")?.value||"").trim(); const pass=($("#newPass")?.value||"");
  const meIsSupport=isSupportUser(ME);
  if(!name||!pass){ alert("Jm√©no a heslo jsou povinn√©"); return; }
  const roleKeys=roles.map(r=>r.key); let selected=roleKeys.filter(k=> $("#role_"+k)?.checked );
  if(meIsSupport && $("#role_admin")?.checked) selected.push("admin");
  if(!selected.length){ alert("Vyberte alespo≈à jednu roli"); return; }
  const u={ id:uid(), name, password:pass, roles:Array.from(new Set(selected)), isActive:true, passwordChangedAt:nowIso() };
  USERS.push(u); save(DB_USERS,USERS); alert("ƒålen vytvo≈ôen"); viewMembers();
}
function saveUser(uidx){
  try{
    refreshStores(); const rolesArr=loadRoles()||[]; const u=USERS.find(x=>x.id===uidx); if(!u){ alert("U≈æivatel nenalezen."); return; }
    const meIsSupport=isSupportUser(ME); const targetIsSupport=isSupportUser(u);
    const newName=($("#name_"+u.id)?.value||"").trim(); const pwEl=$("#pw_"+u.id); const newPass=pwEl?pwEl.value:"";
    const roleKeys=rolesArr.map(r=>r.key).concat(["admin"]); let selected=roleKeys.filter(k=> !!$("#edit_"+u.id+"_"+k)?.checked );
    if(!meIsSupport){ // bƒõ≈æn√Ω admin nesm√≠ mƒõnit admin roli
      if((u.roles||[]).includes("admin") && !selected.includes("admin")) selected.push("admin");
      if(!(u.roles||[]).includes("admin") && selected.includes("admin")) selected=selected.filter(r=>r!=="admin");
    }else{ // Podpora: √∫ƒçet Podpora v≈ædy support+admin
      if(targetIsSupport){ if(!selected.includes("support")) selected.push("support"); if(!selected.includes("admin")) selected.push("admin"); }
    }
    if(selected.length===0){ alert("U≈æivatel mus√≠ m√≠t alespo≈à jednu roli."); return; }
    u.name = newName || u.name;
    if(meIsSupport || !targetIsSupport){ if(newPass && newPass!==u.password){ u.password=newPass; u.passwordChangedAt=nowIso(); } }
    u.roles = selected; save(DB_USERS,USERS);
    if(ME && ME.id===u.id){ ME=u; setSession(ME.id); ensureActiveRole(); }
    alert("Ulo≈æeno"); viewMembers();
  }catch(err){ console.error("saveUser() error:", err); alert("Chyba p≈ôi ukl√°d√°n√≠ u≈æivatele: "+(err?.message||err)); }
}
function deleteUser(uidx){
  if(ME && ME.id===uidx){ alert("Nelze smazat s√°m sebe."); return; }
  refreshStores(); const u=getUserById(uidx); if(!u) return;
  if(isSupportUser(u)){ alert("U≈æivatel Podpora nem≈Ø≈æe b√Ωt smaz√°n."); return; }
  if((u.roles||[]).includes("admin")){ alert("U≈æivatel s rol√≠ Admin nem≈Ø≈æe b√Ωt smaz√°n."); return; }
  if(!confirm("Opravdu smazat ƒçlena?")) return;
  USERS = USERS.filter(x=>x.id!==uidx); save(DB_USERS,USERS);
  const pubs=getPublicRoleKeys(); ACTIONS.forEach(a=> pubs.forEach(r=>{ a.signups[r]=(a.signups[r]||[]).filter(id=>id!==uidx); })); save(DB_ACTIONS,ACTIONS);
  viewMembers();
}

// ---- Roles (admin) ----
const RESERVED_ROLE_KEYS=["admin","support"];
function viewRoles(){
  try{
    refreshStores(); const app=$("#app"); const roles=loadRoles()||[];
    const addForm = `
      <div class="card">
        <h4>P≈ôidat novou roli</h4>
        <div class="grid2">
          <label>Kl√≠ƒç (bez diakritiky):<input id="roleKey" class="input" placeholder="nap≈ô. koordinator"></label>
          <label>N√°zev (zobrazen√Ω):<input id="roleLabel" class="input" placeholder="Koordin√°tor"></label>
        </div>
        <label class="row" style="margin-top:6px"><input id="rolePublic" type="checkbox" checked> Ve≈ôejn√° role</label>
        <div class="row" style="justify-content:flex-end;margin-top:10px"><button class="btn primary" onclick="createRole()">P≈ôidat roli</button></div>
      </div>`;
    const list = roles.map(r=>{
      const isReserved=RESERVED_ROLE_KEYS.includes(r.key);
      return `<div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row" style="gap:12px">
            <span class="key">${r.key}</span>
            <input id="label_${r.key}" class="input" value="${r.label}" style="min-width:220px" ${isReserved?'disabled':''}>
            <label class="row"><input type="checkbox" id="pub_${r.key}" ${r.isPublic?"checked":""} ${isReserved?'disabled':''}> Ve≈ôejn√°</label>
          </div>
          <div class="row">
            <button class="btn" onclick="saveRole('${r.key}')" ${isReserved?'disabled title="Tuto roli nelze upravit"':''}>Ulo≈æit</button>
            <button class="btn danger" onclick="deleteRole('${r.key}')" ${isReserved?'disabled title="Tuto roli nelze smazat"':''}>Smazat</button>
          </div>
        </div>
      </div>`;
    }).join("");
    app.innerHTML = `<h3>Role</h3>${addForm}${list || `<div class="card muted">≈Ω√°dn√© role.</div>`}`;
  }catch(err){ console.error("viewRoles error:", err); alert("Chyba p≈ôi naƒç√≠t√°n√≠ rol√≠: "+(err?.message||err)); }
}
function createRole(){
  try{
    refreshStores();
    let key=slugify($("#roleKey")?.value||""); const label=($("#roleLabel")?.value||"").trim(); const isPublic=!!$("#rolePublic")?.checked;
    if(!key || !label){ alert("Vypl≈àte kl√≠ƒç i n√°zev role."); return; }
    if(RESERVED_ROLE_KEYS.includes(key)){ alert(`Kl√≠ƒç '${key}' je vyhrazen.`); return; }
    const roles=loadRoles(); if(roles.some(r=>r.key===key)){ alert("Tento kl√≠ƒç role u≈æ existuje."); return; }
    roles.push({ key,label,isPublic }); saveRoles(roles);
    const acts=load(DB_ACTIONS)||[]; acts.forEach(a=>{ a.capacity ||= {}; a.signups ||= {}; a.capacity[key]=0; a.signups[key]=[]; }); save(DB_ACTIONS,acts);
    toast("Role p≈ôid√°na", label); viewRoles();
  }catch(err){ console.error("createRole error:", err); alert("Chyba p≈ôi p≈ôid√°n√≠ role: "+(err?.message||err)); }
}
function saveRole(key){
  try{
    refreshStores(); const roles=loadRoles(); const r=roles.find(x=>x.key===key); if(!r) return;
    if(RESERVED_ROLE_KEYS.includes(key)){ alert("Tuto roli nelze upravit."); viewRoles(); return; }
    r.label=($("#label_"+key)?.value||r.label).trim(); r.isPublic=!!$("#pub_"+key)?.checked; saveRoles(roles);
    const pubs=getPublicRoleKeys(); const acts=load(DB_ACTIONS)||[];
    acts.forEach(a=>{ a.capacity ||= {}; a.signups ||= {}; pubs.forEach(k=>{ if(!(k in a.capacity)) a.capacity[k]=0; if(!(k in a.signups)) a.signups[k]=[]; }); Object.keys(a.capacity).forEach(k=>{ if(!pubs.includes(k)) delete a.capacity[k]; }); Object.keys(a.signups).forEach(k=>{ if(!pubs.includes(k)) delete a.signups[k]; }); });
    save(DB_ACTIONS,acts); toast("Role upravena", r.label); viewRoles();
  }catch(err){ console.error("saveRole error:", err); alert("Chyba p≈ôi ukl√°d√°n√≠ role: "+(err?.message||err)); }
}
function deleteRole(key){
  try{
    if(RESERVED_ROLE_KEYS.includes(key)){ alert("Tuto roli nelze smazat."); return; }
    if(!confirm("Opravdu smazat roli? Bude odebr√°na i z u≈æivatel≈Ø a ud√°lost√≠.")) return;
    refreshStores();
    const roles=(loadRoles()||[]).filter(r=>r.key!==key); saveRoles(roles);
    USERS.forEach(u=>{ u.roles=(u.roles||[]).filter(k=>k!==key); }); save(DB_USERS,USERS);
    const acts=load(DB_ACTIONS)||[]; acts.forEach(a=>{ if(a.capacity) delete a.capacity[key]; if(a.signups) delete a.signups[key]; }); save(DB_ACTIONS,acts);
    if(ACTIVE_ROLE===key){ ACTIVE_ROLE=null; ensureActiveRole(); }
    toast("Role smaz√°na", key); viewRoles(); renderHeader();
  }catch(err){ console.error("deleteRole error:", err); alert("Chyba p≈ôi maz√°n√≠ role: "+(err?.message||err)); }
}

// ---- Activity view ----
function viewActivity(){
  refreshStores();
  const app=$("#app"); const list=loadAct();
  const rows=list.slice().reverse().map(x=>{
    const who=x.userName || (getUserById(x.userId)?.name) || "u≈æivatel";
    const ev =x.eventTitle || (ACTIONS.find(a=>a.id===x.eventId)?.title) || "ud√°lost";
    const role=x.roleKey ? ` (${roleLabel(x.roleKey)})` : "";
    const date=new Date(x.ts).toLocaleString();
    const typeMap={join:"P≈ôihl√°≈°en√≠",leave:"Odhl√°≈°en√≠",assign:"P≈ôi≈ôazen√≠",remove:"Odebr√°n√≠",createEvent:"Vytvo≈ôen√≠",updateEvent:"√öprava",deleteEvent:"Smaz√°n√≠"};
    return `<tr><td>${date}</td><td>${typeMap[x.type]||x.type}</td><td>${who}</td><td>${ev}${role}</td></tr>`;
  }).join("");
  app.innerHTML = `
    <h3>Aktivita</h3>
    <div class="card" style="overflow:auto">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">ƒåas</th>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">Typ</th>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">Kdo</th>
            <th style="text-align:left;border-bottom:1px solid var(--border);padding:6px 4px;">Detail</th>
          </tr>
        </thead>
        <tbody>${rows || `<tr><td colspan="4" class="muted" style="padding:8px">≈Ω√°dn√© z√°znamy.</td></tr>`}</tbody>
      </table>
    </div>`;
}

// ---- Archiv & maz√°n√≠ archivovan√© akce ----
function archiveSweep(){
  refreshStores();
  let acts=load(DB_ACTIONS); let arc=loadArchive();
  const toMove=acts.filter(isPastEvent); if(!toMove.length) return;
  const keep=acts.filter(a=>!isPastEvent(a)); ACTIONS=keep; save(DB_ACTIONS,ACTIONS);
  const moved=toMove.slice().sort(sortEvents).reverse(); arc=[...moved,...arc]; saveArchive(arc);
  moved.forEach(a=> logActivity({ type:"archiveEvent", userId:ME?.id, userName:ME?.name, eventId:a.id, eventTitle:a.title }) );
}
function renderEventHistory(eventId, limit){
  const list=loadAct().filter(x=>x.eventId===eventId).slice(-limit);
  if(!list.length) return "";
  const items=list.map(x=>{
    const who=x.userName || (getUserById(x.userId)?.name) || "u≈æivatel";
    const role=x.roleKey ? ` (${roleLabel(x.roleKey)})` : "";
    const date=new Date(x.ts).toLocaleString();
    let txt=x.type;
    if(x.type==="join") txt=`p≈ôihl√°≈°en√≠${role}`;
    if(x.type==="leave") txt=`odhl√°≈°en√≠${role}`;
    if(x.type==="assign") txt=`p≈ôi≈ôazen${role}`;
    if(x.type==="remove") txt=`odebr√°n${role}`;
    if(x.type==="createEvent") txt=`vytvo≈ôen√≠ ud√°losti`;
    if(x.type==="updateEvent") txt=`√∫prava ud√°losti`;
    if(x.type==="deleteEvent") txt=`smaz√°n√≠ ud√°losti`;
    return `<li>${date}: <b>${who}</b> ‚Äì ${txt}</li>`;
  }).join("");
  return `<details class="admin-box"><summary><b>Historie ud√°losti</b></summary><ul class="list-plain" style="margin-top:8px">${items}</ul></details>`;
}
function viewPastEvents(){
  archiveSweep();
  const app=$("#app"); let arc=loadArchive();
  let fixed=false; arc.forEach(a=>{ if(typeof a.isPaid==="undefined"){a.isPaid=false;fixed=true;} if(typeof a.adminNote==="undefined"){a.adminNote="";fixed=true;} }); if(fixed) saveArchive(arc);
  if(!arc.length){ app.innerHTML = `<h3>Probƒõhl√© akce</h3><div class="card muted">Zat√≠m ≈æ√°dn√© probƒõhl√© akce.</div>`; return; }
  const cards = arc.map(a=>{
    const pubs=getPublicRoleKeys();
    const capHtml=pubs.map(r=>{ const list=a.signups?.[r]||[]; const names=list.map(id=> (getUserById(id)||{}).name).filter(Boolean).join(", "); const cap=a.capacity?.[r]??0; return `<li><b>${roleLabel(r)}</b>: ${list.length}/${cap} ‚Äî ${names||"‚Äî"}</li>`; }).join("");
    const paidBadge = (isMePrivileged() && a.isPaid) ? `<span class="badge" style="margin-left:8px;background:#ecfdf5;border-color:#10b981;color:#065f46">Zaplaceno</span>` : "";
    const payBox = isMePrivileged() ? `
      <div class="admin-box" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px"><input type="checkbox" id="paid_${a.id}" ${a.isPaid?'checked':''} onchange="togglePaid('${a.id}', this.checked, 'archive')"><b>Akce zaplacena</b></label>
          <button class="btn" onclick="saveAdminNote('${a.id}', 'archive')">Ulo≈æit pozn√°mku</button>
        </div>
        <textarea id="note_${a.id}" class="textarea" rows="2" placeholder="Pozn√°mka pro admina...">${a.adminNote||""}</textarea>
      </div>` : "";
    const evHistory = renderEventHistory(a.id,8);
    const adminBtns = isMePrivileged()? `<div class="row"><button class="btn danger" onclick="deleteArchivedEvent('${a.id}')">Smazat z archivu</button></div>`:"";
    return `<div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div><div style="font-weight:700">${a.title} ${paidBadge}</div><div class="muted">${fmtDate(a.date)} ‚Ä¢ ${a.location||"‚Äî"} ‚Ä¢ ${(a.timeFrom||"")}${a.timeTo?("‚Äì"+a.timeTo):""}</div></div>
        ${adminBtns}
      </div>
      <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>
      ${payBox}
      ${evHistory}
    </div>`;
  }).join("");
  app.innerHTML = `<h3>Probƒõhl√© akce</h3>${cards}`;
}
window.deleteArchivedEvent = function(aid){
  try{
    if(!confirm("Opravdu smazat tuto archivovanou akci?")) return;
    let arc=loadArchive(); const idx=arc.findIndex(x=>x.id===aid);
    if(idx<0){ alert("Akce v archivu nenalezena."); return; }
    const ev=arc[idx]; arc.splice(idx,1); saveArchive(arc);
    logActivity({ type:"deleteArchivedEvent", userId:ME?.id, userName:ME?.name, eventId:aid, eventTitle:ev?.title||"Ud√°lost" });
    toast("Archivovan√° akce smaz√°na", ev?.title||""); viewPastEvents();
  }catch(e){ console.error("deleteArchivedEvent error:", e); alert("Nepoda≈ôilo se smazat archivovanou akci."); }
};

// ---- Hlavn√≠ pohled Ud√°losti ----
function renderAdminManageBox(a, pubRoles){
  const removeBlocks = pubRoles.map(r=>{
    const list=a.signups[r]||[]; const items=list.map(uid=>{ const u=getUserById(uid); const nm=u?u.name:uid; return `<li>${nm} <button class="btn ghost danger" onclick="adminRemove('${a.id}','${r}','${uid}')">√ó</button></li>`; }).join("") || `<li class="muted">Nikdo</li>`;
    return `<div><b>${roleLabel(r)} ‚Äì odebrat:</b><ul class="list-plain">${items}</ul></div>`;
  }).join("");
  const assignForms = pubRoles.map(r=>{
    const signed=new Set(a.signups[r]||[]); const candidates=USERS.filter(u=> userHasRole(u,r) && !signed.has(u.id) ).map(u=> `<option value="${u.id}">${u.name}</option>`).join("");
    return `<div class="grid2" style="margin-top:6px"><div><label>P≈ôi≈ôadit jako ${roleLabel(r)}:
      <select id="assign_${a.id}_${r}" class="select"><option value="">‚Äî vyberte ƒçlena ‚Äî</option>${candidates}</select>
    </label></div><div class="row" style="justify-content:flex-end"><button class="btn" onclick="adminAssign('${a.id}','${r}')">P≈ôi≈ôadit</button></div></div>`;
  }).join("");
  return `<details class="admin-box"><summary><b>Spr√°va √∫ƒçasti (admin)</b></summary><div style="margin-top:8px">${removeBlocks}<hr style="border:none;border-top:1px solid var(--border);margin:10px 0">${assignForms}</div></details>`;
}
function viewEvents(){
  archiveSweep();
  const app=$("#app"); ensureActiveRole(); refreshStores(); const pubRoles=getPublicRoleKeys();
  const cards = ACTIONS.slice().sort(sortEvents).map(a=>{
    const capHtml = pubRoles.map(r=>{
      const list=a.signups[r]||[]; const names=list.map(id=> (getUserById(id)||{}).name ).filter(Boolean).join(", ");
      return `<li><b>${roleLabel(r)}</b>: ${list.length}/${a.capacity[r]||0} ‚Äî ${names||"‚Äî"}</li>`;
    }).join("");
    const payBox = isMePrivileged()? `
      <div class="admin-box" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px"><input type="checkbox" id="paid_${a.id}" ${a.isPaid?'checked':''} onchange="togglePaid('${a.id}', this.checked, 'active')"><b>Akce zaplacena</b></label>
          <button class="btn" onclick="saveAdminNote('${a.id}', 'active')">Ulo≈æit pozn√°mku</button>
        </div>
        <textarea id="note_${a.id}" class="textarea" rows="2" placeholder="Pozn√°mka pro admina...">${a.adminNote||""}</textarea>
      </div>` : "";
    const adminManage = userHasRole(ME,"admin") ? renderAdminManageBox(a, pubRoles) : "";
    const isOpen = getUnlockOpen(a);
    let actionBtn = "";
    if(!isOpen){
      const when = a.signupUnlock ? new Date(a.signupUnlock).toLocaleString() : "";
      actionBtn = `<span class="muted">P≈ôihla≈°ov√°n√≠ se otev≈ôe: <b>${when}</b></span>`;
    } else if(ACTIVE_ROLE){
      const myList=a.signups[ACTIVE_ROLE]||[]; const isIn=!!(ME && myList.includes(ME.id));
      actionBtn = isIn ? `<button class="btn danger" onclick="leaveEvent('${a.id}')">Odhl√°sit se</button>`
                       : ( (myList.length>=(a.capacity[ACTIVE_ROLE]||0)) ? `<span class="muted">Kapacita pro roli ${roleLabel(ACTIVE_ROLE)} je pln√°</span>` : `<button class="btn primary" onclick="joinEvent('${a.id}')">P≈ôihl√°sit se</button>` );
    } else actionBtn = `<span class="muted">Nem√°te vybranou ve≈ôejnou roli</span>`;
    const evHistory = renderEventHistory(a.id,5);
    return `<div class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div><div style="font-weight:700">${a.title}</div><div class="muted">${fmtDate(a.date)} ‚Ä¢ ${a.location||"‚Äî"} ‚Ä¢ ${(a.timeFrom||"")}${a.timeTo?("‚Äì"+a.timeTo):""}</div>${a.signupUnlock?`<div class="muted" style="font-size:12px">Odemknut√≠ p≈ôihla≈°ov√°n√≠: <b>${new Date(a.signupUnlock).toLocaleString()}</b></div>`:""}</div>
        <div class="row">${userHasRole(ME,"admin")?`<button class="btn" onclick="editEvent('${a.id}')">Upravit</button>`:""}${userHasRole(ME,"admin")?`<button class="btn danger" onclick="deleteEvent('${a.id}')">Smazat</button>`:""}</div>
      </div>
      <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>
      <div class="row" style="margin-top:8px">${actionBtn}</div>
      ${payBox}
      ${adminManage}
      ${evHistory}
    </div>`;
  }).join("");
  app.innerHTML = `<h3>Ud√°losti</h3>${cards || `<div class="card muted">≈Ω√°dn√© ud√°losti.</div>`}`;
}
function editEvent(id){ viewCreateEvent(id); }

// ---- Header / Login / Logout ----
function renderHeader(){
  const el=$("#hdr"); if(!ME){ el.innerHTML=""; return; }
  ensureActiveRole(); const prs=userPublicRoles(ME);
  const roleSel = (ACTIVE_ROLE && prs.length) ? `<select class="select" id="selActiveRole">${prs.map(r=>`<option value="${r}" ${r===ACTIVE_ROLE?"selected":""}>${roleLabel(r)}</option>`).join("")}</select>` : `<span class="muted">Bez ve≈ôejn√© role</span>`;
  el.innerHTML = `<div class="row">
    <span class="badge">${ME.name}</span>
    ${roleSel}
    ${userHasRole(ME,"admin") ? `<div class="menu" id="adminMenu">
      <button class="btn" id="adminBtn">Admin ‚ñæ</button>
      <div class="dropdown">
        <button onclick="viewEvents()">Ud√°losti</button>
        <button onclick="viewPastEvents()">Probƒõhl√© akce</button>
        <button onclick="viewMembers()">ƒålenov√©</button>
        <button onclick="viewRoles()">Role</button>
        <button onclick="viewActivity()">Aktivita</button>
        <button onclick="viewCreateEvent()">Nov√° ud√°lost</button>
        ${ isSupportUser(ME) ? `<button onclick="viewExport()">Export / Z√°loha</button>` : "" }
      </div>
    </div>` : ""}
    <button class="btn" onclick="logout()">Odhl√°sit</button>
  </div>`;
  const sel=$("#selActiveRole"); if(sel){ sel.onchange=()=>{ ACTIVE_ROLE=sel.value; renderApp(); }; }
  const menu=$("#adminMenu"); if(menu){ const btn=$("#adminBtn"); btn.addEventListener("click",(e)=>{e.stopPropagation();menu.classList.toggle("open");}); document.addEventListener("click",(e)=>{ if(!menu.contains(e.target)) menu.classList.remove("open"); }); }
}
function viewLogin(){
  const app=$("#app"); app.innerHTML = `
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>P≈ôihl√°≈°en√≠</h3>
      <input id="loginName" class="input" placeholder="Jm√©no">
      <div class="row" style="justify-content:space-between;width:100%">
        <input id="loginPass" class="input" type="password" placeholder="Heslo" style="flex:1">
        <button class="btn" id="togglePass">üëÅÔ∏è</button>
      </div>
      <button class="btn primary" id="btnLogin">P≈ôihl√°sit</button>
    </div>`;
  $("#togglePass").onclick=()=>{ const i=$("#loginPass"); i.type=(i.type==="password"?"text":"password"); };
  $("#btnLogin").onclick=()=>{
    refreshStores();
    const n=$("#loginName").value.trim(); const p=$("#loginPass").value;
    const u=USERS.find(x=>x.name===n && x.password===p && x.isActive!==false);
    if(!u){ alert("Neplatn√© √∫daje"); return; }
    ME=u; setSession(ME.id); ensureActiveRole(); startAdminWatcher(); renderApp();
  };
}
function logout(){ if(adminWatchTimer){ clearInterval(adminWatchTimer); adminWatchTimer=null; } setSession(null); ME=null; ACTIVE_ROLE=null; renderHeader(); viewLogin(); }
function renderApp(){ renderHeader(); viewEvents(); }

// ---- INIT ----
(async function init(){
  try{
    await Promise.race([ bootSync(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("bootSync timeout")),3000)) ]);
  }catch(_){}
  const sid=getSession(); if(sid){ ME=getUserById(sid); }
  archiveSweep();
  if(!ME){ renderHeader(); viewLogin(); } else { ensureActiveRole(); renderHeader(); startAdminWatcher(); viewEvents(); }
})();
</script>
</body>
</html>
