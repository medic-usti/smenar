<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smƒõn√°≈ô</title>

  <!-- Ponech√°me vzhled jednoduch√Ω; m≈Ø≈æe≈° si doplnit sv√© CSS -->
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; margin:0; padding:16px; background:#0b0f14; color:#e8eef7}
    header{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:12px; border:1px solid #1c2430; border-radius:10px; background:#0e141d; position:sticky; top:8px}
    h1{margin:0; font-size:16px}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:1px solid #1c2430; background:#101a28; color:#e8eef7; padding:6px 10px; border-radius:8px; cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.pri{background:#1c2b45; border-color:#2a3f62}
    input,select,textarea{background:#0c1421; color:#e8eef7; border:1px solid #1f2a3a; border-radius:8px; padding:6px 8px}
    textarea{min-height:80px}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px; margin-top:12px}
    .card{grid-column:span 12; background:#0e141d; border:1px solid #1c2430; border-radius:10px; padding:12px}
    .muted{color:#9aa4b2}
    .tag{display:inline-block; padding:2px 6px; border-radius:999px; border:1px solid #1c2430; font-size:12px; margin-right:6px; background:#162132}
    table{width:100%; border-collapse:collapse}
    th,td{padding:8px 6px; border-bottom:1px solid #1c2430; text-align:left}
    .right{justify-content:flex-end}
    .danger{background:#3a1616; border-color:#6b2a2a}
    @media (min-width:900px){
      .span6{grid-column:span 6}
      .span4{grid-column:span 4}
    }
    /* nen√°padn√° notifikace */
    #toast{position:fixed; bottom:16px; left:16px; background:#111720; border:1px solid #1c2430; color:#e8eef7; padding:8px 10px; border-radius:8px; display:none}
  </style>

  <!-- Supabase klient -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="row">
      <h1>üóìÔ∏è Smƒõn√°≈ô</h1>
      <span class="tag" id="roleTag" style="display:none">role: <span id="roleLabel">‚Äî</span></span>
      <span class="tag" id="userTag" style="display:none">u≈æivatel: <span id="userLabel">‚Äî</span></span>
    </div>
    <div class="row">
      <button class="btn" id="btnLogin">P≈ôihl√°sit</button>
      <button class="btn" id="btnLogout" style="display:none">Odhl√°sit</button>
      <button class="btn pri" id="btnNewEvent" style="display:none">+ Nov√° akce</button>
      <button class="btn" id="btnExport">üì§ Export</button>
      <button class="btn" id="btnImport">üì• Import</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
    </div>
  </header>

  <div class="grid">
    <section class="card span6" id="loginCard" style="display:none"></section>
    <section class="card span6" id="adminCard" style="display:none"></section>

    <section class="card" id="eventsUpcoming">
      <h3 style="margin:0 0 8px 0">Nadch√°zej√≠c√≠ akce</h3>
      <div id="upcomingList"></div>
    </section>

    <section class="card" id="eventsPast">
      <h3 style="margin:0 0 8px 0">Probƒõhl√© akce</h3>
      <div id="pastList"></div>
    </section>

    <section class="card span6" id="rolesCard">
      <h3 style="margin:0 0 8px 0">Role</h3>
      <div id="roleChips" class="row"></div>
      <div style="height:8px"></div>
      <div class="row">
        <input id="roleInput" placeholder="Nov√° role (nap≈ô. ≈òidiƒç)" />
        <button class="btn" id="addRoleBtn">P≈ôidat roli</button>
      </div>
    </section>

    <section class="card span6" id="activityCard">
      <h3 style="margin:0 0 8px 0">Aktivita</h3>
      <div id="activityList"></div>
    </section>
  </div>

  <div id="toast"></div>

<script>
/* ================================
   1) Supabase napojen√≠ (TV√â KL√çƒåE)
==================================*/
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcHlhdndoenB2ZGJ4ZGlkZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDQxNzYsImV4cCI6MjA3MjQyMDE3Nn0.baWqIwQrlz8KJ6CfOt7-md7FZvBDSXagFXNpHy_eOH4";
let sb = null;
try { sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }
catch(e){ console.warn("Supabase init failed", e); }

/* ================================
   2) Kl√≠ƒçe v KV / localStorage
==================================*/
const DB_USERS    = "smenar.users";
const DB_ROLES    = "smenar.roles";
const DB_ACTIONS  = "smenar.actions";
const DB_ACTIVITY = "smenar.activity";
const DB_ARCHIVE  = "smenar.actions.archive";
const SYNC_KEYS = [DB_USERS, DB_ROLES, DB_ACTIONS, DB_ACTIVITY, DB_ARCHIVE];

/* ================================
   3) Pomocn√© funkce
==================================*/
const $  = (sel)=>document.querySelector(sel);
const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
const uid = ()=>Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
const now = ()=>new Date();
const toDate = (s)=>new Date(s);
const toISO  = (localDT)=>{ if(!localDT) return ""; const d=new Date(localDT); const off=d.getTimezoneOffset(); return new Date(d.getTime()+off*60000).toISOString(); };
const toLocalDT = (iso)=>{ if(!iso) return ""; const d=new Date(iso); const off=d.getTimezoneOffset(); return new Date(d.getTime()-off*60000).toISOString().slice(0,16); };
const fmt = (s)=>new Date(s).toLocaleString("cs-CZ",{dateStyle:"short", timeStyle:"short"});
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; setTimeout(()=>t.style.display="none", 2000); }

/* ================================
   4) Cloud sync (Supabase KV)
==================================*/
async function kvUpsert(key, val){
  if(!sb) return;
  const { error } = await sb.from("kv").upsert({ key, val });
  if(error) console.warn("kvUpsert error", error);
}

async function bootSync(){
  if(!sb) return;
  const { data, error } = await sb.from("kv").select("key,val").in("key", SYNC_KEYS);
  if(error){ console.warn("bootSync error", error); return; }
  (data||[]).forEach(r=>{
    try{ localStorage.setItem(r.key, JSON.stringify(r.val ?? [])); }catch(_){}
  });
}

/* ================================
   5) Local API (load/save)
   - zachov√°me p≈Øvodn√≠ chov√°n√≠
   - save nav√≠c zapisuje do DB
==================================*/
const __loadLocal = (k)=>{ try{return JSON.parse(localStorage.getItem(k)||"[]")}catch(_){return []} };
const __saveLocal = (k,v)=>{ try{localStorage.setItem(k, JSON.stringify(v));}catch(_){} };

function load(k){ return __loadLocal(k); }
function save(k,v){ __saveLocal(k,v); kvUpsert(k,v); }

/* ================================
   6) Stav aplikace
==================================*/
let USERS=[], ROLES=[], ACTIONS=[], ACTIVITY=[], ARCHIVE=[];
let ME = null; // p≈ôihl√°≈°en√Ω u≈æivatel
let CURRENT_ROLE = null;

function getSession(){ try{return JSON.parse(localStorage.getItem("smenar.session")||"null")}catch(_){return null} }
function setSession(id){ localStorage.setItem("smenar.session", JSON.stringify(id)); }

/* ================================
   7) UI render
==================================*/
function ensureRoleSelected(){
  if(ME && (!CURRENT_ROLE || !ME.roles?.includes(CURRENT_ROLE))){
    CURRENT_ROLE = (ME.roles||[])[0] || null;
  }
  $("#roleTag").style.display = ME ? "" : "none";
  $("#userTag").style.display = ME ? "" : "none";
  $("#roleLabel").textContent = CURRENT_ROLE || "‚Äî";
  $("#userLabel").textContent = ME ? ME.name : "‚Äî";
}

function paintHeader(){
  $("#btnLogin").style.display  = ME? "none": "";
  $("#btnLogout").style.display = ME? "" : "none";
  $("#btnNewEvent").style.display = (ME && ME.isAdmin) ? "" : "none";
  ensureRoleSelected();
}

function renderLogin(){
  const card=$("#loginCard");
  card.style.display="block";
  const opts = USERS.map(u=>`<option value="${u.id}">${u.name}${u.isAdmin?' ‚Ä¢ admin':''}</option>`).join("");
  card.innerHTML = `
    <h3>P≈ôihl√°≈°en√≠</h3>
    <div class="row">
      <select id="loginSelect"><option value="">‚Äî vyber ‚Äî</option>${opts}</select>
      <button class="btn pri" id="doLogin">P≈ôihl√°sit</button>
    </div>
    <div style="height:8px"></div>
    <h4>Nov√Ω u≈æivatel</h4>
    <div class="row">
      <input id="newUserName" placeholder="Jm√©no" />
      <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="newUserAdmin" /> admin</label>
      <button class="btn" id="createUser">Vytvo≈ôit</button>
    </div>
  `;
  $("#doLogin").onclick = ()=>{
    const id=$("#loginSelect").value; if(!id) return;
    ME = USERS.find(u=>u.id===id)||null; setSession(ME?.id||null);
    ensureRoleSelected(); paintHeader(); hideLogin(); renderAll();
    act(`${ME.name} se p≈ôihl√°sil`);
  };
  $("#createUser").onclick = ()=>{
    const name = $("#newUserName").value.trim(); if(!name) return;
    const u = { id:uid(), name, isAdmin:$("#newUserAdmin").checked, roles:[] };
    USERS.push(u); save(DB_USERS, USERS); renderLogin(); renderUsersRoles();
  };
}
function hideLogin(){ $("#loginCard").style.display="none"; }

function renderUsersRoles(){
  const chips = $("#roleChips"); chips.innerHTML="";
  ROLES.forEach(r=>{
    const s=document.createElement("span"); s.className="tag"; s.textContent=r; chips.appendChild(s);
  });
}

function renderActivity(){
  const box=$("#activityList");
  box.innerHTML = ACTIVITY.slice(0,60).map(a=>(
    `<div class="row"><span class="muted">${fmt(a.ts)}</span> <span>${a.user} ‚Äî ${a.msg}</span></div>`
  )).join("");
}

function isPast(ev){ const end = toDate(ev.dateTo||ev.dateFrom||ev.date); return end < now(); }
function canSignup(ev){ if(!ev.signupOpenAt) return true; return now() >= toDate(ev.signupOpenAt); }

function renderEvents(){
  const up = ACTIONS.filter(a=>!isPast(a));
  const past = ACTIONS.filter(a=>isPast(a));

  function renderItem(ev){
    const cap = ev.capacity ? `<span class="tag">kapacita ${ev.attendees.length}/${ev.capacity}</span>` : "";
    const open = ev.signupOpenAt ? `<span class="tag" style="background:${canSignup(ev)?'#0f2a1b':'#2a2210'}">${canSignup(ev)?'p≈ôihl√°≈°en√≠ otev≈ôeno':('od '+fmt(ev.signupOpenAt))}</span>` : "";
    const meIn = !!(ME && ev.attendees.includes(ME.id));
    return `
      <div class="card" style="padding:10px">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <b>${ev.title}</b>
            <span class="tag">${fmt(ev.dateFrom)} ‚Üí ${fmt(ev.dateTo||ev.dateFrom)}</span>
            ${cap} ${open}
          </div>
          <div class="row">
            ${ME? `<button class="btn" data-join="${ev.id}" ${(!canSignup(ev) || (ev.capacity && ev.attendees.length>=ev.capacity) || meIn)?'disabled':''}>P≈ôihl√°sit</button>`:''}
            ${ME? `<button class="btn" data-leave="${ev.id}" ${meIn?'':'disabled'}>Odhl√°sit</button>`:''}
            ${ME&&ME.isAdmin? `<button class="btn" data-edit="${ev.id}">Upravit</button>`:''}
          </div>
        </div>
        <div class="muted" style="margin-top:6px">${ev.note||""}</div>
        <div class="muted" style="margin-top:6px">P≈ôihl√°≈°eni: ${(ev.attendees.map(id=>USERS.find(u=>u.id===id)?.name||'??').join(', '))||'‚Äî'}</div>
      </div>
    `;
  }

  $("#upcomingList").innerHTML = up.map(renderItem).join("") || "<div class='muted'>≈Ω√°dn√© nadch√°zej√≠c√≠ akce</div>";
  $("#pastList").innerHTML     = past.map(renderItem).join("") || "<div class='muted'>≈Ω√°dn√© probƒõhl√© akce</div>";

  $$("#upcomingList [data-join],#pastList [data-join]").forEach(b=>b.onclick=()=>joinEvent(b.dataset.join));
  $$("#upcomingList [data-leave],#pastList [data-leave]").forEach(b=>b.onclick=()=>leaveEvent(b.dataset.leave));
  $$("#upcomingList [data-edit],#pastList [data-edit]").forEach(b=>b.onclick=()=>editEvent(b.dataset.edit));
}

/* ================================
   8) Akce CRUD
==================================*/
function joinEvent(id){
  if(!ME) return; const ev=ACTIONS.find(x=>x.id===id); if(!ev) return;
  if(ev.capacity && ev.attendees.length>=ev.capacity){ toast("Kapacita pln√°"); return; }
  if(ev.attendees.includes(ME.id)) return;
  ev.attendees.push(ME.id); save(DB_ACTIONS, ACTIONS); renderEvents(); act(`${ME.name} se p≈ôihl√°sil na ${ev.title}`);
}
function leaveEvent(id){
  if(!ME) return; const ev=ACTIONS.find(x=>x.id===id); if(!ev) return;
  ev.attendees = ev.attendees.filter(x=>x!==ME.id); save(DB_ACTIONS, ACTIONS); renderEvents(); act(`${ME.name} se odhl√°sil z ${ev.title}`);
}

function newEvent(){ editEvent(null); }
function editEvent(id){
  const isNew = !id;
  const ev = isNew ? { id:uid(), title:"", dateFrom:new Date().toISOString(), dateTo:new Date().toISOString(), signupOpenAt:"", capacity:null, note:"", attendees:[] }
                   : (ACTIONS.find(x=>x.id===id));

  const dlg = document.createElement("div");
  dlg.className="card";
  dlg.style.position="fixed"; dlg.style.top="50%"; dlg.style.left="50%"; dlg.style.transform="translate(-50%,-50%)";
  dlg.style.zIndex="10"; dlg.style.minWidth="min(640px,96vw)";
  dlg.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">${isNew?"+ Nov√° akce":"Upravit akci"}</h3>
      <button class="btn" id="x">‚úñ</button>
    </div>
    <div class="row" style="flex-wrap:wrap; gap:8px; margin-top:8px">
      <label> N√°zev<br><input id="fTitle" value="${ev.title}"></label>
      <label> Od<br><input type="datetime-local" id="fFrom" value="${toLocalDT(ev.dateFrom)}"></label>
      <label> Do<br><input type="datetime-local" id="fTo" value="${toLocalDT(ev.dateTo)}"></label>
      <label> P≈ôihla≈°ov√°n√≠ od<br><input type="datetime-local" id="fOpen" value="${toLocalDT(ev.signupOpenAt)}"></label>
      <label> Kapacita<br><input type="number" id="fCap" min="0" step="1" value="${ev.capacity||''}"></label>
    </div>
    <div style="margin-top:8px">
      <label>Pozn√°mka<br><textarea id="fNote">${ev.note||""}</textarea></label>
    </div>
    <div class="row right" style="margin-top:10px">
      ${!isNew?`<button class="btn danger" id="del">Smazat</button>`:""}
      <button class="btn pri" id="ok">Ulo≈æit</button>
    </div>
  `;
  document.body.appendChild(dlg);

  $("#x").onclick = ()=>dlg.remove();
  $("#del") && ($("#del").onclick = ()=>{
    if(confirm("Smazat akci?")){
      ACTIONS = ACTIONS.filter(x=>x.id!==ev.id);
      save(DB_ACTIONS, ACTIONS); dlg.remove(); renderEvents(); act(`Smaz√°na akce ${ev.title}`);
    }
  });
  $("#ok").onclick = ()=>{
    ev.title = $("#fTitle").value.trim();
    ev.dateFrom = toISO($("#fFrom").value);
    ev.dateTo   = toISO($("#fTo").value);
    ev.signupOpenAt = toISO($("#fOpen").value);
    ev.capacity = Number($("#fCap").value||0)||null;
    ev.note = $("#fNote").value.trim();
    if(isNew) ACTIONS.push(ev);
    save(DB_ACTIONS, ACTIONS); dlg.remove(); renderEvents(); act(`${isNew?"Vytvo≈ôena":"Upravena"} akce ${ev.title}`);
  };
}

/* ================================
   9) Aktivita
==================================*/
function act(msg){
  ACTIVITY.unshift({ ts:new Date().toISOString(), user:ME?ME.name:"‚Äî", msg });
  save(DB_ACTIVITY, ACTIVITY);
  renderActivity();
}

/* ================================
   10) Admin panel
==================================*/
function renderAdmin(){
  const box=$("#adminCard");
  if(!ME || !ME.isAdmin){ box.style.display="none"; return; }
  box.style.display="block";

  const usersHtml = USERS.map(u=>`<tr>
    <td>${u.name}</td>
    <td>${u.isAdmin? "admin":"‚Äî"}</td>
    <td>${(u.roles||[]).join(", ")||"‚Äî"}</td>
    <td>
      <button class="btn" data-roles="${u.id}">Role</button>
      <button class="btn danger" data-deluser="${u.id}">Smazat</button>
    </td>
  </tr>`).join("");

  box.innerHTML = `
    <h3 style="margin:0 0 8px 0">Admin</h3>
    <div class="row"><b>${USERS.length}</b><span class="muted">u≈æivatel≈Ø</span></div>
    <div style="height:8px"></div>
    <div class="row">
      <button class="btn pri" id="adminNewEvent">+ Nov√° akce</button>
    </div>
    <div style="height:8px"></div>
    <table>
      <thead><tr><th>Jm√©no</th><th>Admin</th><th>Role</th><th></th></tr></thead>
      <tbody>${usersHtml}</tbody>
    </table>
  `;
  $("#adminNewEvent").onclick = ()=>newEvent();
  $$("#adminCard [data-roles]").forEach(b=>b.onclick=()=>editUserRoles(b.dataset.roles));
  $$("#adminCard [data-deluser]").forEach(b=>b.onclick=()=>delUser(b.dataset.deluser));
}
function delUser(id){
  if(!confirm("Smazat u≈æivatele?")) return;
  USERS = USERS.filter(u=>u.id!==id);
  save(DB_USERS, USERS); renderAll();
}
function editUserRoles(id){
  const u = USERS.find(x=>x.id===id); if(!u) return;
  const dlg=document.createElement("div");
  dlg.className="card";
  dlg.style.position="fixed"; dlg.style.top="50%"; dlg.style.left="50%"; dlg.style.transform="translate(-50%,-50%)";
  dlg.style.zIndex="10"; dlg.style.minWidth="min(520px,96vw)";
  const boxes = ROLES.map(r=>{
    const chk = (u.roles||[]).includes(r) ? "checked" : "";
    return `<label style="display:flex;align-items:center;gap:6px"><input type="checkbox" value="${r}" ${chk}/> ${r}</label>`;
  }).join("");
  dlg.innerHTML = `
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">Role: ${u.name}</h3>
      <button class="btn" id="x">‚úñ</button>
    </div>
    <div class="row" style="flex-direction:column; gap:6px; margin-top:8px">${boxes || '<div class="muted">≈Ω√°dn√© role</div>'}</div>
    <div class="row right" style="margin-top:10px"><button class="btn pri" id="ok">Ulo≈æit</button></div>
  `;
  document.body.appendChild(dlg);
  $("#x").onclick=()=>dlg.remove();
  $("#ok").onclick=()=>{
    const sel = Array.from(dlg.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
    u.roles = sel; save(DB_USERS, USERS); dlg.remove(); renderAll(); act(`Upraveny role: ${u.name}`);
  };
}

/* ================================
   11) Export / Import
==================================*/
$("#btnExport").onclick = ()=>{
  const payload = { USERS, ROLES, ACTIONS, ACTIVITY, ARCHIVE, exportedAt:new Date().toISOString() };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="smenar_export.json"; a.click();
};
$("#btnImport").onclick = ()=>$("#importFile").click();
$("#importFile").onchange = async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  try{
    const txt = await file.text(); const d=JSON.parse(txt);
    USERS=d.USERS||USERS; ROLES=d.ROLES||ROLES; ACTIONS=d.ACTIONS||ACTIONS; ACTIVITY=d.ACTIVITY||ACTIVITY; ARCHIVE=d.ARCHIVE||ARCHIVE;
    save(DB_USERS, USERS); save(DB_ROLES, ROLES); save(DB_ACTIONS, ACTIONS); save(DB_ACTIVITY, ACTIVITY); save(DB_ARCHIVE, ARCHIVE);
    renderAll(); toast("Import hotov");
  }catch(err){ alert("Import selhal: "+err.message); }
};

/* ================================
   12) Render glue
==================================*/
function renderAll(){ paintHeader(); renderUsersRoles(); renderAdmin(); renderEvents(); renderActivity(); }
$("#btnLogin").onclick = ()=>renderLogin();
$("#btnLogout").onclick = ()=>{ ME=null; setSession(null); renderAll(); };
$("#btnNewEvent").onclick = ()=>newEvent();

/* ================================
   13) INIT (nejd≈ô√≠v st√°hnout DB ‚Üí local)
==================================*/
(async function init(){
  try{
    // 1) st√°hnout z DB do localStorage (neblokujeme donekoneƒçna)
    await Promise.race([
      bootSync(),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error("bootSync timeout")), 3000))
    ]);
  }catch(_){ /* pokraƒçujeme i bez DB */ }

  // 2) naƒç√≠st data do pamƒõti
  USERS = load(DB_USERS); ROLES = load(DB_ROLES); ACTIONS = load(DB_ACTIONS); ACTIVITY = load(DB_ACTIVITY); ARCHIVE = load(DB_ARCHIVE);

  // 3) seed pro pr√°zdn√° data (jen poprv√©)
  if(USERS.length===0){
    USERS = [
      {id:uid(), name:"Admin",  isAdmin:true,  roles:["≈òidiƒç","ZZA"]},
      {id:uid(), name:"Tester", isAdmin:false, roles:["ZZA"]}
    ]; save(DB_USERS, USERS);
  }
  if(ROLES.length===0){ ROLES=["≈òidiƒç","ZZA","Podpora"]; save(DB_ROLES, ROLES); }
  if(ACTIONS.length===0){
    const t1 = new Date(Date.now()+86400000).toISOString();
    const t2 = new Date(Date.now()+90000000).toISOString();
    ACTIONS=[{id:uid(), title:"Cviƒçen√≠ TCCC", dateFrom:t1, dateTo:t2, signupOpenAt:"", capacity:6, note:"Praktick√© drilly", attendees:[]}];
    save(DB_ACTIONS, ACTIONS);
  }

  // 4) session + render
  const sid = getSession(); if(sid) ME = USERS.find(u=>u.id===sid)||null;
  renderAll();
})();
</script>
</body>
</html>
