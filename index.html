<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <title>Smƒõn√°≈ô - Medic √öst√≠ nad Labem</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .textarea{min-height:64px;resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    details summary{cursor:pointer; user-select:none; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .admin-box{border:1px dashed var(--border); border-radius:10px; padding:10px; margin-top:10px; background:#fafbff}
    .pub-box{border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}
    .db-ind{position:fixed;right:12px;bottom:12px;z-index:60;background:#111827;color:#fff;border-radius:10px;padding:8px 10px;font-size:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08)}
    .db-dot{width:8px;height:8px;border-radius:999px;background:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
    .db-dot.ok{background:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,.25)}
    .db-muted{color:#cbd5e1}
    .event-mine{border-color:#10b981 !important;box-shadow:0 8px 30px rgba(16,185,129,.25)}
    .mine-pill{background:#ecfdf5;border-color:#10b981;color:#065f46;font-weight:600}
    #err {position:fixed;left:12px;right:12px;bottom:68px;z-index:70;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;display:none}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin:2px 4px;background:#fff}
    .chip .x{border:0;background:transparent;cursor:pointer;font-weight:700}
    .small{font-size:12px}
    .paid{background:#ecfdf5;border-color:#10b981;color:#065f46}
    .prewrap{white-space:pre-wrap; word-break:break-word}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border:1px solid var(--border); padding:6px 8px; text-align:left}
    .table th{background:#f8fafc}

    /* ==== PUSH-UP MODAL - mobile friendly ==== */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(15,23,42,.45);
      display:none; align-items:flex-end; z-index:80;
      height:100dvh; overflow:hidden;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      background:#fff; border-top-left-radius:14px; border-top-right-radius:14px;
      width:100%; max-width:1100px; margin:0 auto; padding:0;
      box-shadow:0 -12px 30px rgba(0,0,0,.15);
      animation:slideUp .18s ease-out;
      max-height:calc(100dvh - 12px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      overscroll-behavior:contain;
      touch-action:pan-y;
    }
    @keyframes slideUp{ from{ transform:translateY(30px); opacity:.8 } to{ transform:translateY(0); opacity:1 } }
    .modal-header{
      position:sticky; top:0; z-index:1;
      background:#fff; border-bottom:1px solid var(--border);
      padding:12px 16px;
    }
    .modal-body{ padding:12px 16px 16px 16px; }

    /* Jedno≈ô√°dkov√© akce v mƒõs√≠ƒçn√≠m listu */
    .event-row{
      display:grid; grid-template-columns: 90px 1fr auto; gap:10px; padding:10px 12px; border-bottom:1px solid var(--border);
      cursor:pointer; background:#fff; transition:background .15s ease;
    }
    .event-row:hover{ background:#f8fafc; }
    .event-row.mine-row{ background:#ecfdf5; }
    .event-row.mine-row:hover{ background:#d1fae5; }
    .event-date{font-weight:600; white-space:nowrap;}
    .event-title{font-weight:600;}
    .event-meta{color:var(--muted); font-size:12px;}
    .month-header{margin-top:12px; font-weight:800; font-size:18px; padding:8px 4px;}

    /* Obsazenost per role (na ≈ô√°dku) */
    .occ-wrap{display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end}
    .occ-role{font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; background:#fff}
    .occ-ok{color:#6b7280}
    .occ-missing{color:#b91c1c; border-color:#fecaca; background:#fef2f2; font-weight:600}
  </style>
</head>
<body>
  <div id="dbInd" class="db-ind" title="Stav datab√°ze">
    <span id="dbDot" class="db-dot"></span>
    <span><b>DB:</b> <span id="dbState">Offline</span></span>
    <span class="db-muted">‚Ä¢</span>
    <span class="db-muted">naposledy: <span id="dbLast">‚Äî</span></span>
  </div>
  <div id="err"></div>

  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>

  <main><div id="app"></div></main>
  <div class="toast-wrap" id="toasts"></div>

  <!-- PUSH-UP MODAL -->
  <div id="modalBackdrop" class="modal-backdrop" onclick="if(event.target.id==='modalBackdrop'){closeEventModal()}">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="evModalTitle">
      <div class="modal-header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="evModalTitle" style="margin:0">Ud√°lost</h3>
          <button class="btn" type="button" onclick="closeEventModal()">Zav≈ô√≠t</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="evModalContent"></div>
      </div>
    </div>
  </div>

  <script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

/* ===== Supabase ===== */
const SUPABASE_URL = "https://lqpyavwhzpvdbxdidfry.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcHlhdndoenB2ZGJ4ZGlkZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NDQxNzYsImV4cCI6MjA3MjQyMDE3Nn0.baWqIwQrlz8KJ6CfOt7-md7FZvBDSXagFXNpHy_eOH4";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== Stav ===== */
const DB_USERS="users", DB_ACTIONS="actions", DB_ROLES="roles", DB_SESSION="session", DB_ACTIVITY="activity", DB_ARCHIVE="archive", DB_FORCED="forced";
let USERS=[], ACTIONS=[], ROLES=[], ACTIVITY=[], ARCHIVE=[], FORCED=[];
let ME=null, ACTIVE_ROLE=null;
let CURRENT_VIEW='events', CURRENT_EDIT_ID=null;
let DUPLICATE_PREFILL=null;
let DB_ONLINE=false, DB_LAST_TS=0, DB_LAST_SRC='‚Äî';

const $=s=>document.querySelector(s);
const today=()=>new Date().toISOString().slice(0,10);
const nowMs=()=>Date.now();
const uid=()=>crypto.randomUUID?crypto.randomUUID():('id'+Date.now()+Math.random().toString(16).slice(2));

function h(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function toast(msg,sub){ const w=$('#toasts'); const d=document.createElement('div'); d.className='toast'; d.innerHTML=`<div>${msg}</div>${sub? `<small>${sub}</small>`:''}`; w.appendChild(d); setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(8px)'; d.style.transition='all .25s'; setTimeout(()=>w.removeChild(d),260); },3000); }
function fmtDMy(dStr){
  const d=new Date((dStr||'')+'T00:00:00');
  if(isNaN(d)) return dStr||'';
  return `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
}

function confirmAndAssign(aid, roleKey, uid){
  if(!isPrivileged()) return;
  const a = ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid);
  if(!a) return;

  const user = getUserById?.(uid);
  const role = roleLabel?.(roleKey) || roleKey;
  const title = a?.title || 'Ud√°lost';
  const dmy = fmtDMy(a?.date);
  const name = user?.name || uid;

  // stejn√© "vyskakovac√≠ okno" jako u alertu ‚Äì jen s potvrzen√≠m OK/Zru≈°it
  const ok = confirm(`Opravdu p≈ôi≈ôadit ‚Äû${name}‚Äú do role ‚Äû${role}‚Äú k ud√°losti ‚Äû${title}‚Äú (${dmy})?`);
  if(ok) assignMember(aid, roleKey, uid);
}

function showErr(msg){ const el=document.getElementById('err'); el.textContent=String(msg); el.style.display='block'; console.error(msg); }
window.addEventListener('error', (e)=>{ showErr(e.message || 'Nezn√°m√° chyba'); });
window.addEventListener('unhandledrejection', (e)=>{ showErr(e.reason?.message || e.reason || 'Nezachycen√© odm√≠tnut√≠ Promise'); });

function fmtAgo(ts){ if(!ts) return "‚Äî"; const s=Math.max(0,Math.floor((Date.now()-ts)/1000)); if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m ${s%60}s`; const h=Math.floor(m/60); return `${h}h ${m%60}m`; }
function fmtAbs(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return "‚Äî"; } }
function renderDbInd(){ const dot=$('#dbDot'), st=$('#dbState'), last=$('#dbLast'); st.textContent=DB_ONLINE?'Online':'Offline'; dot.classList.toggle('ok', DB_ONLINE); last.textContent=`${fmtAgo(DB_LAST_TS)} (${DB_LAST_SRC})`; const wrap=$('#dbInd'); if(wrap) wrap.title=`DB: ${DB_ONLINE?'Online':'Offline'} ‚Ä¢ naposledy: ${fmtAbs(DB_LAST_TS)} (${DB_LAST_SRC})`; }
setInterval(renderDbInd,1000);

/* ===== KV helpery ===== */
async function kvLoad(key){
  const {data, error} = await supabase.from('kv').select('data').eq('key', key).single();
  if(error && error.code!=='PGRST116') throw error;
  return data?.data ?? [];
}
async function kvSave(key, value){
  const { error } = await supabase.from('kv').upsert({ key, data: value, updated_at: new Date().toISOString() });
  if(error) throw error;
  DB_ONLINE = true; DB_LAST_TS = Date.now(); DB_LAST_SRC='save';
}

/* ===== Realtime + watchdog ===== */
let _lastRealtime = Date.now();
function subscribeRealtime(){
  supabase
    .channel('kv-realtime')
    .on('postgres_changes', { event:'*', schema:'public', table:'kv',
      filter:"key=in.(users,roles,actions,archive,activity,forced)" }, (payload)=>{
        const row=payload.new || payload.old;
        if(!row?.key) return;
        if(CURRENT_VIEW==='create' || CURRENT_VIEW==='login') return;
        const arr=row.data||[];
        switch(row.key){
          case DB_USERS:USERS=arr;break;
          case DB_ROLES:ROLES=arr;break;
          case DB_ACTIONS:ACTIONS=arr;break;
          case DB_ARCHIVE:ARCHIVE=arr;break;
          case DB_ACTIVITY:ACTIVITY=arr;break;
          case DB_FORCED:FORCED=arr;break;
        }
        DB_ONLINE=true; DB_LAST_TS=Date.now(); DB_LAST_SRC='realtime';
        _lastRealtime=Date.now();
        renderApp();
        checkForcedLogout();
    }).subscribe(st=>{
      DB_ONLINE=(st==='SUBSCRIBED'); DB_LAST_TS=Date.now(); DB_LAST_SRC='sub'; _lastRealtime=Date.now();
    });

  setInterval(()=>{
    const FIVE_MIN=5*60*1000;
    if(Date.now()-_lastRealtime>FIVE_MIN && CURRENT_VIEW!=='login' && CURRENT_VIEW!=='create'){
      refreshFromDB().catch(()=>{});
      _lastRealtime=Date.now();
    }
  }, 60*1000);
}

const _eq=(a,b)=>JSON.stringify(a)===JSON.stringify(b);
async function refreshFromDB(){
  try{
    const [u,r,a,ar,ac,fo]=await Promise.all([
      kvLoad(DB_USERS),kvLoad(DB_ROLES),kvLoad(DB_ACTIONS),kvLoad(DB_ARCHIVE),kvLoad(DB_ACTIVITY),kvLoad(DB_FORCED)
    ]);
    let changed=false;
    if(!_eq(USERS,u)){USERS=u;changed=true;}
    if(!_eq(ROLES,r)){ROLES=r;changed=true;}
    if(!_eq(ACTIONS,a)){ACTIONS=a;changed=true;}
    if(!_eq(ARCHIVE,ar)){ARCHIVE=ar;changed=true;}
    if(!_eq(ACTIVITY,ac)){ACTIVITY=ac;changed=true;}
    if(!_eq(FORCED,fo)){FORCED=fo;changed=true;}
    if(changed){ DB_ONLINE=true; DB_LAST_TS=Date.now(); DB_LAST_SRC='fallback'; renderApp(); checkForcedLogout(); }
  }catch(err){
    console.warn('fallback refresh error',err);
    DB_ONLINE=false; DB_LAST_TS=Date.now(); DB_LAST_SRC='fallback-error';
  }
}

/* ===== Seed & init ===== */
async function seedIfEmpty(){
  let changed=false;

  if(!ROLES.length){
    ROLES=[
      {key:'ridic',label:'≈òidiƒç',isPublic:true},
      {key:'zza',label:'ZZA',isPublic:true},
      {key:'zdravotnik',label:'Zdravotn√≠k',isPublic:true},
      {key:'admin',label:'Admin',isPublic:false},
      {key:'support',label:'Podpora',isPublic:false}
    ];
    await kvSave(DB_ROLES,ROLES); changed=true;
  }

  if(!USERS.length){
    USERS=[
      {id:'u1',name:'Podpora',password:'support',roles:['support','admin'],isActive:true},
      {id:'u2',name:'admin',password:'1111',roles:['admin'],isActive:true},
    ];
    await kvSave(DB_USERS,USERS); changed=true;
  }

  if(!ARCHIVE.length){ await kvSave(DB_ARCHIVE,[]); changed=true; }
  if(!ACTIVITY.length){ await kvSave(DB_ACTIVITY,[]); changed=true; }
  if(!FORCED.length){ await kvSave(DB_FORCED,[]); changed=true; }

  if(changed){ DB_LAST_SRC='seed'; DB_LAST_TS=Date.now(); }
}

async function ensureCoreRoles(){
  const must=[
    {key:'admin',label:'Admin',isPublic:false},
    {key:'support',label:'Podpora',isPublic:false},
    {key:'ridic',label:'≈òidiƒç',isPublic:true},
    {key:'zza',label:'ZZA',isPublic:true},
    {key:'zdravotnik',label:'Zdravotn√≠k',isPublic:true}
  ];
  let changed=false;
  for(const r of must){ if(!ROLES.find(x=>x.key===r.key)){ ROLES.push(r); changed=true; } }
  if(changed) await kvSave(DB_ROLES,ROLES);
}
async function init(){
  try{
    [USERS,ROLES,ACTIONS,ARCHIVE,ACTIVITY,FORCED]=await Promise.all([
      kvLoad(DB_USERS),kvLoad(DB_ROLES),kvLoad(DB_ACTIONS),kvLoad(DB_ARCHIVE),kvLoad(DB_ACTIVITY),kvLoad(DB_FORCED)
    ]);
    DB_ONLINE=true; DB_LAST_TS=Date.now(); DB_LAST_SRC='init';
    await seedIfEmpty(); await ensureCoreRoles();
    subscribeRealtime();
    renderApp();
    checkForcedLogout();
  }catch(e){
    showErr('Chyba p≈ôipojen√≠ k DB: '+(e.message||e));
    DB_ONLINE=false; DB_LAST_TS=Date.now(); DB_LAST_SRC='error';
  }
}

/* ===== Role/Pr√°va ===== */
function userHasRole(u,r){ return (u?.roles||[]).includes(r); }
function isSupportUser(u){ return !!u && ((u.roles||[]).includes('support') || ((u?.name||'').trim().toLowerCase()==='podpora')); }
function isPrivileged(){ return ME && (userHasRole(ME,'admin') || userHasRole(ME,'support')); }
function getPublicRoleKeys(){ return (ROLES||[]).filter(r=>r.isPublic).map(r=>r.key); }
function roleLabel(k){ return (ROLES||[]).find(r=>r.key===k)?.label||k; }
function getUserById(id){ return (USERS||[]).find(u=>u.id===id)||null; }
function userPublicRoles(u){ const pubs=getPublicRoleKeys(); return (u?.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){ if(!ME){ACTIVE_ROLE=null;return;} const prs=userPublicRoles(ME); if(!prs.length){ACTIVE_ROLE=null;return;} if(!ACTIVE_ROLE||!prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE=prs[0]; }
function canSeeRoleKey(key){ return !(key==='support' && !isSupportUser(ME)); }
function canSeeRoleObj(r){ return canSeeRoleKey(r?.key); }
function canSeeUser(u){ if(isSupportUser(ME)) return true; return !userHasRole(u,'support'); }

/* ===== Aktivita ===== */
async function logActivity(type, eventId, eventTitle, detail, eventDate){
 ACTIVITY.push({
 ts: Date.now(),
 type,
 eventId,
 eventTitle,
 eventDate: eventDate || null,
 detail,
 userId: ME?.id,
 userName: ME?.name
 });
  await kvSave(DB_ACTIVITY, ACTIVITY);
}

/* >>> Login/Logout helpery <<< */
function lastLoginTsForUser(uid){
  let ts=0;
  for(const a of ACTIVITY){ if(a.userId===uid && a.type==='login' && a.ts>ts) ts=a.ts; }
  return ts||null;
}
function lastLogoutTsForUser(uid){
  let ts=0;
  for(const a of ACTIVITY){ if(a.userId===uid && a.type==='logout' && a.ts>ts) ts=a.ts; }
  return ts||null;
}
function isUserCurrentlyLogged(uid){
  const li = lastLoginTsForUser(uid);
  const lo = lastLogoutTsForUser(uid);
  const logged = !!li && (!lo || li > lo);
  return { logged, since: logged ? li : null };
}

/* ===== Force logout klienta ===== */
let LAST_FORCED_TS = parseInt(localStorage.getItem('lastForcedTs')||'0',10);
function latestForcedFor(uid){
  const hits = (FORCED||[]).filter(f=>f && f.uid===uid);
  if(!hits.length) return 0;
  return Math.max(...hits.map(f=>parseInt(f.ts||0,10)).filter(n=>!isNaN(n)));
}
function checkForcedLogout(){
  if(!ME) return;
  const ts = latestForcedFor(ME.id);
  if(ts>LAST_FORCED_TS){
    LAST_FORCED_TS = ts;
    localStorage.setItem('lastForcedTs', String(LAST_FORCED_TS));
    alert('Byl jste odhl√°≈°en podporou.');
    logout();
  }
}
setInterval(checkForcedLogout, 3000);

/* ===== Event helpers ===== */
function safeHHMM(s){ return /^\d{2}:\d{2}$/.test(s||'')?s:''; }
function eventEndMs(a){ const d=a?.date||today(); const end=safeHHMM(a?.timeTo)||safeHHMM(a?.timeFrom)||'23:59'; const t=new Date(`${d}T${end}`).getTime(); return isNaN(t)?new Date(`${d}T23:59`).getTime():t; }
function isPastEvent(a){ return nowMs()>eventEndMs(a); }
function getUnlockMs(a){ if(!a||!a.signupUnlock) return 0; const ms=new Date(a.signupUnlock).getTime(); return isNaN(ms)?0:ms; }
function sortEvents(a,b){ const A=(a.date||'')+' '+(a.timeFrom||'00:00'); const B=(b.date||'')+' '+(b.timeFrom||'00:00'); return A.localeCompare(B); }
async function archiveSweep(){ const toMove=(ACTIONS||[]).filter(isPastEvent); if(!toMove.length) return; ACTIONS=ACTIONS.filter(a=>!isPastEvent(a)); await kvSave(DB_ACTIONS,ACTIONS); ARCHIVE=[...toMove.slice().sort(sortEvents).reverse(), ...ARCHIVE]; await kvSave(DB_ARCHIVE,ARCHIVE); }

/* ===== Obsazenost (≈ô√°dek) ===== */
function occupancyLineHTML(a){
  if(a?.isCourse){
    const cur = (a.courseMembers||[]).length;
    const cap = Number.isFinite(a.courseCap) ? a.courseCap : 0;
    return `<div class="occ-wrap"><span class="occ-role ${cap>cur?'occ-missing':'occ-ok'}">Kurz ${cur}/${cap}</span></div>`;
  }

  const pubs=getPublicRoleKeys();
  const parts = pubs.map(r=>{
    const cur=(a.signups?.[r]||[]).length;
    const cap=(a.capacity?.[r]||0);
    const missing = cap>cur;
    const cls = missing ? 'occ-role occ-missing' : 'occ-role occ-ok';
    return `<span class="${cls}">${roleLabel(r)} ${cur}/${cap}</span>`;
  }).filter(Boolean);
  return `<div class="occ-wrap">${parts.join('')}</div>`;
}


/* ===== Form√°tov√°n√≠ datum≈Ø ===== */
function fmtDM(dStr){
  const d=new Date(dStr+'T00:00:00');
  if(isNaN(d)) return dStr||'';
  const dd=String(d.getDate()).padStart(2,'0');
  const mm=String(d.getMonth()+1).padStart(2,'0');
  return `${dd}.${mm}.`;
}
function monthKey(dStr){
  const d=new Date(dStr+'T00:00:00'); if(isNaN(d)) return 'Nezn√°m√©';
  const m=d.toLocaleString(undefined,{month:'long', year:'numeric'});
  return m.charAt(0).toUpperCase()+m.slice(1);
}

/* ===== Header + Login ===== */
function renderHeader(){
  const el=$('#hdr'); if(!ME){ el.innerHTML=''; return; }
  ensureActiveRole();
  const prs=userPublicRoles(ME);
  const roleSel=(ACTIVE_ROLE && prs.length)?`<select class="select" id="selActiveRole">${prs.map(r=>`<option value="${r}" ${r===ACTIVE_ROLE?'selected':''}>${roleLabel(r)}</option>`).join('')}</select>`:`<span class="muted">Bez ve≈ôejn√© role</span>`;

  const publicNav = `
    <div class="row">
      <button class="btn" type="button" onclick="viewEvents()">Ud√°losti</button>
      <button class="btn" type="button" onclick="viewPastEvents()">Probƒõhl√©</button>
      <button class="btn" type="button" onclick="viewPassword()">Zmƒõna hesla</button>
    </div>`;

  el.innerHTML=`
    <div class="row">
      <span class="badge">${ME.name}</span>
      ${roleSel}
      ${publicNav}
      ${isPrivileged()? `
        <div class="menu" id="adminMenu">
          <button class="btn" id="adminBtn" type="button">Admin ‚ñæ</button>
          <div class="dropdown">
            <button type="button" onclick="viewEvents()">Ud√°losti</button>
            <button type="button" onclick="viewPastEvents()">Probƒõhl√© akce</button>
            <button type="button" onclick="viewMembers()">ƒålenov√©</button>
            <button type="button" onclick="viewRoles()">Role</button>

            ${isSupportUser(ME) ? `
              <button type="button" onclick="viewLogins()">Loginy</button>
              <button type="button" onclick="viewActivity()">Aktivita</button>
            ` : ''}

            <button type="button" onclick="viewCreateEvent()">Nov√° ud√°lost</button>
            ${isSupportUser(ME)?`<button type="button" onclick="viewExport()">Export / Z√°loha</button>`:''}
          </div>
        </div>`:''}
      <button class="btn" type="button" onclick="logout()">Odhl√°sit</button>
    </div>`;
  const sel=document.getElementById('selActiveRole'); if(sel) sel.onchange=()=>{ ACTIVE_ROLE=sel.value; renderApp(); };
  const menu=document.getElementById('adminMenu'); if(menu){ const btn=document.getElementById('adminBtn'); btn.addEventListener('click',(e)=>{e.stopPropagation();menu.classList.toggle('open');}); document.addEventListener('click',(e)=>{ if(!menu.contains(e.target)) menu.classList.remove('open'); }); }
}
function viewLogin(){
  CURRENT_VIEW='login';
  const app=$('#app');
  app.innerHTML=`
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>P≈ôihl√°≈°en√≠</h3>
      <input id="loginName" class="input" placeholder="Jm√©no" autocomplete="username">
      <div class="row" style="justify-content:space-between;width:100%">
        <input id="loginPass" class="input" type="password" placeholder="Heslo" style="flex:1" autocomplete="current-password">
        <button class="btn" id="togglePass" type="button" aria-label="Zobrazit/skr√Ωt heslo">üëÅÔ∏è</button>
      </div>
      <button class="btn primary" id="btnLogin" type="button">P≈ôihl√°sit</button>
    </div>`;
  $('#togglePass').onclick=()=>{ const i=$('#loginPass'); i.type=(i.type==='password'?'text':'password'); };
  $('#btnLogin').onclick=async ()=>{
    const n=$('#loginName').value.trim();
    const p=$('#loginPass').value;
    const u=(USERS||[]).find(x=>x.name===n && x.password===p && x.isActive!==false);
    if(!u){ alert('Neplatn√© √∫daje'); return; }
    ME=u; localStorage.setItem(DB_SESSION, ME.id); ensureActiveRole();
    await logActivity('login', null, null, 'u≈æivatel se p≈ôihl√°sil');
    CURRENT_VIEW='events'; CURRENT_EDIT_ID=null;
    renderApp();
  };
}

/* ===== Ud√°losti: helpers ===== */
function isMeSignedInEvent(a){ if(!ME) return false; for(const r of Object.keys(a.signups||{})){ if((a.signups[r]||[]).includes(ME.id)) return true; } return false; }
function candidatesForRole(roleKey, a){
  return (USERS||[])
    .filter(u=>u.isActive!==false)
    .filter(canSeeUser)
    .filter(u=>userHasRole(u, roleKey))
    .filter(u=>!(a.signups?.[roleKey]||[]).includes(u.id));
}
async function updateEventBoth(aid, updater){
  let changed=false;
  let a=ACTIONS.find(x=>x.id===aid);
  if(a){ updater(a); changed=true; await kvSave(DB_ACTIONS,ACTIONS); }
  let p=ARCHIVE.find(x=>x.id===aid);
  if(p){ updater(p); changed=true; await kvSave(DB_ARCHIVE,ARCHIVE); }
  if(changed){ renderApp(); }
}


/* ===== Duplikace ud√°losti (ADMIN) ===== */
function startDuplicate(aid){
  if(!isPrivileged()) return;
  const a = ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid);
  if(!a) return;
  DUPLICATE_PREFILL = {
    date: a.date || today(),
    timeFrom: a.timeFrom || '',
    timeTo: a.timeTo || '',
    title: (a.title || '') + ' (kopie)',
    location: a.location || '',
    signupUnlock: a.signupUnlock || '',
    capacity: JSON.parse(JSON.stringify(a.capacity || {})),
    tech: a.tech || '',
    notePublic: a.notePublic || '',
    isCourse: !!a.isCourse,
    courseCap: Number.isFinite(a.courseCap) ? a.courseCap : 0,
    courseMembers: []
  };
  closeEventModal();
  viewCreateEvent(null);
}
window.startDuplicate = startDuplicate;

/* ===== Assign/Unassign ƒçlen≈Ø ===== */
async function assignMember(aid, roleKey, uid){
  if(!isPrivileged()) return;
  let a=ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid); if(!a) return;
  a.signups[roleKey]=a.signups[roleKey]||[];
  if(!a.signups[roleKey].includes(uid)){
    a.signups[roleKey].push(uid);
    if(ACTIONS.some(x=>x.id===aid)) await kvSave(DB_ACTIONS,ACTIONS); else await kvSave(DB_ARCHIVE,ARCHIVE);
    const u=getUserById(uid); toast('P≈ôi≈ôazen ƒçlen', `${u?.name||uid} ‚Üí ${roleLabel(roleKey)}`);
    await logActivity('assign', a.id, a.title, `${u?.name||uid} (${roleLabel(roleKey)})`, a.date);
  }
  openEventModal(aid);
}
async function removeMember(aid, roleKey, uid){
  if(!isPrivileged()) return;
  let a=ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid); if(!a) return;
  a.signups[roleKey]=(a.signups[roleKey]||[]).filter(x=>x!==uid);
  if(ACTIONS.some(x=>x.id===aid)) await kvSave(DB_ACTIONS,ACTIONS); else await kvSave(DB_ARCHIVE,ARCHIVE);
  const u=getUserById(uid); toast('Odebr√°n ƒçlen', `${u?.name||uid} z ${roleLabel(roleKey)}`);
  await logActivity('unassign', a.id, a.title, `${u?.name||uid} (${roleLabel(roleKey)})`, a.date);
  openEventModal(aid);
}

/* ===== Finance / admin pozn. ===== */
async function setEventPaid(aid, paid){
  if(!isPrivileged()) return;
  await updateEventBoth(aid, ev=>{ ev.isPaid=!!paid; });
  const e=ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid);
  await logActivity('paid', aid, e?.title, paid?'1':'0', e?.date);
  toast(paid?'Oznaƒçeno jako zaplaceno':'Zru≈°eno zaplaceno');
}
async function saveEventNote(aid, text){
  if(!isPrivileged()) return;
  await updateEventBoth(aid, ev=>{ ev.adminNote=(text||''); });
  const e=ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid);
  await logActivity('paid', aid, e?.title, paid?'1':'0', e?.date);
  toast('Pozn√°mka ulo≈æena');
}

/* ===== Join/Leave/Delete ===== */
function inRoleCapacity(a, roleKey){ const cap=(a.capacity?.[roleKey]||0); const list=a.signups?.[roleKey]||[]; return list.length<cap; }
async function joinEvent(aid){
  const a=ACTIONS.find(x=>x.id===aid); if(!a||!ME) return;
  const unlockMs=getUnlockMs(a); if(unlockMs!==0 && nowMs()<unlockMs){ alert('P≈ôihla≈°ov√°n√≠ je≈°tƒõ nen√≠ otev≈ôen√©.'); return; }
  ensureActiveRole(); if(!ACTIVE_ROLE){ alert('Nem√°te vybranou ve≈ôejnou roli'); return; }
  a.signups[ACTIVE_ROLE]=a.signups[ACTIVE_ROLE]||[];
  if(a.signups[ACTIVE_ROLE].includes(ME.id)){ toast('U≈æ jste p≈ôihl√°≈°en.'); renderApp(); return; }
  if(!inRoleCapacity(a, ACTIVE_ROLE)){ toast('Kapacita t√©to role je pln√°.'); return; }
  a.signups[ACTIVE_ROLE].push(ME.id);
  await kvSave(DB_ACTIONS,ACTIONS);
  toast('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©', a.title);
  await logActivity('join', a.id, a.title, `${ME.name} (${roleLabel(ACTIVE_ROLE)})`, a.date);
}
async function leaveEvent(aid){
  const a=ACTIONS.find(x=>x.id===aid); if(!a||!ME||!ACTIVE_ROLE) return;
  a.signups[ACTIVE_ROLE]=(a.signups[ACTIVE_ROLE]||[]).filter(x=>x!==ME.id);
  await kvSave(DB_ACTIONS,ACTIONS);
  toast('Odhl√°≈°en√≠ √∫spƒõ≈°n√©', a.title);
  await logActivity('leave', a.id, a.title, `${ME.name} (${roleLabel(ACTIVE_ROLE)})`, a.date);
}
async function deleteEvent(aid){
  if(!isPrivileged()) return;
  if(!confirm('Smazat ud√°lost?')) return;
let removedTitle='', removedDate='';
  const ia=ACTIONS.findIndex(x=>x.id===aid);
  if(ia>-1){removedTitle=ACTIONS[ia].title||removedTitle; removedDate=ACTIONS[ia].date||removedDate; ACTIONS.splice(ia,1); await kvSave(DB_ACTIONS,ACTIONS); }
  const ip=ARCHIVE.findIndex(x=>x.id===aid);
  if(ip>-1){removedTitle=ACTIONS[ia].title||removedTitle; removedDate=ACTIONS[ia].date||removedDate; ARCHIVE.splice(ip,1); await kvSave(DB_ARCHIVE,ARCHIVE); }
  toast('Ud√°lost smaz√°na', removedTitle);
  await logActivity('delete', aid, removedTitle, null, removedDate);
}

/* ===== Create/Edit ===== */
function viewCreateEvent(editId=null){
  if(!isPrivileged()) return;
  CURRENT_VIEW='create'; CURRENT_EDIT_ID=editId;
  const pf = (!editId && DUPLICATE_PREFILL) ? DUPLICATE_PREFILL : null;
  if(!isPrivileged()) return;
  CURRENT_VIEW='create'; CURRENT_EDIT_ID=editId;
  const a = editId ? (ACTIONS.find(x=>x.id===editId) || ARCHIVE.find(x=>x.id===editId)) : null;

  const date = pf ? (pf.date||today()) : (a?.date || today());
  const title = pf ? (pf.title||'') : (a?.title || '');
  const location = pf ? (pf.location||'') : (a?.location || '');
  const tFrom = pf ? (pf.timeFrom||'') : (a?.timeFrom || '');
  const tTo = pf ? (pf.timeTo||'') : (a?.timeTo || '');
  const unlock = pf ? (pf.signupUnlock||'') : (a?.signupUnlock || '');
  const tech = pf ? (pf.tech||'') : (a?.tech || '');
  const note = pf ? (pf.notePublic||'') : (a?.notePublic || '');
  const isCourse = pf ? !!pf.isCourse : !!a?.isCourse;
  const courseCap = pf ? (Number.isFinite(pf.courseCap) ? pf.courseCap : 0) : (Number.isFinite(a?.courseCap) ? a.courseCap : 0);
  const courseMembers = pf ? (Array.isArray(pf.courseMembers) ? pf.courseMembers : []) : (Array.isArray(a?.courseMembers) ? a.courseMembers : []);

  const pubs=getPublicRoleKeys();
  const caps = pubs.map(k=>{
let def = 1;
if(k==='zza') def=0;
if(k==='ridic') def=0;
if(k=='zachranar') def=0;
const v = pf ? (pf.capacity?.[k] ?? def) : (a?.capacity?.[k] ?? def);
    return `<div><label>${roleLabel(k)} kapacita<input class="input" id="cap_${k}" type="number" min="0" value="${v}"></label></div>`;
  }).join('');

  // aktivn√≠ u≈æivatel√©, kter√© m≈Ø≈æe aktu√°ln√≠ u≈æivatel vidƒõt (admin neuvid√≠ Podporu)
const visibleActiveUsers = (USERS||[])
  .filter(u => u.isActive !== false)
  .filter(canSeeUser);

const membersChecklist = visibleActiveUsers.map(u=>{
  const checked = courseMembers.includes(u.id) ? 'checked' : '';
  return `<label class="row" style="gap:6px"><input type="checkbox" value="${u.id}" class="ev_course_member" ${checked}> ${h(u.name)}</label>`;
}).join('') || '<div class="muted">≈Ω√°dn√≠ u≈æivatel√©.</div>';


  DUPLICATE_PREFILL = null; $('#app').innerHTML=`
    <h3>${editId?'Upravit ud√°lost':'Nov√° ud√°lost'}</h3>
    <div class="card">
      <div class="grid3">
        <label>Kdy (datum)<input id="ev_date" class="input" type="date" value="${date}"></label>
        <label>Od<input id="ev_from" class="input" placeholder="HH:MM" value="${tFrom}"></label>
        <label>Do<input id="ev_to" class="input" placeholder="HH:MM" value="${tTo}"></label>
      </div>

      <div class="grid2" style="margin-top:8px">
        <label>N√°zev<input id="ev_title" class="input" value="${title}"></label>
        <label>M√≠sto<input id="ev_loc" class="input" value="${location}"></label>
      </div>

      <div class="grid2" style="margin-top:8px">
        <label>P≈ôihla≈°ov√°n√≠ spu≈°tƒõno od
          <input id="ev_unlock" class="input" type="datetime-local" value="${unlock? new Date(unlock).toISOString().slice(0,16):''}">
        </label>

        <label class="row" style="gap:8px; align-items:center">
          <input id="ev_course" type="checkbox" ${isCourse?'checked':''}
            onchange="(function(){
              const on = document.getElementById('ev_course').checked;
              document.getElementById('courseBlock').style.display = on ? '' : 'none';
            })()">
          <span><b>Kurz</b> <span class="muted">(ve v√Ωpisech uvid√≠ jen Admin)</span></span>
        </label>
      </div>

      <div class="grid2" style="margin-top:8px">
        <label>Technika
          <textarea id="ev_tech" class="textarea" placeholder="Seznam techniky, vybaven√≠...">${h(tech)}</textarea>
        </label>
        <label>Pozn√°mka (ve≈ôejn√°)
          <textarea id="ev_note" class="textarea" placeholder="Dopl≈àuj√≠c√≠ informace pro v≈°echny...">${h(note)}</textarea>
        </label>
      </div>

      <div class="grid3" style="margin-top:8px">${caps}</div>

      <!-- BLOK: nastaven√≠ kurzu -->
      <div id="courseBlock" class="admin-box" style="margin-top:12px; ${isCourse?'':'display:none'}">
        <b>Nastaven√≠ kurzu</b>
        <div class="grid2" style="margin-top:8px">
          <label>ƒålenov√© na kurzu (poƒçet m√≠st)
            <input id="ev_course_cap" class="input" type="number" min="0" value="${courseCap}">
          </label>
          <div></div>
        </div>
        <div style="margin-top:8px">
          <b>Vyber ƒçleny (bez ohledu na role)</b>
          <div style="margin-top:6px; max-height:260px; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:8px; background:#fff">
            ${membersChecklist}
          </div>
          <div class="muted small" style="margin-top:6px">Tip: vybran√≠ ƒçlenov√© budou uvedeni u kurzu. Poƒçet m√≠st slou≈æ√≠ pro p≈ôehled obsazenosti (X/Y).</div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" type="button" onclick="viewEvents()">Zpƒõt</button>
        <button class="btn primary" type="button" onclick="saveEvent('${editId||''}')">${editId?'Ulo≈æit zmƒõny':'Vytvo≈ôit'}</button>
      </div>
    </div>`;
}


async function saveEvent(editId){
  if(!isPrivileged()){ alert('Jen admin/podpora'); return; }
  const d=$('#ev_date')?.value?.trim()||'';
  const f=$('#ev_from')?.value?.trim()||'';
  const t=$('#ev_to')?.value?.trim()||'';
  const ti=$('#ev_title')?.value?.trim()||'';
  const lo=$('#ev_loc')?.value?.trim()||'';
  const un=$('#ev_unlock')?.value?.trim()||'';
  const tech=$('#ev_tech')?.value?.trim()||'';
  const note=$('#ev_note')?.value?.trim()||'';
  const isCourse = !!$('#ev_course')?.checked;
  const courseCap = parseInt($('#ev_course_cap')?.value||'0',10) || 0;
const courseMembers = Array.from(document.querySelectorAll('.ev_course_member:checked'))
  .map(i => i.value)
  .filter(id => {
    const u = getUserById(id);
    return u && canSeeUser(u); // vylouƒç√≠ support pro ne-support u≈æivatele (admina)
  });  const unlock= un? new Date(un).toISOString(): null;

  const pubs=getPublicRoleKeys();
  const cap={}; pubs.forEach(k=>{ const v=parseInt(document.getElementById('cap_'+k)?.value||'0',10); cap[k]=isNaN(v)?0:v; });

  if(editId){
    await updateEventBoth(editId, ev=>{
      ev.date=d; ev.timeFrom=f; ev.timeTo=t; ev.title=ti; ev.location=lo;
      ev.signupUnlock=unlock; ev.capacity=cap; ev.tech=tech; ev.notePublic=note;
      ev.isCourse = isCourse;
      ev.courseCap = isCourse ? courseCap : 0;
      ev.courseMembers = isCourse ? courseMembers : [];
    });
    const e=ACTIONS.find(x=>x.id===editId) || ARCHIVE.find(x=>x.id===editId);
    await logActivity('edit', editId, e?.title, null, e?.date);
    toast('Ud√°lost upravena', ti);
    isPastEvent({date:d,timeTo:t,timeFrom:f}) ? viewPastEvents() : viewEvents();
  }else{
    const su={}; pubs.forEach(k=> su[k]=[] );
    const a={
      id: uid(), date:d, timeFrom:f, timeTo:t, title:ti, location:lo,
      signupUnlock:unlock, capacity:cap, signups:su,
      isPaid:false, adminNote:'', tech:tech, notePublic:note,
      isCourse: isCourse,
      courseCap: isCourse ? courseCap : 0,
      courseMembers: isCourse ? courseMembers : []
    };
    ACTIONS.push(a); await kvSave(DB_ACTIONS,ACTIONS);
    toast('Ud√°lost vytvo≈ôena', a.title);
    await logActivity('create', a.id, a.title, null, a.date);
    viewEvents();
  }
}



/* ===== Historie akce ===== */
function renderEventHistory(aid, limit=30){
  const list = (ACTIVITY||[])
    .filter(h=>h.eventId===aid)
    .sort((a,b)=>b.ts-a.ts)
    .slice(0, limit)
    .map(h=>{
      const at=new Date(h.ts).toLocaleString();
      const who = h.userName || h.userId || 'u≈æivatel';
      const det = h.detail? ` ‚Äî <span class="muted">${h.detail}</span>` : '';
      return `<li>${at}: <b>${h.type}</b> ‚Äî ${h.eventTitle? h.eventTitle+' ‚Äî ':''}<i>${h.who||who}</i>${det}</li>`;
    }).join('') || '<li class="muted">≈Ω√°dn√© z√°znamy.</li>';

  return `
    <details style="margin-top:10px">
      <summary><b>Historie akce</b></summary>
      <div class="card" style="margin-top:8px">
        <ul class="list-plain">${list}</ul>
      </div>
    </details>
  `;
}

/* ===== Ruƒçn√≠ p≈ôi≈ôazen√≠ (ADMIN) ===== */
function manualAssignBlock(a){
  if(!isPrivileged()) return '';
  const pubs = getPublicRoleKeys();
  const perRole = pubs.map(r=>{
    const existing = (a.signups?.[r]||[]).map(uid=>{
      const nm = h(getUserById(uid)?.name || uid);
      return `<span class="chip">${nm} <button class="x" title="Odebrat" onclick="removeMember('${a.id}','${r}','${uid}')">√ó</button></span>`;
    }).join(' ') || '<span class="muted">‚Äî</span>';

    const opts = candidatesForRole(r, a).map(u=>`<option value="${u.id}">${h(u.name)}</option>`).join('');
    const selId = `sel_${a.id}_${r}`;
    const disabled = opts? '' : 'disabled';

    return `
      <div class="card" style="padding:10px">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div><b>${roleLabel(r)}</b></div>
          <div class="small muted">${(a.signups?.[r]||[]).length}/${a.capacity?.[r]||0}</div>
        </div>
        <div style="margin-top:6px">${existing}</div>
        <div class="row" style="margin-top:6px">
          <select id="${selId}" class="select">${opts || '<option>‚Äî</option>'}</select>
          <button class="btn" ${disabled} type="button"
  onclick="(function(){ const v=document.getElementById('${selId}').value; if(v) confirmAndAssign('${a.id}','${r}',v); })()">P≈ôidat</button>
          </div>
      </div>
    `;
  }).join('');

  return `
    <div class="admin-box small" style="margin-top:10px">
      <b>Ruƒçn√≠ p≈ôi≈ôazen√≠</b>
      <div class="grid3" style="margin-top:8px">${perRole}</div>
    </div>
  `;
}

/* ===== PUSH-UP MODAL ===== */
function openEventModal(aid){
  const a = ACTIONS.find(x=>x.id===aid) || ARCHIVE.find(x=>x.id===aid);
  if(!a) return;

  // <<< pokud jde o kurz a u≈æivatel nen√≠ privilegovan√Ω, zam√≠tnout >>>
  if(a.isCourse && !isPrivileged()){
    alert('Tuto polo≈æku mohou zobrazit pouze Admin a Podpora.');
    return;
  }

  const pubs=getPublicRoleKeys();
  let actionHtml='';
  if(!ME){
    actionHtml = `<span class="muted">Pro p≈ôihl√°≈°en√≠ se nejd≈ô√≠v p≈ôihlas.</span>`;
  }else{
    const unlockMs=getUnlockMs(a);
    const isOpen=(unlockMs===0||nowMs()>=unlockMs);
    if(!isOpen){
      const when=a.signupUnlock?new Date(a.signupUnlock).toLocaleString():'';
      actionHtml=`<span class="muted">P≈ôihla≈°ov√°n√≠ se otev≈ôe: <b>${when}</b></span>`;
    }else if(ACTIVE_ROLE){
      const list=a.signups?.[ACTIVE_ROLE]||[];
      const isIn=list.includes(ME.id);
      const full=list.length>=(a.capacity?.[ACTIVE_ROLE]||0);
      actionHtml = isIn
        ? `<button class="btn danger" type="button" onclick="leaveEvent('${a.id}'); closeEventModal();">Odhl√°sit se</button>`
        : (full
            ? `<span class="muted">Kapacita pro roli ${roleLabel(ACTIVE_ROLE)} je pln√°</span>`
            : `<button class="btn primary" type="button" onclick="joinEvent('${a.id}'); closeEventModal();">P≈ôihl√°sit se (${roleLabel(ACTIVE_ROLE)})</button>`);
    }else{
      actionHtml = `<span class="muted">Nem√°≈° vybranou ve≈ôejnou roli.</span>`;
    }
  }

  const signupsHtml = pubs.map(r=>{
    const names=(a.signups?.[r]||[]).map(uid=>h(getUserById(uid)?.name||uid)).join(', ');
    const cur=(a.signups?.[r]||[]).length, cap=(a.capacity?.[r]||0);
    const missing = cap>cur;
    const color = missing ? 'style="color:#b91c1c;font-weight:600"' : 'class="muted"';
    return `<div ${color}><b>${roleLabel(r)}</b> ${cur}/${cap} ${names?`‚Äî <span class="muted">${names}</span>`:''}</div>`;
  }).join('');

  const techBox = `
    <div class="pub-box small">
      <b>Technika</b>
      <div class="prewrap" style="margin-top:4px">${h(a.tech)||'<span class="muted">‚Äî</span>'}</div>
    </div>`;
  const noteBox = `
    <div class="pub-box small">
      <b>Pozn√°mka</b>
      <div class="prewrap" style="margin-top:4px">${h(a.notePublic)||'<span class="muted">‚Äî</span>'}</div>
    </div>`;

  const kurzBadge = (a.isCourse && isPrivileged()) ? ` <span class="badge">Kurz</span>` : '';
  // >>> ADDED: kurzov√Ω blok (obsazenost + seznam ƒçlen≈Ø)
const courseBlock = a.isCourse ? `
  <div class="pub-box small" style="margin-top:8px">
    <b>ƒålenov√© kurzu</b>
    <div class="small" style="margin-top:4px">
      <div><span class="badge">Obsazenost ${(a.courseMembers||[]).length}/${ Number.isFinite(a.courseCap) ? a.courseCap : 0 }</span></div>
      <div class="prewrap" style="margin-top:6px">
        ${
          (a.courseMembers||[]).length
            ? (a.courseMembers.map(uid => h(getUserById(uid)?.name || uid)).join(', '))
            : '<span class="muted">Zat√≠m nikdo</span>'
        }
      </div>
    </div>
  </div>
` : '';
// <<< ADDED


  const adminSection = isPrivileged() ? `
    <div class="admin-box small" style="margin-top:10px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="gap:8px">
          <label class="row" style="gap:6px">
            <input type="checkbox" ${a.isPaid?'checked':''} onchange="setEventPaid('${a.id}', this.checked)"> Zaplaceno
          </label>
          ${a.isPaid?'<span class="badge paid">Zaplaceno</span>':''}
          ${a.isCourse?'<span class="badge">Kurz</span>':''}
        </div>
        <div class="row" style="gap:8px">
          <button class="btn" type="button" onclick="closeEventModal(); viewCreateEvent('${a.id}')">Upravit</button>
          <button class=\"btn\" type=\"button\" onclick=\"startDuplicate('${a.id}')\">Duplikovat</button>
          <button class="btn danger" type="button" onclick="closeEventModal(); deleteEvent('${a.id}')">Smazat</button>
        </div>
      </div>

      <div style="margin-top:6px">
        <label>Pozn√°mka pro adminy</label>
        <textarea id="admnote_${a.id}" class="textarea" placeholder="Intern√≠ pozn√°mka...">${h(a.adminNote||'')}</textarea>
        <div class="row" style="justify-content:flex-end;margin-top:6px">
          <button class="btn" type="button" onclick="saveEventNote('${a.id}', document.getElementById('admnote_${a.id}').value)">Ulo≈æit pozn.</button>
        </div>
        <div class="muted small">Ulo≈æ√≠ se i do ‚ÄûProbƒõhl√Ωch‚Äú.</div>
      </div>
    </div>
    ${manualAssignBlock(a)}
  ` : '';

  const historyBlock = renderEventHistory(a.id, 30);

  const html = `
    <div class="muted">${a.date} ‚Ä¢ ${a.location||'‚Äî'} ‚Ä¢ ${(a.timeFrom||'')}${a.timeTo?('‚Äì'+a.timeTo):''}</div>
    ${a.signupUnlock? `<div class="muted small">Odemknut√≠ p≈ôihla≈°ov√°n√≠: <b>${new Date(a.signupUnlock).toLocaleString()}</b></div>` : ''}

    <h4 style="margin:10px 0 6px 0">${h(a.title||'Ud√°lost')}${kurzBadge}</h4>

    <div class="row" style="align-items:flex-start">
      <div style="flex:1; min-width:260px">${techBox}</div>
      <div style="flex:1; min-width:260px">${noteBox}</div>
    </div>
${courseBlock}   <!-- >>> ADDED: kurzov√Ω blok se zobraz√≠ jen kdy≈æ a.isCourse === true -->


    <div style="margin-top:8px">
      <b>Obsazenost</b>
      <div class="small" style="margin-top:4px">${signupsHtml||'<span class="muted">‚Äî</span>'}</div>
    </div>

    ${adminSection}
    ${historyBlock}

    <div class="row" style="justify-content:flex-end; margin-top:10px">
      ${actionHtml}
    </div>
  `;

  document.getElementById('evModalTitle').textContent = a.title || 'Ud√°lost';
  document.getElementById('evModalContent').innerHTML = html;
  const backdrop = document.getElementById('modalBackdrop');
  backdrop.classList.add('open');

  const modalEl = backdrop.querySelector('.modal');
  modalEl.scrollTop = 0;
  document.body.style.overflow = 'hidden';
}

function closeEventModal(){
  document.getElementById('modalBackdrop').classList.remove('open');
  document.body.style.overflow = '';
}
window.openEventModal=openEventModal;
window.closeEventModal=closeEventModal;

/* ===== View: Ud√°losti (mƒõs√≠ƒçn√≠ p≈ôehled) ===== */
function renderMonthlyList(source, title, opts = { monthsDesc:false }){
  const app=$('#app');
  let list = (source||[]).slice().filter(a=>a?.date);

  // <<< filtrov√°n√≠: kurzy vid√≠ jen admin/podpora >>>
  if(!isPrivileged()){
    list = list.filter(a => !a.isCourse);
  }

  if(!list.length){
    app.innerHTML=`<h3>${title}</h3><div class="card muted">≈Ω√°dn√© z√°znamy.</div>`;
    return;
  }

  const toKeyVal = (dStr)=>{
    const d=new Date(dStr+'T00:00:00');
    if(isNaN(d)) return { mk:'Nezn√°m√©', ym:0 };
    return { mk: monthKey(dStr), ym: d.getFullYear()*100 + (d.getMonth()+1) };
  };

  const groups = new Map();
  for(const a of list){
    const { mk, ym } = toKeyVal(a.date);
    if(!groups.has(mk)) groups.set(mk, { ym, items:[] });
    groups.get(mk).items.push(a);
  }

  const monthBlocks = Array.from(groups.entries())
    .sort(([,A],[,B]) => opts.monthsDesc ? (B.ym - A.ym) : (A.ym - B.ym));

  const rowHTML = (a)=>{
    const sub = [a.location||'‚Äî', (a.timeFrom||'')+(a.timeTo?('‚Äì'+a.timeTo):'')].filter(Boolean).join(' ‚Ä¢ ');
    const mine = isMeSignedInEvent(a);
    const badgeKurz = (a.isCourse && isPrivileged()) ? ` <span class="badge">Kurz</span>` : '';
    return `
      <div class="event-row ${mine?'mine-row':''}" onclick="openEventModal('${a.id}')">
        <div class="event-date">${fmtDM(a.date||'')}</div>
        <div>
          <div class="event-title">${h(a.title||'Ud√°lost')}${badgeKurz}</div>
          <div class="event-meta">${h(sub)}</div>
        </div>
        <div class="event-meta" style="text-align:right">${occupancyLineHTML(a)}</div>
      </div>`;
  };

  let out = `<h3>${title}</h3><div class="card" style="padding:0">`;
  for(const [mk, data] of monthBlocks){
    data.items.sort((a,b)=>{
      const A=(a.date||'')+' '+(a.timeFrom||'00:00');
      const B=(b.date||'')+' '+(b.timeFrom||'00:00');
      return A.localeCompare(B);
    });

    out += `<div class="month-header">${h(mk)}</div>`;
    out += data.items.map(rowHTML).join('');
  }
  out += '</div>';

  app.innerHTML = out;
  ensureActiveRole();
  if(ME) resetAutoLogoutTimer();
}


function viewEvents(){
  CURRENT_VIEW='events';
  archiveSweep().catch(console.warn);
  renderMonthlyList(ACTIONS, 'Ud√°losti', { monthsDesc:false });
}

/* ===== View: Probƒõhl√© (mƒõs√≠ce od nejnovƒõj≈°√≠ho, uvnit≈ô chronologicky) ===== */
function viewPastEvents(){
  CURRENT_VIEW='past';
  archiveSweep().catch(console.warn);
  renderMonthlyList(ARCHIVE, 'Probƒõhl√© akce', { monthsDesc:true });
}

/* ===== ƒålenov√© ===== */
async function toggleUserRole(uid, roleKey, on){
  const u=getUserById(uid); if(!u) return;
  if (roleKey==='admin' && !isSupportUser(ME)) return;
  if (roleKey==='support') return;
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;

  u.roles=u.roles||[];
  const has=u.roles.includes(roleKey);
  if(on===false || (on===undefined && has)){ u.roles=u.roles.filter(r=>r!==roleKey); }
  else if(!has){ u.roles.push(roleKey); }

  await kvSave(DB_USERS, USERS);
  await logActivity('user-role', null, null, `${u.name}: ${roleKey} ${on?'on':'off'}`);
  viewMembers();
}
async function saveUserInline(uid){
  const u=getUserById(uid); if(!u) return;
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;
  const n=document.getElementById('un_'+uid)?.value?.trim()||u.name;
  const p=document.getElementById('up_'+uid)?.value||u.password;
  const a=!!document.getElementById('ua_'+uid)?.checked;
  u.name=n; u.password=p; u.isActive=a;
  await kvSave(DB_USERS, USERS);
  toast('U≈æivatel ulo≈æen', u.name);
  viewMembers();
}
async function toggleActive(uid){
  const u=getUserById(uid); if(!u) return;
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;
  u.isActive=!u.isActive;
  await kvSave(DB_USERS, USERS);
  viewMembers();
}
async function deleteUser(uid){
  const u=getUserById(uid); if(!u) return;
  if (userHasRole(u,'admin')) { alert('U≈æivatele s rol√≠ ‚Äûadmin‚Äú nelze smazat.'); return; }
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;
  if(!confirm('Opravdu smazat u≈æivatele?')) return;
  USERS=USERS.filter(x=>x.id!==uid);
  await kvSave(DB_USERS, USERS);
  viewMembers();
}
async function addUser(){
  const n=$('#newName').value.trim();
  const p=$('#newPass').value.trim();
  const a=$('#newActive').checked;
  if(!n||!p) return alert('Vypl≈à jm√©no i heslo');
  const rks=[...document.querySelectorAll('#newRoles input[type=checkbox]:checked')]
    .map(i=>i.value)
    .filter(v=>v!=='support')
    .filter(v=>!(v==='admin' && !isSupportUser(ME)));
  USERS.push({id:uid(),name:n,password:p,roles:rks,isActive:a});
  await kvSave(DB_USERS, USERS);
  viewMembers();
}
function viewMembers(){
  CURRENT_VIEW='members';
  const app=$('#app');

  const roleChips = (u)=>{
    const chips=(u.roles||[])
      .filter(rk=>canSeeRoleKey(rk))
      .map(rk=>{
        const canRemove =
          rk==='support' ? false :
          rk==='admin'   ? isSupportUser(ME) :
          true;
        const btn = canRemove ? `<button class="btn ghost danger" type="button" onclick="toggleUserRole('${u.id}','${rk}',false)">√ó</button>` : '';
        return `<span class="chip">${roleLabel(rk)}${btn}</span>`;
      })
      .join('');
    return chips || '<span class="muted">‚Äî</span>';
  };

  const roleCheckboxes = (u)=>{
    const set=new Set(u.roles||[]);
    return ROLES.filter(canSeeRoleObj).map(r=>{
      const dis = (r.key==='support') ? 'disabled' : ((r.key==='admin' && !isSupportUser(ME)) ? 'disabled' : '');
      return `
        <label class="row" style="gap:6px">
          <input type="checkbox" ${set.has(r.key)?'checked':''} ${dis}
                 onchange="toggleUserRole('${u.id}','${r.key}', this.checked)">
          ${r.label} <span class="muted">(${r.key})</span>
        </label>
      `;
    }).join('');
  };

  const rows=USERS
    .filter(canSeeUser)
    .map(u=>{
      const lastLoginTs = lastLoginTsForUser(u.id);
      const lastLogoutTs = lastLogoutTsForUser(u.id);
      const lastLoginLine = isSupportUser(ME)
        ? `<div class="muted">Posledn√≠ p≈ôihl√°≈°en√≠: <b>${lastLoginTs? new Date(lastLoginTs).toLocaleString() : '‚Äî'}</b></div>`
        : '';
      const lastLogoutLine = isSupportUser(ME)
        ? `<div class="muted">Posledn√≠ odhl√°≈°en√≠: <b>${lastLogoutTs? new Date(lastLogoutTs).toLocaleString() : '‚Äî'}</b></div>`
        : '';
      return `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${u.name}</b> <span class="muted">(${u.isActive?'aktivn√≠':'deaktivov√°n'})</span></div>
          ${lastLoginLine}
          ${lastLogoutLine}
          <div class="muted">Role: ${roleChips(u)}</div>
        </div>
        ${isPrivileged()?`
          <div class="row">
            <button class="btn" type="button" onclick="toggleActive('${u.id}')">${u.isActive?'Deaktivovat':'Aktivovat'}</button>
            <button class="btn danger" type="button" onclick="deleteUser('${u.id}')">Smazat</button>
          </div>`:''}
      </div>

      ${isPrivileged()?`
        <div class="admin-box" style="margin-top:8px">
          <div class="grid3">
            <label>Jm√©no<input class="input" id="un_${u.id}" value="${u.name}" /></label>
            <label>Heslo (viditeln√©)<input class="input" id="up_${u.id}" value="${u.password||''}" /></label>
            <label class="row" style="gap:6px">Aktivn√≠ <input type="checkbox" id="ua_${u.id}" ${u.isActive?'checked':''} /></label>
          </div>
          <div class="grid3" style="margin-top:8px">
            <div>
              <b>P≈ôi≈ôadit role</b>
              <div style="margin-top:6px">${roleCheckboxes(u)}</div>
            </div>
            <div></div><div></div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn primary" type="button" onclick="saveUserInline('${u.id}')">Ulo≈æit zmƒõny</button>
          </div>
        </div>`:''}
    </div>`;
    }).join('');

  const addBox = isPrivileged()?`
    <div class="card" style="margin-top:12px">
      <h4>P≈ôidat ƒçlena</h4>
      <div class="grid3">
        <input id="newName" class="input" placeholder="Jm√©no">
        <input id="newPass" class="input" placeholder="Heslo">
        <label class="row" style="gap:6px"><input type="checkbox" id="newActive" checked> Aktivn√≠</label>
      </div>
      <div style="margin-top:8px">
        <b>Role</b>
        <div id="newRoles" style="margin-top:6px">
          ${ROLES.filter(canSeeRoleObj).map(r=>{
            const dis = (r.key==='support') ? 'disabled' : ((r.key==='admin' && !isSupportUser(ME)) ? 'disabled' : '');
            return `
              <label class="row" style="gap:6px">
                <input type="checkbox" value="${r.key}" ${dis}> ${r.label} <span class="muted">(${r.key})</span>
              </label>`;
          }).join('')}
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn primary" type="button" onclick="addUser()">P≈ôidat</button>
      </div>
    </div>` : '';

  app.innerHTML=`<h3>ƒålenov√©</h3>${rows}${addBox}`;
}

/* ===== Role ===== */
function viewRoles(){
  CURRENT_VIEW='roles';
  const app=$('#app');

  const list=ROLES.filter(canSeeRoleObj).map(r=>{
    const canEdit   = isSupportUser(ME) ? true : (r.key !== 'admin');
    const canDelete = isSupportUser(ME) ? true : (r.key !== 'admin');

    return `
      <div class="card">
        <b>${r.label}</b> <span class="muted">(${r.key})</span> ‚Ä¢ ${r.isPublic?'ve≈ôejn√°':'neve≈ôejn√°'}
        ${isPrivileged()?`
        <div class="row" style="margin-top:6px">
          ${canEdit   ? `<button class="btn" type="button" onclick="editRoleOpen('${r.key}')">Upravit</button>` : ``}
          ${canDelete ? `<button class="btn danger" type="button" onclick="deleteRole('${r.key}')">Smazat</button>` : ``}
        </div>`:''}
      </div>`;
  }).join('');

  const addBox = isPrivileged()?`
    <div class="card" style="margin-top:12px">
      <h4>Nov√° role</h4>
      <input id="newRoleKey" class="input" placeholder="kl√≠ƒç (nap≈ô. ridic)">
      <input id="newRoleLabel" class="input" placeholder="Popisek (≈òidiƒç)">
      <label class="row" style="gap:6px"><input type="checkbox" id="newRolePublic" checked> Ve≈ôejn√° role</label>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn primary" type="button" onclick="addRole()">P≈ôidat roli</button>
      </div>
    </div>` : '';

  app.innerHTML=`<h3>Role</h3>${list}${addBox}`;
}
function editRoleOpen(key){
  if(!canSeeRoleKey(key)) { viewRoles(); return; }
  if (key === 'admin' && !isSupportUser(ME)) {
    alert('Roli ‚Äûadmin‚Äú m≈Ø≈æe upravovat pouze Podpora.');
    viewRoles();
    return;
  }
  const r=ROLES.find(x=>x.key===key); if(!r) return;
  const app=$('#app');
  app.innerHTML=`
    <h3>Upravit roli</h3>
    <div class="card">
      <label>Kl√≠ƒç<input class="input" id="er_key" value="${r.key}" disabled></label>
      <label>Popisek<input class="input" id="er_label" value="${r.label}"></label>
      <label class="row" style="gap:6px"><input type="checkbox" id="er_pub" ${r.isPublic?'checked':''}> Ve≈ôejn√° role</label>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" type="button" onclick="viewRoles()">Zpƒõt</button>
        <button class="btn primary" type="button" onclick="saveRole()">Ulo≈æit</button>
      </div>
    </div>`;
}
async function saveRole(){
  const key=document.getElementById('er_key').value;
  if(!canSeeRoleKey(key)) { viewRoles(); return; }
  if (key === 'admin' && !isSupportUser(ME)) {
    alert('Roli ‚Äûadmin‚Äú m≈Ø≈æe upravovat pouze Podpora.');
    viewRoles();
    return;
  }
  const label=document.getElementById('er_label').value.trim();
  const pub=document.getElementById('er_pub').checked;
  const r=ROLES.find(x=>x.key===key); if(!r) return;
  r.label=label; r.isPublic=pub;
  await kvSave(DB_ROLES, ROLES);
  toast('Role ulo≈æena', r.label);
  viewRoles();
}
async function deleteRole(key){
  if(!canSeeRoleKey(key)) { viewRoles(); return; }
  if (key === 'admin' && !isSupportUser(ME)) {
    alert('Roli ‚Äûadmin‚Äú m≈Ø≈æe mazat pouze Podpora.');
    return;
  }
  if(!confirm('Smazat roli?')) return;
  ROLES=ROLES.filter(r=>r.key!==key);
  USERS=USERS.map(u=>({ ...u, roles:(u.roles||[]).filter(rk=>rk!==key) }));
  await kvSave(DB_ROLES, ROLES); await kvSave(DB_USERS, USERS);
  viewRoles();
}
async function addRole(){
  const k=$('#newRoleKey').value.trim();
  const l=$('#newRoleLabel').value.trim();
  const pub=$('#newRolePublic').checked;
  if(!k||!l) return alert('Vypl≈à kl√≠ƒç i popisek');
  if(k==='support' && !isSupportUser(ME)) return alert('Tuto roli m≈Ø≈æe spravovat jen Podpora.');
  if(ROLES.find(r=>r.key===k)) return alert('Role s t√≠mto kl√≠ƒçem u≈æ existuje');
  ROLES.push({key:k,label:l,isPublic:pub});
  await kvSave(DB_ROLES, ROLES);
  viewRoles();
}

/* ===== Aktivita + Export + Loginy + force logout ===== */
function viewActivity(){
  CURRENT_VIEW='activity';
  const src = isSupportUser(ME)
    ? (ACTIVITY || [])
    : (ACTIVITY || []).filter(a => a.type !== 'login' && a.type !== 'logout');

  const list = src
    .slice(-200)
    .reverse()
    .map(a=>{
      const ts=new Date(a.ts).toLocaleString();
      const dateTag = a.eventDate ? ` (${fmtDMy(a.eventDate)})` : '';
      const titleWithDate = a.eventTitle ? `(${h(a.eventTitle)}${dateTag})` : '';
      return `<li>${ts}: <b>${h(a.userName||a.userId||'u≈æivatel')}</b> ‚Äî ${h(a.type)} ${titleWithDate} ${a.detail?('‚Äî '+h(a.detail)):''}</li>`;
     
    })
    .join('') || '<li class="muted">≈Ω√°dn√° aktivita.</li>';

  $('#app').innerHTML=`<h3>Aktivita</h3><div class="card"><ul class="list-plain">${list}</ul></div>`;
}
window.viewActivity=viewActivity;

async function adminLogoutUser(uid){
  if(!isSupportUser(ME)) return;
  const u = getUserById(uid);
  if(!u){ toast('U≈æivatel nenalezen'); return; }

  const ts = Date.now();
  ACTIVITY.push({
    ts,
    type: 'logout',
    eventId: null,
    eventTitle: null,
    detail: 'manu√°ln√≠ odhl√°≈°en√≠ (Podpora)',
    userId: u.id,
    userName: u.name
  });
  FORCED.push({ uid: u.id, ts, reason: 'support' });
  await kvSave(DB_ACTIVITY, ACTIVITY);
  await kvSave(DB_FORCED, FORCED);

  toast('U≈æivatel odhl√°≈°en', u.name);
  viewLogins();
}
async function adminLogoutAll(){
  if(!isSupportUser(ME)) return;

  const targets = USERS.filter(u => isUserCurrentlyLogged(u.id).logged);
  if(!targets.length){ toast('Nikdo nen√≠ aktu√°lnƒõ p≈ôihl√°≈°en'); return; }

  const ts = Date.now();
  for(const u of targets){
    ACTIVITY.push({
      ts,
      type: 'logout',
      eventId: null,
      eventTitle: null,
      detail: 'hromadn√© manu√°ln√≠ odhl√°≈°en√≠ (Podpora)',
      userId: u.id,
      userName: u.name
    });
    FORCED.push({ uid: u.id, ts, reason: 'support-all' });
  }
  await kvSave(DB_ACTIVITY, ACTIVITY);
  await kvSave(DB_FORCED, FORCED);

  toast('Odhl√°≈°eni v≈°ichni p≈ôihl√°≈°en√≠', `${targets.length} u≈æiv.`);
  viewLogins();
}

function viewLogins(){
  if(!isSupportUser(ME)){ CURRENT_VIEW='events'; viewEvents(); return; }
  CURRENT_VIEW='logins';

  const perUser = USERS
    .filter(u=>canSeeUser(u) || isSupportUser(ME))
    .map(u=>{
      const li = lastLoginTsForUser(u.id);
      const lo = lastLogoutTsForUser(u.id);
      const { logged, since } = isUserCurrentlyLogged(u.id);
      return { u, li, lo, logged, since };
    })
    .sort((a,b)=>{
      if (a.logged !== b.logged) return a.logged ? -1 : 1;
      return (b.li||0) - (a.li||0);
    });

  const tableRows = perUser.map(x=>{
    const loggedBadge = x.logged
      ? `‚úÖ Ano${x.since ? ` <span class="muted small">(od ${new Date(x.since).toLocaleString()})</span>` : ''}`
      : '‚ùå Ne';
    const actionBtn = x.logged
      ? `<button class="btn danger" type="button" onclick="adminLogoutUser('${x.u.id}')">Odhl√°sit</button>`
      : `<span class="muted">‚Äî</span>`;
    return `
      <tr>
        <td>${h(x.u.name)}</td>
        <td>${x.u.isActive? '‚úÖ aktivn√≠':'‚õî deaktivov√°n'}</td>
        <td>${x.li? new Date(x.li).toLocaleString() : '‚Äî'}</td>
        <td>${x.lo? new Date(x.lo).toLocaleString() : '‚Äî'}</td>
        <td>${loggedBadge}</td>
        <td>${actionBtn}</td>
      </tr>
    `;
  }).join('');

  const recent = (ACTIVITY||[])
    .filter(a=>a.type==='login' || a.type==='logout')
    .slice(-200)
    .reverse()
    .map(a=>{
      const ts=new Date(a.ts).toLocaleString();
      const who=a.userName || a.userId || 'u≈æivatel';
      const det=a.detail? ` ‚Äî <span class="muted small">${h(a.detail)}</span>` : '';
      return `<li>${ts}: <b>${h(who)}</b> ‚Äî ${a.type}${det}</li>`;
    }).join('') || '<li class="muted">Zat√≠m ≈æ√°dn√© loginy/odhl√°≈°en√≠.</li>';

  $('#app').innerHTML=`
    <h3>Loginy</h3>

    <div class="card" style="margin-bottom:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h4 style="margin:0">Posledn√≠ p≈ôihl√°≈°en√≠ / odhl√°≈°en√≠ podle u≈æivatele</h4>
        <button class="btn danger" type="button" onclick="adminLogoutAll()">Odhl√°sit v≈°echny</button>
      </div>
      <div style="overflow:auto; margin-top:8px">
        <table class="table">
          <thead>
            <tr>
              <th>U≈æivatel</th>
              <th>Stav</th>
              <th>Posledn√≠ p≈ôihl√°≈°en√≠</th>
              <th>Posledn√≠ odhl√°≈°en√≠</th>
              <th>P≈ôihl√°≈°en?</th>
              <th>Akce</th>
            </tr>
          </thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h4>Chronologicky (posledn√≠ch 200 ud√°lost√≠)</h4>
      <ul class="list-plain">${recent}</ul>
    </div>
  `;
}
window.viewLogins=viewLogins;

function viewExport(){
  if(!isSupportUser(ME)){ CURRENT_VIEW='events'; viewEvents(); return; }
  CURRENT_VIEW='export';
  $('#app').innerHTML=`<h3>Export / Z√°loha</h3><div class="card"><div class="row"><button class="btn" type="button" onclick="downloadJson()">St√°hnout JSON</button></div></div>`;
}
function downloadJson(){
  const data={users:USERS,roles:ROLES,actions:ACTIONS,archive:ARCHIVE,activity:ACTIVITY,forced:FORCED};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='smenar_backup.json'; a.click();
}

/* ===== Zmƒõna hesla ===== */
function viewPassword(){
  if(!ME){ viewLogin(); return; }
  CURRENT_VIEW='password';
  const app = $('#app');
  app.innerHTML = `
    <h3>Zmƒõna hesla</h3>
    <div class="card" style="max-width:520px">
      <div class="grid2">
        <label>Souƒçasn√© heslo
          <input id="pw_current" class="input" type="password" value="${h(ME.password||'')}" readonly>
        </label>
        <label>Nov√© heslo
          <input id="pw_new" class="input" type="password" placeholder="Zadejte nov√© heslo">
        </label>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn" type="button" onclick="(function(){
          const c=document.getElementById('pw_current');
          const n=document.getElementById('pw_new');
          const show = (c.type==='password');
          c.type = show ? 'text' : 'password';
          n.type = show ? 'text' : 'password';
        })()">üëÅÔ∏è Zobrazit/skr√Ωt obƒõ</button>

        <div class="row" style="gap:8px">
          <button class="btn" type="button" onclick="viewEvents()">Zpƒõt</button>
          <button class="btn primary" type="button" onclick="saveMyPassword()">Ulo≈æit</button>
        </div>
      </div>

      <div class="muted small" style="margin-top:8px">
        Tip: zvolte si siln√© heslo (alespo≈à 6 znak≈Ø).
      </div>
    </div>
  `;
}
async function saveMyPassword(){
  if(!ME) return;
  const newPw = (document.getElementById('pw_new')?.value||'').trim();
  if(!newPw){ alert('Zadejte nov√© heslo.'); return; }
  if(newPw.length < 3){ alert('Heslo by mƒõlo m√≠t alespo≈à 3 znaky.'); return; }

  const u = USERS.find(u=>u.id===ME.id);
  if(!u) return;
  u.password = newPw;
  ME.password = newPw;

  await kvSave(DB_USERS, USERS);
  toast('Heslo zmƒõnƒõno');

  const pwNew = document.getElementById('pw_new');
  if(pwNew) pwNew.value = '';
}
window.viewPassword=viewPassword;
window.saveMyPassword=saveMyPassword;

/* ===== Router ===== */
function renderApp(){
  try{
    renderHeader();
    if(!ME){
      const sid=localStorage.getItem(DB_SESSION);
      if(sid){ const u=getUserById(sid); if(u && u.isActive!==false){ ME=u; ensureActiveRole(); } else localStorage.removeItem(DB_SESSION); }
    }
    if(!ME){ viewLogin(); return; }
    if((CURRENT_VIEW==='export' || CURRENT_VIEW==='logins') && !isSupportUser(ME)) CURRENT_VIEW='events';

    switch(CURRENT_VIEW){
      case 'create': viewCreateEvent(CURRENT_EDIT_ID); break;
      case 'members': viewMembers(); break;
      case 'roles': viewRoles(); break;
      case 'activity': viewActivity(); break;
      case 'past': viewPastEvents(); break;
      case 'export': viewExport(); break;
      case 'logins': viewLogins(); break;
      case 'password': viewPassword(); break;
      default: viewEvents();
    }
    
    if(ME) resetAutoLogoutTimer();
  }catch(e){
    showErr('Render error: '+(e.message||e));
  }
}
renderApp();
init();

/* ===== Global handlers ===== */
window.viewCreateEvent=viewCreateEvent;
window.saveEvent=saveEvent;
window.viewEvents=viewEvents;
window.viewPastEvents=viewPastEvents;
window.viewMembers=viewMembers;
window.viewRoles=viewRoles;
window.viewActivity=viewActivity;
window.viewExport=viewExport;
window.viewLogins=viewLogins;
window.joinEvent=joinEvent;
window.leaveEvent=leaveEvent;
window.assignMember=assignMember;
window.removeMember=removeMember;
window.setEventPaid=setEventPaid;
window.saveEventNote=saveEventNote;
window.deleteEvent=deleteEvent;

window.deleteUser=deleteUser;
window.addUser=addUser;
window.toggleUserRole=toggleUserRole;
window.saveUserInline=saveUserInline;
window.toggleActive=toggleActive;

window.editRoleOpen=editRoleOpen;
window.saveRole=saveRole;
window.deleteRole=deleteRole;
window.addRole=addRole;

window.downloadJson = downloadJson;
window.adminLogoutUser = adminLogoutUser;
window.adminLogoutAll  = adminLogoutAll;
window.confirmAndAssign = confirmAndAssign; // ‚Üê p≈ôidej toto


/* ===== Auto logout (30 min) ===== */
let autoLogoutTimer = null;
const AUTO_LOGOUT_MS = 30 * 60 * 1000;

function resetAutoLogoutTimer(){
  if(autoLogoutTimer) clearTimeout(autoLogoutTimer);
  if(ME){
    autoLogoutTimer = setTimeout(()=>{
      alert("Byl jste automaticky odhl√°≈°en po 30 minut√°ch neƒçinnosti.");
      logout();
    }, AUTO_LOGOUT_MS);
  }
}
['click','keydown','mousemove','scroll','touchstart'].forEach(ev=>{
  window.addEventListener(ev, resetAutoLogoutTimer, true);
});

// logout loguje 'logout'
async function logout(){
  await logActivity('logout', null, null, 'u≈æivatel se odhl√°sil');
  localStorage.removeItem(DB_SESSION);
  ME=null; ACTIVE_ROLE=null;
  CURRENT_VIEW='events'; CURRENT_EDIT_ID=null;
  renderHeader();
  viewLogin();
}
window.logout=logout;
 
  </script>
</body>
</html>
