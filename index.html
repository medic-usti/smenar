<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:,">
  <title>Smƒõn√°≈ô - Medic √öst√≠ nad Labem</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .textarea{min-height:64px;resize:vertical}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    details summary{cursor:pointer; user-select:none; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .admin-box{border:1px dashed var(--border); border-radius:10px; padding:10px; margin-top:10px; background:#fafbff}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}
    .db-ind{position:fixed;right:12px;bottom:12px;z-index:60;background:#111827;color:#fff;border-radius:10px;padding:8px 10px;font-size:12px;box-shadow:0 8px 24px rgba(0,0,0,.25);display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,.08)}
    .db-dot{width:8px;height:8px;border-radius:999px;background:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
    .db-dot.ok{background:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,.25)}
    .db-muted{color:#cbd5e1}
    .event-mine{border-color:#10b981 !important;box-shadow:0 8px 30px rgba(16,185,129,.25)}
    .mine-pill{background:#ecfdf5;border-color:#10b981;color:#065f46;font-weight:600}
    #err {position:fixed;left:12px;right:12px;bottom:68px;z-index:70;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;font-size:12px;display:none}
    .chip{display:inline-flex;align-items:center;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin:2px 4px;background:#fff}
    .chip .x{border:0;background:transparent;cursor:pointer;font-weight:700}
    .small{font-size:12px}
    .paid{background:#ecfdf5;border-color:#10b981;color:#065f46}
  </style>
</head>
<body>
  <div id="dbInd" class="db-ind" title="Stav datab√°ze">
    <span id="dbDot" class="db-dot"></span>
    <span><b>DB:</b> <span id="dbState">Offline</span></span>
    <span class="db-muted">‚Ä¢</span>
    <span class="db-muted">naposledy: <span id="dbLast">‚Äî</span></span>
  </div>
  <div id="err"></div>

  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>

  <main><div id="app"></div></main>
  <div class="toast-wrap" id="toasts"></div>

  <script>
/* === Error reporting === */
(function(){
  function showErr(msg){
    const el=document.getElementById('err');
    if(!el) return;
    el.textContent=String(msg);
    el.style.display='block';
    console.error(msg);
  }
  window.addEventListener('error', (e)=>{ showErr(e.message || 'Nezn√°m√° chyba'); });
  window.addEventListener('unhandledrejection', (e)=>{ showErr(e.reason?.message || e.reason || 'Nezachycen√© odm√≠tnut√≠ Promise'); });
})();

/* ===== Local DB + helpers ===== */
const DB_USERS="smenar.users", DB_ACTIONS="smenar.actions", DB_ROLES="smenar.roles", DB_SESSION="smenar.session", DB_ACTIVITY="smenar.activity", DB_ARCHIVE="smenar.actions.archive";
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch(_){ return []; } }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }
const uid=()=>crypto.randomUUID?crypto.randomUUID():('id'+Date.now()+Math.random().toString(16).slice(2));
const today=()=>new Date().toISOString().slice(0,10);
const nowMs=()=>Date.now();
const $=s=>document.querySelector(s);

function toast(msg,sub){ const w=$('#toasts'); const d=document.createElement('div'); d.className='toast'; d.innerHTML=`<div>${msg}</div>${sub? `<small>${sub}</small>`:''}`; w.appendChild(d); setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(8px)'; d.style.transition='all .25s'; setTimeout(()=>w.removeChild(d),260); },3000); }

/* ===== DB indicator + last updated ===== */
let DB_ONLINE=true, DB_LAST_TS=Date.now(), DB_LAST_SRC='init';
function fmtAgo(ts){ if(!ts) return "‚Äî"; const s=Math.max(0,Math.floor((Date.now()-ts)/1000)); if(s<60) return `${s}s`; const m=Math.floor(s/60); if(m<60) return `${m}m ${s%60}s`; const h=Math.floor(m/60); return `${h}h ${m%60}m`; }
function fmtAbs(ts){ try{ return new Date(ts).toLocaleString(); }catch{ return "‚Äî"; } }
function renderDbInd(){ const dot=$('#dbDot'), st=$('#dbState'), last=$('#dbLast'); if(!dot||!st||!last) return; st.textContent=DB_ONLINE?'Online':'Offline'; dot.classList.toggle('ok', DB_ONLINE); last.textContent=`${fmtAgo(DB_LAST_TS)} (${DB_LAST_SRC})`; const wrap=$('#dbInd'); if(wrap) wrap.title=`DB: ${DB_ONLINE?'Online':'Offline'} ‚Ä¢ naposledy: ${fmtAbs(DB_LAST_TS)} (${DB_LAST_SRC})`; }
setInterval(renderDbInd,1000); renderDbInd();

/* ===== Data state ===== */
let USERS=load(DB_USERS), ACTIONS=load(DB_ACTIONS), ROLES=load(DB_ROLES), ACTIVITY=load(DB_ACTIVITY), ARCHIVE=load(DB_ARCHIVE);
let ME=null, ACTIVE_ROLE=null;
let CURRENT_VIEW='events', CURRENT_EDIT_ID=null;

/* ===== Seed ===== */
(function seed(){
  if(!ROLES.length){ ROLES=[{key:'ridic',label:'≈òidiƒç',isPublic:true},{key:'zza',label:'ZZA',isPublic:true},{key:'zdravotnik',label:'Zdravotn√≠k',isPublic:true},{key:'support',label:'Podpora',isPublic:false}]; save(DB_ROLES,ROLES); }
  if(!USERS.length){
    USERS=[
      {id:'u1',name:'Podpora',password:'support',roles:['support','admin'],isActive:true},
      {id:'u2',name:'admin',password:'1111',roles:['admin'],isActive:true},
      {id:'u3',name:'Adam',password:'adam',roles:['ridic','zza'],isActive:true},
      {id:'u4',name:'B√°ra',password:'bara',roles:['zdravotnik'],isActive:true}
    ];
    save(DB_USERS,USERS);
  }
  if(!ACTIONS.length){ const cap={}, su={}; ['ridic','zza','zdravotnik'].forEach(k=>{ cap[k]=(k==='zza'?2:1); su[k]=[]; }); ACTIONS=[{id:'a1',date:today(),title:'Dozor ‚Äì fotbal',location:'Stadion Kladno',timeFrom:'15:00',timeTo:'20:00',capacity:cap,signups:su,signupUnlock:null,isPaid:false,adminNote:''}]; save(DB_ACTIONS,ACTIONS); }
  if(!ACTIVITY.length) save(DB_ACTIVITY,[]);
  if(!ARCHIVE.length) save(DB_ARCHIVE,[]);
})();

/* ===== Helpers ===== */
function getUserById(id){ return (USERS||[]).find(u=>u.id===id)||null; }
function userHasRole(u,r){ return (u?.roles||[]).includes(r); }
function getPublicRoleKeys(){ return (ROLES||[]).filter(r=>r.isPublic).map(r=>r.key); }
function roleLabel(k){ return (ROLES||[]).find(r=>r.key===k)?.label||k; }
function userPublicRoles(u){ const pubs=getPublicRoleKeys(); return (u?.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){ if(!ME){ACTIVE_ROLE=null;return;} const prs=userPublicRoles(ME); if(!prs.length){ACTIVE_ROLE=null;return;} if(!ACTIVE_ROLE||!prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE=prs[0]; }
function isSupportUser(u){ return !!u && ((u.roles||[]).includes('support') || ((u?.name||'').trim().toLowerCase()==='podpora')); }
function isPrivileged(){ return ME && (userHasRole(ME,'admin') || userHasRole(ME,'support')); }

/* === skryt√≠ role/u≈æivatele "support" p≈ôed adminem === */
function canSeeRoleKey(key){ return !(key==='support' && !isSupportUser(ME)); }
function canSeeRoleObj(r){ return canSeeRoleKey(r?.key); }
function canSeeUser(u){ if(isSupportUser(ME)) return true; return !userHasRole(u,'support'); }

/* === Aktivita (log) === */
function logActivity(type, eventId, eventTitle, detail){
  ACTIVITY=load(DB_ACTIVITY);
  ACTIVITY.push({ ts:Date.now(), type, eventId, eventTitle, detail, userId:ME?.id, userName:ME?.name });
  save(DB_ACTIVITY, ACTIVITY);
  DB_LAST_TS=Date.now(); DB_LAST_SRC='save'; renderDbInd();
}
function historyForEvent(eid, limit=20){
  return (load(DB_ACTIVITY)||[]).filter(a=>a.eventId===eid).sort((a,b)=>b.ts-a.ts).slice(0,limit);
}

/* === pomoc: update eventu v aktivn√≠ch i v archivu === */
function updateEventBoth(aid, updater, log){
  let changed = false;
  ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid);
  if(a){ updater(a); save(DB_ACTIONS,ACTIONS); changed=true; }
  ARCHIVE=load(DB_ARCHIVE);
  const p=ARCHIVE.find(x=>x.id===aid);
  if(p){ updater(p); save(DB_ARCHIVE,ARCHIVE); changed=true; }
  if(changed){
    DB_LAST_TS=Date.now(); DB_LAST_SRC='save';
    if(log) log();
    renderApp();
  }
}

/* ===== Header + Login ===== */
function renderHeader(){
  const el=$('#hdr'); if(!ME){ el.innerHTML=''; return; }
  ensureActiveRole();
  const prs=userPublicRoles(ME);
  const roleSel=(ACTIVE_ROLE && prs.length)?`<select class="select" id="selActiveRole">${prs.map(r=>`<option value="${r}" ${r===ACTIVE_ROLE?'selected':''}>${roleLabel(r)}</option>`).join('')}</select>`:`<span class="muted">Bez ve≈ôejn√© role</span>`;
  el.innerHTML=`
    <div class="row">
      <span class="badge">${ME.name}</span>
      ${roleSel}
      ${isPrivileged()? `
        <div class="menu" id="adminMenu">
          <button class="btn" id="adminBtn" type="button">Admin ‚ñæ</button>
          <div class="dropdown">
            <button type="button" onclick="viewEvents()">Ud√°losti</button>
            <button type="button" onclick="viewPastEvents()">Probƒõhl√© akce</button>
            <button type="button" onclick="viewMembers()">ƒålenov√©</button>
            <button type="button" onclick="viewRoles()">Role</button>
            <button type="button" onclick="viewActivity()">Aktivita</button>
            <button type="button" onclick="viewCreateEvent()">Nov√° ud√°lost</button>
            ${isSupportUser(ME)?`<button type="button" onclick="viewExport()">Export / Z√°loha</button>`:''}
          </div>
        </div>`:''}
      <button class="btn" type="button" onclick="logout()">Odhl√°sit</button>
    </div>`;
  const sel=document.getElementById('selActiveRole'); if(sel) sel.onchange=()=>{ ACTIVE_ROLE=sel.value; renderApp(); };
  const menu=document.getElementById('adminMenu'); if(menu){ const btn=document.getElementById('adminBtn'); btn.addEventListener('click',(e)=>{e.stopPropagation();menu.classList.toggle('open');}); document.addEventListener('click',(e)=>{ if(!menu.contains(e.target)) menu.classList.remove('open'); }); }
}

function viewLogin(){
  const app=$('#app');
  app.innerHTML=`
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>P≈ôihl√°≈°en√≠</h3>
      <input id="loginName" class="input" placeholder="Jm√©no">
      <div class="row" style="justify-content:space-between;width:100%">
        <input id="loginPass" class="input" type="password" placeholder="Heslo" style="flex:1">
        <button class="btn" id="togglePass" type="button">üëÅÔ∏è</button>
      </div>
      <button class="btn primary" id="btnLogin" type="button">P≈ôihl√°sit</button>
    </div>`;
  document.getElementById('togglePass').onclick=()=>{ const i=document.getElementById('loginPass'); i.type=(i.type==='password'?'text':'password'); };
  document.getElementById('btnLogin').onclick=()=>{
    const n=document.getElementById('loginName').value.trim();
    const p=document.getElementById('loginPass').value;
    USERS=load(DB_USERS);
    const u=(USERS||[]).find(x=>x.name===n && x.password===p && x.isActive!==false);
    if(!u){ alert('Neplatn√© √∫daje'); return; }
    ME=u; localStorage.setItem(DB_SESSION, ME.id); ensureActiveRole();
    CURRENT_VIEW='events'; CURRENT_EDIT_ID=null;
    renderApp();
  };
}

/* ===== Events / Archive ===== */
function safeHHMM(s){ return /^\d{2}:\d{2}$/.test(s||'')?s:''; }
function eventEndMs(a){ const d=a?.date||today(); const end=safeHHMM(a?.timeTo)||safeHHMM(a?.timeFrom)||'23:59'; const t=new Date(`${d}T${end}`).getTime(); return isNaN(t)?new Date(`${d}T23:59`).getTime():t; }
function isPastEvent(a){ return nowMs()>eventEndMs(a); }
function getUnlockMs(a){ if(!a||!a.signupUnlock) return 0; const ms=new Date(a.signupUnlock).getTime(); return isNaN(ms)?0:ms; }
function sortEvents(a,b){ const A=(a.date||'')+' '+(a.timeFrom||'00:00'); const B=(b.date||'')+' '+(b.timeFrom||'00:00'); return A.localeCompare(B); }
function archiveSweep(){ let acts=load(DB_ACTIONS); let arc=load(DB_ARCHIVE); const toMove=(acts||[]).filter(isPastEvent); if(!toMove.length) return; const keep=acts.filter(a=>!isPastEvent(a)); ACTIONS=keep; save(DB_ACTIONS,ACTIONS); const moved=toMove.slice().sort(sortEvents).reverse(); arc=[...moved,...arc]; ARCHIVE=arc; save(DB_ARCHIVE,arc); }

/* === admin/podpora: p≈ôi≈ôazen√≠/odebr√°n√≠ ƒçlen≈Ø na ud√°lost === */
function candidatesForRole(roleKey, a){
  return load(DB_USERS)
    .filter(u=>u.isActive!==false)
    .filter(canSeeUser)
    .filter(u=>userHasRole(u, roleKey))
    .filter(u=>!(a.signups?.[roleKey]||[]).includes(u.id));
}
function assignMember(aid, roleKey, uid){
  if(!isPrivileged()) return;
  ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid); if(!a) return;
  a.signups[roleKey]=a.signups[roleKey]||[];
  if(!a.signups[roleKey].includes(uid)){
    a.signups[roleKey].push(uid);
    save(DB_ACTIONS,ACTIONS);
    const u=getUserById(uid);
    toast('P≈ôi≈ôazen ƒçlen', `${u?.name||uid} ‚Üí ${roleLabel(roleKey)}`);
    logActivity('assign', a.id, a.title, `${u?.name||uid} (${roleLabel(roleKey)})`);
    renderApp();
  }
}
function removeMember(aid, roleKey, uid){
  if(!isPrivileged()) return;
  ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid); if(!a) return;
  a.signups[roleKey]=(a.signups[roleKey]||[]).filter(x=>x!==uid);
  save(DB_ACTIONS,ACTIONS);
  const u=getUserById(uid);
  toast('Odebr√°n ƒçlen', `${u?.name||uid} z ${roleLabel(roleKey)}`);
  logActivity('unassign', a.id, a.title, `${u?.name||uid} (${roleLabel(roleKey)})`);
  renderApp();
}

/* === admin: pozn√°mka + zaplaceno (aktualizace i v archivu) === */
function setEventPaid(aid, paid){
  if(!isPrivileged()) return;
  updateEventBoth(aid, (ev)=>{ ev.isPaid=!!paid; }, ()=>logActivity('paid', aid, (load(DB_ACTIONS).find(x=>x.id===aid)||{}).title, paid?'1':'0'));
  toast(paid?'Oznaƒçeno jako zaplaceno':'Zru≈°eno zaplaceno');
}
function saveEventNote(aid, text){
  if(!isPrivileged()) return;
  updateEventBoth(aid, (ev)=>{ ev.adminNote=(text||''); }, ()=>logActivity('note', aid, (load(DB_ACTIONS).find(x=>x.id===aid)||{}).title, (text||'').slice(0,120)));
  toast('Pozn√°mka ulo≈æena');
}

function isMeSignedInEvent(a){
  if(!ME) return false;
  const roles=Object.keys(a.signups||{});
  for(const r of roles){ const arr=a.signups[r]||[]; if(arr.includes(ME.id)) return true; }
  return false;
}

function viewEvents(){
  CURRENT_VIEW='events';
  try{ archiveSweep(); }catch(e){ console.warn('archiveSweep error', e); }
  const app=$('#app');
  ensureActiveRole();
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS); ROLES=load(DB_ROLES);
  const pubs=getPublicRoleKeys();
  const cards=(ACTIONS||[]).slice().sort(sortEvents).map(a=>{
    // seznamy + odebr√°n√≠
    const capHtml=pubs.map(r=>{
      const list=a.signups?.[r]||[];
      const names=list.map(id=>{
        const u=getUserById(id)||{};
        const rm = isPrivileged()? ` <button class="x" title="Odebrat" onclick="removeMember('${a.id}','${r}','${id}')">√ó</button>` : '';
        return `<span class="chip">${u.name||id}${rm}</span>`;
      }).join(' ');
      return `<li><b>${roleLabel(r)}</b>: ${list.length}/${(a.capacity?.[r]||0)} ‚Äî ${names||'‚Äî'}</li>`;
    }).join('');

    // p≈ôihla≈°ov√°n√≠
    const unlockMs=getUnlockMs(a);
    const isOpen=(unlockMs===0||nowMs()>=unlockMs);
    let actionBtn='';
    if(!ME) actionBtn=`<span class="muted">P≈ôihla≈°ov√°n√≠ a≈æ po p≈ôihl√°≈°en√≠</span>`;
    else if(!isOpen){ const when=a.signupUnlock?new Date(a.signupUnlock).toLocaleString():''; actionBtn=`<span class="muted">P≈ôihla≈°ov√°n√≠ se otev≈ôe: <b>${when}</b></span>`; }
    else if(ACTIVE_ROLE){
      const my=a.signups[ACTIVE_ROLE]||[]; const isIn=my.includes(ME.id);
      actionBtn = isIn ? `<button class="btn danger" type="button" onclick="leaveEvent('${a.id}')">Odhl√°sit se</button>`
                       : (my.length>=(a.capacity[ACTIVE_ROLE]||0) ? `<span class="muted">Kapacita pro roli ${roleLabel(ACTIVE_ROLE)} je pln√°</span>`
                         : `<button class="btn primary" type="button" onclick="joinEvent('${a.id}')">P≈ôihl√°sit se</button>`);
    } else actionBtn=`<span class="muted">Nem√°te vybranou ve≈ôejnou roli</span>`;

    const mine=isMeSignedInEvent(a);
    const minePill = mine ? `<span class="pill mine-pill">‚úî P≈ôihl√°≈°en</span>` : '';

    // admin assign UI
    const adminAssign = isPrivileged()? `
      <div class="admin-box small" style="margin-top:8px">
        <b>Ruƒçn√≠ p≈ôi≈ôazen√≠:</b>
        <div class="grid3" style="margin-top:6px">
          ${pubs.map(r=>{
            const opts=candidatesForRole(r,a).map(u=>`<option value="${u.id}">${u.name}</option>`).join('');
            const disabled = opts? '' : 'disabled';
            const selId = \`sel_${a.id}_${r}\`;
            return `<div>
                <label>${roleLabel(r)}</label>
                <div class="row" style="margin-top:4px">
                  <select id="${selId}" class="select">${opts||'<option>‚Äî</option>'}</select>
                  <button class="btn" ${disabled} type="button" onclick="(function(){ const v=document.getElementById('${selId}').value; if(v) assignMember('${a.id}','${r}',v); })()">P≈ôidat</button>
                </div>
              </div>`;
          }).join('')}
        </div>
      </div>` : '';

    // admin: zaplaceno + pozn√°mka
    const adminFinance = isPrivileged()? `
      <div class="admin-box small" style="margin-top:8px">
        <div class="row">
          <label class="row" style="gap:6px">
            <input type="checkbox" ${a.isPaid?'checked':''} onchange="setEventPaid('${a.id}', this.checked)"> Zaplaceno
          </label>
          ${a.isPaid?'<span class="badge paid">Zaplaceno</span>':''}
        </div>
        <div style="margin-top:6px">
          <label>Pozn√°mka pro adminy</label>
          <textarea id="note_${a.id}" class="textarea" placeholder="Intern√≠ pozn√°mka...">${a.adminNote||''}</textarea>
          <div class="row" style="justify-content:flex-end;margin-top:6px">
            <button class="btn" type="button" onclick="saveEventNote('${a.id}', document.getElementById('note_${a.id}').value)">Ulo≈æit pozn.</button>
          </div>
          <div class="muted small">Ulo≈æ√≠ se i do ‚ÄûProbƒõhl√Ωch‚Äú (p≈ôi p≈ôesunu nebo pokud u≈æ je v archivu).</div>
        </div>
      </div>` : '';

    // historie
    const hist = historyForEvent(a.id, 20).map(h=>{
      const at=new Date(h.ts).toLocaleString();
      const who = h.userName || h.userId || 'u≈æivatel';
      const det = h.detail? ` ‚Äî <span class="muted">${h.detail}</span>` : '';
      return `<li>${at}: <b>${who}</b> ‚Äî ${h.type}${det}</li>`;
    }).join('') || '<li class="muted">≈Ω√°dn√© z√°znamy.</li>';

    const adminControls = isPrivileged()? `
      <div class="row">
        <button class="btn" type="button" onclick="editEvent('${a.id}')">Upravit</button>
        <button class="btn danger" type="button" onclick="deleteEvent('${a.id}')">Smazat</button>
      </div>` : '';

    return `
      <div class="card ${mine?'event-mine':''}">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700">${a.title} ${minePill} ${a.isPaid?'<span class="badge paid" title="Zaplaceno">Zaplaceno</span>':''}</div>
            <div class="muted">${a.date} ‚Ä¢ ${a.location||'‚Äî'} ‚Ä¢ ${(a.timeFrom||'')}${a.timeTo?('‚Äì'+a.timeTo):''}</div>
            ${a.signupUnlock? `<div class="muted small">Odemknut√≠ p≈ôihla≈°ov√°n√≠: <b>${new Date(a.signupUnlock).toLocaleString()}</b></div>` : ''}
          </div>
          ${adminControls}
        </div>
        <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>
        ${adminAssign}
        ${adminFinance}
        <div class="row" style="margin-top:8px">${actionBtn}</div>
        <details style="margin-top:10px">
          <summary><b>Historie akce</b></summary>
          <div class="card" style="margin-top:8px">
            <ul class="list-plain">${hist}</ul>
          </div>
        </details>
      </div>`;
  }).join('');
  app.innerHTML=`<h3>Ud√°losti</h3>${cards || '<div class="card muted">≈Ω√°dn√© ud√°losti.</div>'}`;
}

function viewPastEvents(){
  CURRENT_VIEW='past';
  try{ archiveSweep(); }catch(e){ console.warn('archiveSweep error', e); }
  const app=$('#app');
  const pubs=getPublicRoleKeys();
  const cards=(load(DB_ARCHIVE)||[]).map(a=>{
    const capHtml=pubs.map(r=>{
      const list=a.signups?.[r]||[];
      const names=list.map(id=>(getUserById(id)||{}).name).filter(Boolean).join(', ');
      return `<li><b>${roleLabel(r)}</b>: ${list.length}/${(a.capacity?.[r]||0)} ‚Äî ${names||'‚Äî'}</li>`;
    }).join('');
    const hist = historyForEvent(a.id, 20).map(h=>{
      const at=new Date(h.ts).toLocaleString();
      const who = h.userName || h.userId || 'u≈æivatel';
      const det = h.detail? ` ‚Äî <span class="muted">${h.detail}</span>` : '';
      return `<li>${at}: <b>${who}</b> ‚Äî ${h.type}${det}</li>`;
    }).join('') || '<li class="muted">≈Ω√°dn√© z√°znamy.</li>';
    const adminInfo = isPrivileged()? `
      <div class="row" style="gap:8px;margin-top:6px">
        ${a.isPaid?'<span class="badge paid">Zaplaceno</span>':''}
        ${(a.adminNote||'').trim()?`<span class="badge">Pozn.: ${(a.adminNote||'').trim()}</span>`:''}
      </div>` : '';

    return `<div class="card">
      <div style="font-weight:700">${a.title} ${a.isPaid?'<span class="badge paid" title="Zaplaceno">Zaplaceno</span>':''}</div>
      <div class="muted">${a.date} ‚Ä¢ ${a.location||'‚Äî'} ‚Ä¢ ${(a.timeFrom||'')}${a.timeTo?('‚Äì'+a.timeTo):''}</div>
      ${adminInfo}
      <ul class="list-plain" style="margin-top:8px">${capHtml}</ul>
      <details style="margin-top:10px">
        <summary><b>Historie akce</b></summary>
        <div class="card" style="margin-top:8px">
          <ul class="list-plain">${hist}</ul>
        </div>
      </details>
    </div>`;
  }).join('');
  app.innerHTML=`<h3>Probƒõhl√© akce</h3>${cards || '<div class="card muted">≈Ω√°dn√© z√°znamy.</div>'}`;
}


/* ===== Join/Leave, Delete ===== */
function inRoleCapacity(a, roleKey){ const cap=(a.capacity?.[roleKey]||0); const list=a.signups?.[roleKey]||[]; return list.length<cap; }
function joinEvent(aid){
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid); if(!a||!ME) return;
  const unlockMs=getUnlockMs(a); if(unlockMs!==0 && nowMs()<unlockMs){ alert('P≈ôihla≈°ov√°n√≠ je≈°tƒõ nen√≠ otev≈ôen√©.'); return; }
  ensureActiveRole(); if(!ACTIVE_ROLE){ alert('Nem√°te vybranou ve≈ôejnou roli'); return; }
  a.signups[ACTIVE_ROLE]=a.signups[ACTIVE_ROLE]||[];
  if(a.signups[ACTIVE_ROLE].includes(ME.id)){ toast('U≈æ jste p≈ôihl√°≈°en.'); renderApp(); return; }
  if(!inRoleCapacity(a, ACTIVE_ROLE)){ toast('Kapacita t√©to role je pln√°.'); return; }
  a.signups[ACTIVE_ROLE].push(ME.id);
  save(DB_ACTIONS,ACTIONS);
  toast('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©', a.title);
  logActivity('join', a.id, a.title, `${ME.name} (${roleLabel(ACTIVE_ROLE)})`);
  renderApp();
}
function leaveEvent(aid){
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid); if(!a||!ME||!ACTIVE_ROLE) return;
  a.signups[ACTIVE_ROLE]=(a.signups[ACTIVE_ROLE]||[]).filter(x=>x!==ME.id);
  save(DB_ACTIONS,ACTIONS);
  toast('Odhl√°≈°en√≠ √∫spƒõ≈°n√©', a.title);
  logActivity('leave', a.id, a.title, `${ME.name} (${roleLabel(ACTIVE_ROLE)})`);
  renderApp();
}
function deleteEvent(aid){
  if(!isPrivileged()) return;
  if(!confirm('Smazat ud√°lost?')) return;
  ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid);
  ACTIONS=ACTIONS.filter(x=>x.id!==aid);
  save(DB_ACTIONS,ACTIONS);
  toast('Ud√°lost smaz√°na', a?.title||'');
  logActivity('delete', aid, a?.title||aid);
  renderApp();
}

/* ===== Create/Edit events ===== */
function viewCreateEvent(editId=null){
  if(!isPrivileged()) return;
  CURRENT_VIEW='create'; CURRENT_EDIT_ID=editId;
  const app=$('#app');
  ACTIONS=load(DB_ACTIONS);
  let a = editId ? ACTIONS.find(x=>x.id===editId) : null;
  if(editId && !a){ app.innerHTML='<div class="card">Ud√°lost nenalezena.</div>'; return; }

  const date=a?.date || today();
  const title=a?.title || '';
  const location=a?.location || '';
  const tFrom=a?.timeFrom || '';
  const tTo=a?.timeTo || '';
  const unlock = a?.signupUnlock || '';

  const pubs=getPublicRoleKeys();
  const caps = pubs.map(k=>{
    const v = a?.capacity?.[k] ?? (k==='zza'?2:1);
    return `<div><label>${roleLabel(k)} kapacita<input class="input" id="cap_${k}" type="number" min="0" value="${v}"></label></div>`;
  }).join('');

  app.innerHTML=`
    <h3>${editId?'Upravit ud√°lost':'Nov√° ud√°lost'}</h3>
    <div class="card">
      <div class="grid3">
        <label>Kdy (datum)<input id="ev_date" class="input" type="date" value="${date}"></label>
        <label>Od<input id="ev_from" class="input" placeholder="HH:MM" value="${tFrom}"></label>
        <label>Do<input id="ev_to" class="input" placeholder="HH:MM" value="${tTo}"></label>
      </div>
      <div class="grid2" style="margin-top:8px">
        <label>N√°zev<input id="ev_title" class="input" value="${title}"></label>
        <label>M√≠sto<input id="ev_loc" class="input" value="${location}"></label>
      </div>
      <div class="grid2" style="margin-top:8px">
        <label>P≈ôihla≈°ov√°n√≠ spu≈°tƒõno od<input id="ev_unlock" class="input" type="datetime-local" value="${unlock? new Date(unlock).toISOString().slice(0,16):''}"></label>
        <div></div>
      </div>
      <div class="grid3" style="margin-top:8px">${caps}</div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" type="button" onclick="viewEvents()">Zpƒõt</button>
        <button class="btn primary" type="button" onclick="saveEvent('${editId||''}')">${editId?'Ulo≈æit zmƒõny':'Vytvo≈ôit'}</button>
      </div>
    </div>`;
}

function saveEvent(editId){
  if(!isPrivileged()){ alert('Jen admin/podpora'); return; }
  const d=(document.getElementById('ev_date')?.value||'').trim();
  const f=(document.getElementById('ev_from')?.value||'').trim();
  const t=(document.getElementById('ev_to')?.value||'').trim();
  const ti=(document.getElementById('ev_title')?.value||'').trim();
  const lo=(document.getElementById('ev_loc')?.value||'').trim();
  const un=(document.getElementById('ev_unlock')?.value||'').trim();
  const unlock= un? new Date(un).toISOString(): null;
  const pubs=getPublicRoleKeys();
  const cap={}; pubs.forEach(k=>{ const v=parseInt(document.getElementById('cap_'+k)?.value||'0',10); cap[k]=isNaN(v)?0:v; });

  ACTIONS=load(DB_ACTIONS);
  if(editId){
    const a=ACTIONS.find(x=>x.id===editId);
    if(!a){ alert('Ud√°lost nenalezena'); return; }
    a.date=d; a.timeFrom=f; a.timeTo=t; a.title=ti; a.location=lo; a.signupUnlock=unlock; a.capacity=cap;
    save(DB_ACTIONS,ACTIONS);
    toast('Ud√°lost upravena', a.title);
    logActivity('edit', a.id, a.title);
  }else{
    const su={}; pubs.forEach(k=> su[k]=[] );
    const a={ id: uid(), date:d, timeFrom:f, timeTo:t, title:ti, location:lo, signupUnlock:unlock, capacity:cap, signups:su, isPaid:false, adminNote:'' };
    ACTIONS.push(a); save(DB_ACTIONS,ACTIONS);
    toast('Ud√°lost vytvo≈ôena', a.title);
    logActivity('create', a.id, a.title);
  }
  viewEvents();
}

/* ===== Members (with password & roles management) ===== */
function viewMembers(){
  CURRENT_VIEW='members';
  USERS=load(DB_USERS); ROLES=load(DB_ROLES);
  const app=$('#app');

  const roleChips = (u)=>{
    const chips=(u.roles||[])
      .filter(rk=>canSeeRoleKey(rk))
      .map(rk=>`<span class="chip">${roleLabel(rk)}<button class="btn ghost danger" type="button" onclick="toggleUserRole('${u.id}','${rk}',false)">√ó</button></span>`)
      .join('');
    return chips || '<span class="muted">‚Äî</span>';
  };

  const roleCheckboxes = (u)=>{
    const set=new Set(u.roles||[]);
    return ROLES.filter(canSeeRoleObj).map(r=>`
      <label class="row" style="gap:6px">
        <input type="checkbox" ${set.has(r.key)?'checked':''} onchange="toggleUserRole('${u.id}','${r.key}', this.checked)">
        ${r.label} <span class="muted">(${r.key})</span>
      </label>
    `).join('');
  };

  const rows=USERS
    .filter(canSeeUser)
    .map(u=>`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${u.name}</b> <span class="muted">(${u.isActive?'aktivn√≠':'deaktivov√°n'})</span></div>
          <div class="muted">Role: ${roleChips(u)}</div>
        </div>
        ${isPrivileged()?`
          <div class="row">
            <button class="btn" type="button" onclick="toggleActive('${u.id}')">${u.isActive?'Deaktivovat':'Aktivovat'}</button>
            <button class="btn danger" type="button" onclick="deleteUser('${u.id}')">Smazat</button>
          </div>`:''}
      </div>

      ${isPrivileged()?`
        <div class="admin-box" style="margin-top:8px">
          <div class="grid3">
            <label>Jm√©no<input class="input" id="un_${u.id}" value="${u.name}" /></label>
            <label>Heslo (viditeln√©)<input class="input" id="up_${u.id}" value="${u.password||''}" /></label>
            <label>Aktivn√≠<input type="checkbox" id="ua_${u.id}" ${u.isActive?'checked':''} /></label>
          </div>
          <div class="grid3" style="margin-top:8px">
            <div>
              <b>P≈ôi≈ôadit role</b>
              <div style="margin-top:6px">${roleCheckboxes(u)}</div>
            </div>
            <div></div><div></div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button class="btn primary" type="button" onclick="saveUserInline('${u.id}')">Ulo≈æit zmƒõny</button>
          </div>
        </div>`:''}
    </div>
  `).join('');

  const addBox = isPrivileged()?`
    <div class="card" style="margin-top:12px">
      <h4>P≈ôidat ƒçlena</h4>
      <div class="grid3">
        <input id="newName" class="input" placeholder="Jm√©no">
        <input id="newPass" class="input" placeholder="Heslo">
        <label class="row" style="gap:6px"><input type="checkbox" id="newActive" checked> Aktivn√≠</label>
      </div>
      <div style="margin-top:8px">
        <b>Role</b>
        <div id="newRoles" style="margin-top:6px">
          ${ROLES.filter(canSeeRoleObj).map(r=>`
            <label class="row" style="gap:6px">
              <input type="checkbox" value="${r.key}"> ${r.label} <span class="muted">(${r.key})</span>
            </label>`).join('')}
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn primary" type="button" onclick="addUser()">P≈ôidat</button>
      </div>
    </div>` : '';

  const appEl=$('#app');
  appEl.innerHTML=`<h3>ƒålenov√©</h3>${rows}${addBox}`;
}

function toggleUserRole(uid, roleKey, on){
  USERS=load(DB_USERS);
  const u=getUserById(uid); if(!u) return;
  if(!isSupportUser(ME) && (userHasRole(u,'support') || roleKey==='support')) return;
  u.roles=u.roles||[];
  const has=u.roles.includes(roleKey);
  if(on===false || (on===undefined && has)){ u.roles=u.roles.filter(r=>r!==roleKey); }
  else if(!has){ u.roles.push(roleKey); }
  save(DB_USERS,USERS);
  logActivity('user-role', null, null, `${u.name}: ${roleKey} ${on?'on':'off'}`);
  viewMembers();
}

function saveUserInline(uid){
  USERS=load(DB_USERS);
  const u=getUserById(uid); if(!u) return;
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;
  const n=document.getElementById('un_'+uid)?.value?.trim()||u.name;
  const p=document.getElementById('up_'+uid)?.value||u.password;
  const a=!!document.getElementById('ua_'+uid)?.checked;
  u.name=n; u.password=p; u.isActive=a;
  save(DB_USERS,USERS);
  toast('U≈æivatel ulo≈æen', u.name);
  viewMembers();
}

function toggleActive(uid){
  USERS=load(DB_USERS);
  const u=getUserById(uid); if(!u) return;
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;
  u.isActive=!u.isActive;
  save(DB_USERS,USERS);
  viewMembers();
}
function deleteUser(uid){
  USERS=load(DB_USERS);
  const u=getUserById(uid); if(!u) return;
  if(!isSupportUser(ME) && userHasRole(u,'support')) return;
  if(!confirm('Opravdu smazat u≈æivatele?')) return;
  USERS=USERS.filter(x=>x.id!==uid);
  save(DB_USERS,USERS);
  viewMembers();
}
function addUser(){
  const n=$('#newName').value.trim();
  const p=$('#newPass').value.trim();
  const a=$('#newActive').checked;
  if(!n||!p) return alert('Vypl≈à jm√©no i heslo');
  const rks=[...document.querySelectorAll('#newRoles input[type=checkbox]:checked')].map(i=>i.value);
  USERS=load(DB_USERS);
  USERS.push({id:uid(),name:n,password:p,roles:rks,isActive:a});
  save(DB_USERS,USERS);
  viewMembers();
}

/* ===== Roles (CRUD) ===== */
function viewRoles(){
  CURRENT_VIEW='roles';
  ROLES=load(DB_ROLES);
  const app=$('#app');

  const list=ROLES.filter(canSeeRoleObj).map(r=>`
    <div class="card">
      <b>${r.label}</b> <span class="muted">(${r.key})</span> ‚Ä¢ ${r.isPublic?'ve≈ôejn√°':'neve≈ôejn√°'}
      ${isPrivileged()?`
      <div class="row" style="margin-top:6px">
        <button class="btn" type="button" onclick="editRoleOpen('${r.key}')">Upravit</button>
        <button class="btn danger" type="button" onclick="deleteRole('${r.key}')">Smazat</button>
      </div>`:''}
    </div>`).join('');

  const addBox = isPrivileged()?`
    <div class="card" style="margin-top:12px">
      <h4>Nov√° role</h4>
      <input id="newRoleKey" class="input" placeholder="kl√≠ƒç (nap≈ô. ridic)">
      <input id="newRoleLabel" class="input" placeholder="Popisek (≈òidiƒç)">
      <label class="row" style="gap:6px"><input type="checkbox" id="newRolePublic" checked> Ve≈ôejn√° role</label>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button class="btn primary" type="button" onclick="addRole()">P≈ôidat roli</button>
      </div>
    </div>` : '';

  app.innerHTML=`<h3>Role</h3>${list}${addBox}`;
}
function editRoleOpen(key){
  if(!canSeeRoleKey(key)) { viewRoles(); return; }
  ROLES=load(DB_ROLES);
  const r=ROLES.find(x=>x.key===key); if(!r) return;
  const app=$('#app');
  app.innerHTML=`
    <h3>Upravit roli</h3>
    <div class="card">
      <label>Kl√≠ƒç<input class="input" id="er_key" value="${r.key}" disabled></label>
      <label>Popisek<input class="input" id="er_label" value="${r.label}"></label>
      <label class="row" style="gap:6px"><input type="checkbox" id="er_pub" ${r.isPublic?'checked':''}> Ve≈ôejn√° role</label>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn" type="button" onclick="viewRoles()">Zpƒõt</button>
        <button class="btn primary" type="button" onclick="saveRole()">Ulo≈æit</button>
      </div>
    </div>`;
}
function saveRole(){
  const key=document.getElementById('er_key').value;
  if(!canSeeRoleKey(key)) { viewRoles(); return; }
  const label=document.getElementById('er_label').value.trim();
  const pub=document.getElementById('er_pub').checked;
  ROLES=load(DB_ROLES);
  const r=ROLES.find(x=>x.key===key); if(!r) return;
  r.label=label; r.isPublic=pub;
  save(DB_ROLES,ROLES);
  toast('Role ulo≈æena', r.label);
  viewRoles();
}
function deleteRole(key){
  if(!canSeeRoleKey(key)) { viewRoles(); return; }
  if(!confirm('Smazat roli?')) return;
  ROLES=load(DB_ROLES).filter(r=>r.key!==key);
  USERS=load(DB_USERS).map(u=>({ ...u, roles:(u.roles||[]).filter(rk=>rk!==key) }));
  save(DB_ROLES,ROLES); save(DB_USERS,USERS);
  viewRoles();
}
function addRole(){
  const k=$('#newRoleKey').value.trim();
  const l=$('#newRoleLabel').value.trim();
  const pub=$('#newRolePublic').checked;
  if(!k||!l) return alert('Vypl≈à kl√≠ƒç i popisek');
  if(k==='support' && !isSupportUser(ME)) return alert('Tuto roli m≈Ø≈æe spravovat jen Podpora.');
  ROLES=load(DB_ROLES);
  if(ROLES.find(r=>r.key===k)) return alert('Role s t√≠mto kl√≠ƒçem u≈æ existuje');
  ROLES.push({key:k,label:l,isPublic:pub});
  save(DB_ROLES,ROLES);
  viewRoles();
}

/* ===== Activity, Export ===== */
function viewActivity(){ CURRENT_VIEW='activity'; const app=$('#app'); const list=(load(DB_ACTIVITY)||[]).slice(-200).reverse().map(a=>{ const ts=new Date(a.ts).toLocaleString(); return `<li>${ts}: <b>${a.userName||a.userId||'u≈æivatel'}</b> ‚Äî ${a.type} ${a.eventTitle?('('+a.eventTitle+')'):''} ${a.detail?('‚Äî '+a.detail):''}</li>`; }).join(''); app.innerHTML=`<h3>Aktivita</h3><div class="card"><ul class="list-plain">${list||'<li class="muted">≈Ω√°dn√° aktivita.</li>'}</ul></div>`; }
function viewExport(){ if(!isSupportUser(ME)){ CURRENT_VIEW='events'; viewEvents(); return; } CURRENT_VIEW='export'; const app=$('#app'); app.innerHTML=`<h3>Export / Z√°loha</h3><div class="card"><div class="row"><button class="btn" type="button" onclick="downloadJson()">St√°hnout JSON</button></div></div>`; }
function downloadJson(){ const data={users:load(DB_USERS),roles:load(DB_ROLES),actions:load(DB_ACTIONS),archive:load(DB_ARCHIVE),activity:load(DB_ACTIVITY)}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='smenar_backup.json'; a.click(); }

/* ===== Router + Auto refresh ===== */
function renderApp(){
  try{
    renderHeader();
    if(!ME){
      const sid=localStorage.getItem(DB_SESSION);
      if(sid){ USERS=load(DB_USERS); const u=getUserById(sid); if(u && u.isActive!==false){ ME=u; ensureActiveRole(); } else localStorage.removeItem(DB_SESSION); }
    }
    if(!ME){ viewLogin(); return; }
    if(CURRENT_VIEW==='export' && !isSupportUser(ME)) CURRENT_VIEW='events';

    switch(CURRENT_VIEW){
      case 'create': viewCreateEvent(CURRENT_EDIT_ID); break;
      case 'members': viewMembers(); break;
      case 'roles': viewRoles(); break;
      case 'activity': viewActivity(); break;
      case 'past': viewPastEvents(); break;
      case 'export': viewExport(); break;
      default: viewEvents();
    }
  }catch(e){
    const el=document.getElementById('err'); if(el){ el.textContent='Render error: '+(e.message||e); el.style.display='block'; }
    console.error('Render error', e);
  }
}
renderApp();

/* Auto-refresh local DB ka≈æd√Ωch 30 s (mimo editor) */
setInterval(()=>{
  if(CURRENT_VIEW==='create') return; // nevyru≈°it editaci
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS); ROLES=load(DB_ROLES); ACTIVITY=load(DB_ACTIVITY); ARCHIVE=load(DB_ARCHIVE);
  DB_LAST_TS=Date.now(); DB_LAST_SRC='auto';
  renderApp();
}, 30000);

/* ===== Global handlers ===== */
window.viewCreateEvent=viewCreateEvent;
window.saveEvent=saveEvent;
window.editEvent=function(aid){ viewCreateEvent(aid); };
window.deleteEvent=deleteEvent;
window.viewEvents=viewEvents;
window.viewPastEvents=viewPastEvents;
window.viewMembers=viewMembers;
window.viewRoles=viewRoles;
window.viewActivity=viewActivity;
window.viewExport=viewExport;
window.joinEvent=joinEvent;
window.leaveEvent=leaveEvent;
window.assignMember=assignMember;
window.removeMember=removeMember;
window.setEventPaid=setEventPaid;
window.saveEventNote=saveEventNote;

function logout(){
  localStorage.removeItem(DB_SESSION);
  ME=null; ACTIVE_ROLE=null;
  CURRENT_VIEW='events'; CURRENT_EDIT_ID=null;
  renderHeader();
  viewLogin();
}
window.logout = logout;
window.toggleActive=toggleActive;
window.deleteUser=deleteUser;
window.addUser=addUser;
window.toggleUserRole=toggleUserRole;
window.saveUserInline=saveUserInline;
window.editRoleOpen=editRoleOpen;
window.saveRole=saveRole;
window.deleteRole=deleteRole;
window.addRole=addRole;
  </script>
</body>
</html>
