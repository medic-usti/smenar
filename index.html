<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smƒõn√°≈ô - Medic √öst√≠ nad Labem</title>
  <style>
    :root{--bg:#f7f9fc;--card:#fff;--border:#e5e7eb;--txt:#0f172a;--muted:#6b7280;--accent:#0f172a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--border);padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
    main{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid var(--border);background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:#0f172a}
    .btn.danger{border-color:#ef4444;color:#ef4444}
    .btn.ghost{background:transparent}
    .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:8px 10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .badge{background:#eef2f7;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .muted{color:var(--muted)}
    .menu{position:relative;display:inline-block}
    .menu .dropdown{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 12px 30px rgba(0,0,0,.1);min-width:230px;overflow:hidden}
    .menu.open .dropdown{display:block}
    .dropdown button{display:block;width:100%;text-align:left;background:#fff;border:0;padding:10px 12px;cursor:pointer}
    .dropdown button:hover{background:#f1f5f9}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:#fff}
    .list-plain{margin:0;padding-left:1rem}
    .list-plain li{margin:2px 0}
    details summary{cursor:pointer; user-select:none; list-style:none}
    details summary::-webkit-details-marker{display:none}
    .admin-box{border:1px dashed var(--border); border-radius:10px; padding:10px; margin-top:10px; background:#fafbff}
    .key{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; padding:2px 6px; border:1px solid var(--border); border-radius:6px; background:#fff}
    .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:50}
    .toast{background:#111827;color:#fff;border-radius:8px;padding:10px 12px;box-shadow:0 8px 24px rgba(0,0,0,.25);max-width:360px}
    .toast small{color:#cbd5e1}
    @media (max-width:640px){.grid2,.grid3{grid-template-columns:1fr} header{flex-wrap:wrap;gap:8px}}

    /* DB status badge (prav√Ω doln√≠ roh) */
    .db-ind {
      position: fixed; right: 12px; bottom: 12px; z-index: 60;
      background: #111827; color: #fff; border-radius: 10px;
      padding: 8px 10px; font-size: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.25);
      display: inline-flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,.08);
    }
    .db-dot { width: 8px; height: 8px; border-radius: 999px; background: #ef4444; box-shadow: 0 0 0 2px rgba(239,68,68,.25); }
    .db-dot.ok { background: #10b981; box-shadow: 0 0 0 2px rgba(16,185,129,.25); }
    .db-muted { color: #cbd5e1; }

    /* === NOV√â: zv√Ωraznƒõn√≠ "m√Ωch" ud√°lost√≠ zelenƒõ === */
    .event-mine {
      border-color: #10b981 !important;
      box-shadow: 0 8px 30px rgba(16,185,129,.25);
    }
    .mine-pill {
      background: #ecfdf5;
      border-color: #10b981;
      color: #065f46;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <!-- DB stav: Online/Offline + posledn√≠ sync -->
  <div id="dbInd" class="db-ind" title="Stav datab√°ze">
    <span id="dbDot" class="db-dot"></span>
    <span><b>DB:</b> <span id="dbState">Offline</span></span>
    <span class="db-muted">‚Ä¢</span>
    <span class="db-muted">naposledy: <span id="dbLast">‚Äî</span></span>
  </div>

  <header>
    <div class="row"><span style="font-size:20px">üóÇÔ∏è</span><b>Smƒõn√°≈ô</b></div>
    <div id="hdr"></div>
  </header>

  <main>
    <div id="app"></div>
  </main>

  <div class="toast-wrap" id="toasts"></div>

  <script>
/*******************
 * Local "DB" (localStorage) + helpers
 *******************/
const DB_USERS    = "smenar.users";
const DB_ACTIONS  = "smenar.actions";
const DB_ROLES    = "smenar.roles";
const DB_SESSION  = "smenar.session";
const DB_ACTIVITY = "smenar.activity";
const DB_ARCHIVE  = "smenar.actions.archive";

function load(k){ try{ return JSON.parse(localStorage.getItem(k)||'[]'); }catch(_){ return []; } }
function save(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){ } }

const uid=()=>crypto.randomUUID?crypto.randomUUID():('id'+Date.now()+Math.random().toString(16).slice(2));
const today=()=>new Date().toISOString().slice(0,10);
const nowMs=()=>Date.now();
const $=s=>document.querySelector(s);

function toast(msg,sub){
  const w=$('#toasts'); const d=document.createElement('div');
  d.className='toast';
  d.innerHTML=\`<div>\${msg}</div>\${sub? \`<small>\${sub}</small>\`:''}\`;
  w.appendChild(d);
  setTimeout(()=>{ d.style.opacity='0'; d.style.transform='translateY(8px)'; d.style.transition='all .25s';
    setTimeout(()=>w.removeChild(d),260);
  },3000);
}

/*******************
 * DB indik√°tor (mock online = v≈ædy online)
 *******************/
let DB_ONLINE = true;
let DB_LAST_TS = Date.now();
let DB_LAST_SRC = 'init';

function fmtAgo(ts){
  if(!ts) return "‚Äî";
  const s = Math.max(0, Math.floor((Date.now() - ts)/1000));
  if(s < 60) return \`\${s}s\`;
  const m = Math.floor(s/60);
  if(m < 60) return \`\${m}m \${s%60}s\`;
  const h = Math.floor(m/60);
  return \`\${h}h \${m%60}m\`;
}
function fmtAbs(ts){ try { return new Date(ts).toLocaleString(); } catch { return "‚Äî"; } }
function renderDbInd(){
  const dot = document.getElementById('dbDot');
  const st  = document.getElementById('dbState');
  const last= document.getElementById('dbLast');
  if(!dot||!st||!last) return;
  st.textContent = DB_ONLINE ? 'Online' : 'Offline';
  dot.classList.toggle('ok', DB_ONLINE);
  last.textContent = \`\${fmtAgo(DB_LAST_TS)}\${DB_LAST_SRC ? \` (\${DB_LAST_SRC})\` : ''}\`;
  const wrap = document.getElementById('dbInd');
  if(wrap) wrap.title = \`DB: \${DB_ONLINE?'Online':'Offline'} ‚Ä¢ naposledy: \${fmtAbs(DB_LAST_TS)} \${DB_LAST_SRC?\`(\${DB_LAST_SRC})\`:''}\`;
}
setInterval(renderDbInd, 5000);
renderDbInd();

/*******************
 * Data in-memory
 *******************/
let USERS=load(DB_USERS), ACTIONS=load(DB_ACTIONS), ROLES=load(DB_ROLES), ACTIVITY=load(DB_ACTIVITY), ARCHIVE=load(DB_ARCHIVE);
let ME=null, ACTIVE_ROLE=null, adminWatchTimer=null;

let CURRENT_VIEW = 'events';        // 'events' | 'create' | 'members' | 'roles' | 'activity' | 'past' | 'export'
let CURRENT_EDIT_ID = null;

/*******************
 * Seed (prvn√≠ spu≈°tƒõn√≠)
 *******************/
(function seed(){
  if(!ROLES.length){
    ROLES=[
      {key:'ridic',label:'≈òidiƒç',isPublic:true},
      {key:'zza',label:'ZZA',isPublic:true},
      {key:'zdravotnik',label:'Zdravotn√≠k',isPublic:true}
    ];
    save(DB_ROLES,ROLES);
  }
  if(!USERS.length){
    USERS=[
      {id:'u1',name:'Podpora',password:'support',roles:['support','admin'],isActive:true},
      {id:'u2',name:'admin',password:'1111',roles:['admin'],isActive:true},
      {id:'u3',name:'Adam',password:'adam',roles:['ridic','zza'],isActive:true},
      {id:'u4',name:'B√°ra',password:'bara',roles:['zdravotnik'],isActive:true}
    ];
    save(DB_USERS,USERS);
  }
  if(!ACTIONS.length){
    const cap={}, su={};
    ['ridic','zza','zdravotnik'].forEach(k=>{ cap[k]=(k==='zza'?2:1); su[k]=[]; });
    ACTIONS=[{
      id:'a1',date:today(),title:'Dozor ‚Äì fotbal',location:'Stadion Kladno',
      timeFrom:'15:00',timeTo:'20:00',capacity:cap,signups:su,signupUnlock:null,
      isPaid:false,adminNote:''
    }];
    save(DB_ACTIONS,ACTIONS);
  }
  if(!ACTIVITY.length) save(DB_ACTIVITY,[]);
  if(!ARCHIVE.length) save(DB_ARCHIVE,[]);
})();

/*******************
 * Users / Roles helpers
 *******************/
function getUserById(id){ return (USERS||[]).find(u=>u.id===id)||null; }
function userHasRole(u,r){ return (u?.roles||[]).includes(r); }
function getPublicRoleKeys(){ return (ROLES||[]).filter(r=>r.isPublic).map(r=>r.key); }
function roleLabel(k){ return (ROLES||[]).find(r=>r.key===k)?.label||k; }
function userPublicRoles(u){ const pubs=getPublicRoleKeys(); return (u?.roles||[]).filter(r=>pubs.includes(r)); }
function ensureActiveRole(){
  if(!ME){ACTIVE_ROLE=null;return;}
  const prs=userPublicRoles(ME); if(!prs.length){ACTIVE_ROLE=null;return;}
  if(!ACTIVE_ROLE||!prs.includes(ACTIVE_ROLE)) ACTIVE_ROLE=prs[0];
}
function isSupportUser(u){ return !!u && ((u.roles||[]).includes('support') || ((u?.name||'').trim().toLowerCase()==='podpora')); }

/*******************
 * Header + Login
 *******************/
function renderHeader(){
  const el=$('#hdr'); if(!ME){ el.innerHTML=''; return; }
  ensureActiveRole();
  const prs=userPublicRoles(ME);
  const roleSel = (ACTIVE_ROLE && prs.length)
    ? \`<select class="select" id="selActiveRole">\${prs.map(r=>\`<option value="\${r}" \${r===ACTIVE_ROLE?'selected':''}>\${roleLabel(r)}</option>\`).join('')}</select>\`
    : \`<span class="muted">Bez ve≈ôejn√© role</span>\`;
  el.innerHTML=\`
    <div class="row">
      <span class="badge">\${ME.name}</span>
      \${roleSel}
      \${userHasRole(ME,'admin')? \`
        <div class="menu" id="adminMenu">
          <button class="btn" id="adminBtn">Admin ‚ñæ</button>
          <div class="dropdown">
            <button onclick="viewEvents()">Ud√°losti</button>
            <button onclick="viewPastEvents()">Probƒõhl√© akce</button>
            <button onclick="viewMembers()">ƒålenov√©</button>
            <button onclick="viewRoles()">Role</button>
            <button onclick="viewActivity()">Aktivita</button>
            <button onclick="viewCreateEvent()">Nov√° ud√°lost</button>
            \${isSupportUser(ME)?\`<button onclick="viewExport()">Export / Z√°loha</button>\`:''}
          </div>
        </div>\`:''}
      <button class="btn" onclick="logout()">Odhl√°sit</button>
    </div>\`;
  const sel=document.getElementById('selActiveRole'); if(sel) sel.onchange=()=>{ ACTIVE_ROLE=sel.value; renderApp(); };
  const menu=document.getElementById('adminMenu');
  if(menu){
    const btn=document.getElementById('adminBtn');
    btn.addEventListener('click',(e)=>{e.stopPropagation();menu.classList.toggle('open');});
    document.addEventListener('click',(e)=>{ if(!menu.contains(e.target)) menu.classList.remove('open'); });
  }
}

function viewLogin(){
  const app=$('#app');
  app.innerHTML=\`
    <div class="card" style="max-width:420px;margin:40px auto">
      <h3>P≈ôihl√°≈°en√≠</h3>
      <input id="loginName" class="input" placeholder="Jm√©no">
      <div class="row" style="justify-content:space-between;width:100%">
        <input id="loginPass" class="input" type="password" placeholder="Heslo" style="flex:1">
        <button class="btn" id="togglePass">üëÅÔ∏è</button>
      </div>
      <button class="btn primary" id="btnLogin">P≈ôihl√°sit</button>
    </div>\`;
  document.getElementById('togglePass').onclick=()=>{
    const i=document.getElementById('loginPass'); i.type=(i.type==='password'?'text':'password');
  };
  document.getElementById('btnLogin').onclick=()=>{
    const n=document.getElementById('loginName').value.trim();
    const p=document.getElementById('loginPass').value;
    USERS=load(DB_USERS);
    const u=(USERS||[]).find(x=>x.name===n && x.password===p && x.isActive!==false);
    if(!u){ alert('Neplatn√© √∫daje'); return; }
    ME=u;
    localStorage.setItem(DB_SESSION, ME.id);
    ensureActiveRole();
    renderApp();
  };
}

/*******************
 * Events, Archive, Activity
 *******************/
function safeHHMM(s){ return /^\\d{2}:\\d{2}$/.test(s||'')?s:''; }
function eventEndMs(a){
  const d=a?.date||today();
  const end=safeHHMM(a?.timeTo)||safeHHMM(a?.timeFrom)||'23:59';
  const t=new Date(\`\${d}T\${end}\`).getTime();
  return isNaN(t)?new Date(\`\${d}T23:59\`).getTime():t;
}
function isPastEvent(a){ return nowMs()>eventEndMs(a); }
function getUnlockMs(a){
  if(!a||!a.signupUnlock) return 0;
  const ms=new Date(a.signupUnlock).getTime();
  return isNaN(ms)?0:ms;
}
function sortEvents(a,b){
  const A=(a.date||'')+' '+(a.timeFrom||'00:00');
  const B=(b.date||'')+' '+(b.timeFrom||'00:00');
  return A.localeCompare(B);
}
function archiveSweep(){
  let acts=load(DB_ACTIONS);
  let arc=load(DB_ARCHIVE);
  const toMove=(acts||[]).filter(isPastEvent);
  if(!toMove.length) return;
  const keep=acts.filter(a=>!isPastEvent(a));
  ACTIONS=keep; save(DB_ACTIONS,ACTIONS);
  const moved=toMove.slice().sort(sortEvents).reverse();
  // zachovej paid/note do archivu (ji≈æ jsou v a)
  arc=[...moved,...arc];
  ARCHIVE=arc; save(DB_ARCHIVE,arc);
  moved.forEach(a=> logActivity({type:'archiveEvent',userId:ME?.id,userName:ME?.name,eventId:a.id,eventTitle:a.title}));
}

/* Activity */
function logActivity(ev){
  const e={...ev, ts: Date.now()};
  const list=load(DB_ACTIVITY);
  list.push(e);
  ACTIVITY=list; save(DB_ACTIVITY,list);
}

function renderEventHistory(eventId,limit){
  const list=(load(DB_ACTIVITY)||[]).filter(x=>x.eventId===eventId).slice(-limit);
  if(!list.length) return '';
  const items=list.map(x=>{
    const who=x.userName || (getUserById(x.userId)?.name) || 'u≈æivatel';
    const role=x.roleKey? \` (\${roleLabel(x.roleKey)})\`:'';
    const date=new Date(x.ts).toLocaleString();
    const map={
      join:\`p≈ôihl√°≈°en√≠\${role}\`, leave:\`odhl√°≈°en√≠\${role}\`, assign:\`p≈ôi≈ôazen\${role}\`, remove:\`odebr√°n\${role}\`,
      createEvent:'vytvo≈ôen√≠ ud√°losti', updateEvent:'√∫prava ud√°losti', deleteEvent:'smaz√°n√≠ ud√°losti'
    };
    return \`<li>\${date}: <b>\${who}</b> ‚Äì \${map[x.type]||x.type}</li>\`;
  }).join('');
  return \`<details class="admin-box"><summary><b>Historie ud√°losti</b></summary><ul class="list-plain" style="margin-top:8px">\${items}</ul></details>\`;
}

/* === NEW: helper to check if ME is signed anywhere in event === */
function isMeSignedInEvent(a){
  if(!ME) return false;
  const roles=Object.keys(a.signups||{});
  for(const r of roles){
    const arr=a.signups[r]||[];
    if(arr.includes(ME.id)) return true;
  }
  return false;
}

function viewEvents(){
  CURRENT_VIEW='events';
  archiveSweep();
  const app=$('#app');
  ensureActiveRole();
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS); ROLES=load(DB_ROLES);

  const pubs=getPublicRoleKeys();
  const cards=(ACTIONS||[]).slice().sort(sortEvents).map(a=>{
    const capHtml=pubs.map(r=>{
      const list=a.signups?.[r]||[];
      const names=list.map(id=> (getUserById(id)||{}).name ).filter(Boolean).join(', ');
      return \`<li><b>\${roleLabel(r)}</b>: \${list.length}/\${(a.capacity?.[r]||0)} ‚Äî \${names||'‚Äî'}</li>\`;
    }).join('');

    const unlockMs=getUnlockMs(a);
    const isOpen=(unlockMs===0||nowMs()>=unlockMs);

    let actionBtn='';
    if(!ME) actionBtn=\`<span class="muted">P≈ôihla≈°ov√°n√≠ a≈æ po p≈ôihl√°≈°en√≠</span>\`;
    else if(!isOpen){
      const when=a.signupUnlock?new Date(a.signupUnlock).toLocaleString():'';
      actionBtn=\`<span class="muted">P≈ôihla≈°ov√°n√≠ se otev≈ôe: <b>\${when}</b></span>\`;
    } else if(ACTIVE_ROLE){
      const my=a.signups[ACTIVE_ROLE]||[];
      const isIn=my.includes(ME.id);
      actionBtn = isIn
        ? \`<button class="btn danger" onclick="leaveEvent('\${a.id}')">Odhl√°sit se</button>\`
        : (my.length>=(a.capacity[ACTIVE_ROLE]||0)
            ? \`<span class="muted">Kapacita pro roli \${roleLabel(ACTIVE_ROLE)} je pln√°</span>\`
            : \`<button class="btn primary" onclick="joinEvent('\${a.id}')">P≈ôihl√°sit se</button>\`);
    } else actionBtn=\`<span class="muted">Nem√°te vybranou ve≈ôejnou roli</span>\`;

    const mine = isMeSignedInEvent(a);
    const minePill = mine ? \`<span class="pill mine-pill">‚úî P≈ôihl√°≈°en</span>\` : '';

    const adminManage = userHasRole(ME,'admin') ? renderAdminManageBox(a,pubs) : '';
    const payBox = isMePrivileged() ? \`
      <div class="admin-box" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px">
            <input type="checkbox" id="paid_\${a.id}" \${a.isPaid?'checked':''}
                   onchange="togglePaid('\${a.id}', this.checked, 'active')"><b>Akce zaplacena</b>
          </label>
          <button class="btn" onclick="saveAdminNote('\${a.id}', 'active')">Ulo≈æit pozn√°mku</button>
        </div>
        <textarea id="note_\${a.id}" class="textarea" rows="2" placeholder="Pozn√°mka pro admina...">\${a.adminNote||''}</textarea>
      </div>\` : '';

    const history = renderEventHistory(a.id,5);

    return \`
      <div class="card \${mine?'event-mine':''}">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700">\${a.title} \${minePill}</div>
            <div class="muted">\${a.date} ‚Ä¢ \${a.location||'‚Äî'} ‚Ä¢ \${(a.timeFrom||'')}\${a.timeTo?('‚Äì'+a.timeTo):''}</div>
            \${a.signupUnlock? \`<div class="muted" style="font-size:12px">Odemknut√≠ p≈ôihla≈°ov√°n√≠: <b>\${new Date(a.signupUnlock).toLocaleString()}</b></div>\` : ''}
          </div>
          \${userHasRole(ME,'admin')?
            \`<div class="row">
                <button class="btn" onclick="editEvent('\${a.id}')">Upravit</button>
                <button class="btn danger" onclick="deleteEvent('\${a.id}')">Smazat</button>
              </div>\` : ''}
        </div>
        <ul class="list-plain" style="margin-top:8px">\${capHtml}</ul>
        <div class="row" style="margin-top:8px">\${actionBtn}</div>
        \${payBox}
        \${adminManage}
        \${history}
      </div>\`;
  }).join('');

  app.innerHTML=\`<h3>Ud√°losti</h3>\${cards || '<div class="card muted">≈Ω√°dn√© ud√°losti.</div>'}\`;
}

function renderAdminManageBox(a,pubRoles){
  const removeBlocks=pubRoles.map(r=>{
    const list=a.signups[r]||[];
    const items=list.map(uid=>{
      const u=getUserById(uid);
      const nm=u?u.name:uid;
      return \`<li>\${nm} <button class="btn ghost danger" onclick="adminRemove('\${a.id}','\${r}','\${uid}')">√ó</button></li>\`;
    }).join('')||\`<li class="muted">Nikdo</li>\`;
    return \`<div><b>\${roleLabel(r)} ‚Äì odebrat:</b><ul class="list-plain">\${items}</ul></div>\`;
  }).join('');

  const assignForms=pubRoles.map(r=>{
    const signed=new Set(a.signups[r]||[]);
    const candidates=(USERS||[]).filter(u=> userHasRole(u,r) && !signed.has(u.id))
      .map(u=>\`<option value="\${u.id}">\${u.name}</option>\`).join('');
    return \`
      <div class="grid2" style="margin-top:6px">
        <div><label>P≈ôi≈ôadit jako \${roleLabel(r)}:
          <select id="assign_\${a.id}_\${r}" class="select">
            <option value="">‚Äî vyberte ƒçlena ‚Äî</option>\${candidates}
          </select>
        </label></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn" onclick="adminAssign('\${a.id}','\${r}')">P≈ôi≈ôadit</button>
        </div>
      </div>\`;
  }).join('');

  return \`
    <details class="admin-box">
      <summary><b>Spr√°va √∫ƒçasti (admin)</b></summary>
      <div style="margin-top:8px">
        \${removeBlocks}
        <hr style="border:none;border-top:1px solid var(--border);margin:10px 0">
        \${assignForms}
      </div>
    </details>\`;
}

function inRoleCapacity(a, roleKey){
  const cap = (a.capacity?.[roleKey]||0);
  const list = a.signups?.[roleKey]||[];
  return list.length < cap;
}

function joinEvent(aid){
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid);
  if(!a||!ME) return;
  const unlockMs=getUnlockMs(a);
  if(unlockMs!==0 && nowMs()<unlockMs){ alert('P≈ôihla≈°ov√°n√≠ je≈°tƒõ nen√≠ otev≈ôen√©.'); return; }
  ensureActiveRole();
  if(!ACTIVE_ROLE){ alert('Nem√°te vybranou ve≈ôejnou roli'); return; }
  a.signups[ACTIVE_ROLE]=a.signups[ACTIVE_ROLE]||[];
  if(a.signups[ACTIVE_ROLE].includes(ME.id)){ toast('U≈æ jste p≈ôihl√°≈°en.'); renderApp(); return; }
  if(!inRoleCapacity(a, ACTIVE_ROLE)){ toast('Kapacita t√©to role je pln√°.'); return; }
  a.signups[ACTIVE_ROLE].push(ME.id);
  save(DB_ACTIONS,ACTIONS);
  logActivity({type:'join', userId:ME.id, userName:ME.name, roleKey:ACTIVE_ROLE, eventId:a.id, eventTitle:a.title});
  toast('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©', \`\${a.title}\`);
  renderApp();
}

function leaveEvent(aid){
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid);
  if(!a||!ME||!ACTIVE_ROLE) return;
  a.signups[ACTIVE_ROLE]=(a.signups[ACTIVE_ROLE]||[]).filter(x=>x!==ME.id);
  save(DB_ACTIONS,ACTIONS);
  logActivity({type:'leave', userId:ME.id, userName:ME.name, roleKey:ACTIVE_ROLE, eventId:a.id, eventTitle:a.title});
  toast('Odhl√°≈°en√≠ √∫spƒõ≈°n√©', \`\${a.title}\`);
  renderApp();
}

function adminAssign(aid, roleKey){
  if(!userHasRole(ME,'admin')) return;
  const sel = document.getElementById(\`assign_\${aid}_\${roleKey}\`);
  const uidSel = sel?.value||''; if(!uidSel) return;
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid);
  if(!a) return;
  a.signups[roleKey]=a.signups[roleKey]||[];
  if(a.signups[roleKey].includes(uidSel)){ toast('U≈æivatel u≈æ je p≈ôihl√°≈°en.'); return; }
  if(!inRoleCapacity(a, roleKey)){ toast('Kapacita t√©to role je pln√°.'); return; }
  a.signups[roleKey].push(uidSel);
  save(DB_ACTIONS,ACTIONS);
  const u=getUserById(uidSel);
  logActivity({type:'assign', userId:ME.id, userName:ME.name, roleKey, eventId:a.id, eventTitle:a.title});
  toast('P≈ôi≈ôazeno', \`\${u?.name||uidSel} ‚Üí \${roleLabel(roleKey)}\`);
  renderApp();
}

function adminRemove(aid, roleKey, uidRem){
  if(!userHasRole(ME,'admin')) return;
  USERS=load(DB_USERS); ACTIONS=load(DB_ACTIONS);
  const a=ACTIONS.find(x=>x.id===aid);
  if(!a) return;
  a.signups[roleKey]=(a.signups[roleKey]||[]).filter(x=>x!==uidRem);
  save(DB_ACTIONS,ACTIONS);
  const u=getUserById(uidRem);
  logActivity({type:'remove', userId:ME.id, userName:ME.name, roleKey, eventId:a.id, eventTitle:a.title});
  toast('Odebr√°no', \`\${u?.name||uidRem} z \${roleLabel(roleKey)}\`);
  renderApp();
}

/*******************
 * Paid / Note (persist + carry to archive)
 *******************/
function isMePrivileged(){ return ME && (userHasRole(ME,'admin') || isSupportUser(ME)); }

function togglePaid(aid, val, where){
  if(!isMePrivileged()) return;
  if(where==='active'){
    ACTIONS=load(DB_ACTIONS);
    const a=ACTIONS.find(x=>x.id===aid);
    if(!a) return;
    a.isPaid=!!val;
    save(DB_ACTIONS,ACTIONS);
  }else if(where==='archive'){
    ARCHIVE=load(DB_ARCHIVE);
    const a=ARCHIVE.find(x=>x.id===aid);
    if(!a) return;
    a.isPaid=!!val;
    save(DB_ARCHIVE,ARCHIVE);
  }
  toast('Ulo≈æeno', 'Stav platby zmƒõnƒõn');
}

function saveAdminNote(aid, where){
  if(!isMePrivileged()) return;
  const ta=document.getElementById('note_'+aid);
  const note=ta? ta.value : '';
  if(where==='active'){
    ACTIONS=load(DB_ACTIONS);
    const a=ACTIONS.find(x=>x.id===aid);
    if(!a) return;
    a.adminNote=note;
    save(DB_ACTIONS,ACTIONS);
  }else if(where==='archive'){
    ARCHIVE=load(DB_ARCHIVE);
    const a=ARCHIVE.find(x=>x.id===aid);
    if(!a) return;
    a.adminNote=note;
    save(DB_ARCHIVE,ARCHIVE);
  }
  toast('Pozn√°mka ulo≈æena');
}

/*******************
 * Create/Edit/Delete events
 *******************/
function viewCreateEvent(editId=null){
  CURRENT_VIEW='create'; CURRENT_EDIT_ID=editId;
  const app=$('#app');
  let a = null;
  if(editId){
    ACTIONS=load(DB_ACTIONS);
    a=ACTIONS.find(x=>x.id===editId)||null;
  }
  const date=a?.date || today();
  const title=a?.title || '';
  const location=a?.location || '';
  const tFrom=a?.timeFrom || '';
  const tTo=a?.timeTo || '';
  const unlock = a?.signupUnlock || '';

  const pubs=getPublicRoleKeys();
  const caps = pubs.map(k=>{
    const v = a?.capacity?.[k] ?? (k==='zza'?2:1);
    return \`<div><label>\${roleLabel(k)} kapacita<input class="input" id="cap_\${k}" type="number" min="0" value="\${v}"></label></div>\`;
  }).join('');

  app.innerHTML=\`
    <h3>\${editId?'Upravit ud√°lost':'Nov√° ud√°lost'}</h3>
    <div class="card">
      <div class="grid3">
        <label>Kdy (datum)<input id="ev_date" class="input" type="date" value="\${date}"></label>
        <label>Od<input id="ev_from" class="input" placeholder="HH:MM" value="\${tFrom}"></label>
        <label>Do<input id="ev_to" class="input" placeholder="HH:MM" value="\${tTo}"></label>
      </div>
      <div class="grid2" style="margin-top:8px">
        <label>N√°zev<input id="ev_title" class="input" value="\${title}"></label>
        <label>M√≠sto<input id="ev_loc" class="input" value="\${location}"></label>
      </div>
      <div class="grid2" style="margin-top:8px">
        <label>P≈ôihla≈°ov√°n√≠ spu≈°tƒõno od<input id="ev_unlock" class="input" type="datetime-local" value="\${unlock? new Date(unlock).toISOString().slice(0,16):''}"></label>
        <div></div>
      </div>
      <div class="grid3" style="margin-top:8px">\${caps}</div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button class="btn" onclick="renderApp()">Zpƒõt</button>
        <button class="btn primary" onclick="saveEvent('\${editId||''}')">\${editId?'Ulo≈æit zmƒõny':'Vytvo≈ôit'}</button>
      </div>
    </div>\`;
}

function saveEvent(editId){
  if(!userHasRole(ME,'admin')) return;
  const d = (document.getElementById('ev_date')?.value||'').trim();
  const f = (document.getElementById('ev_from')?.value||'').trim();
  const t = (document.getElementById('ev_to')?.value||'').trim();
  const ti= (document.getElementById('ev_title')?.value||'').trim();
  const lo= (document.getElementById('ev_loc')?.value||'').trim();
  const un= (document.getElementById('ev_unlock')?.value||'').trim();
  const unlock = un? new Date(un).toISOString(): null;

  const pubs=getPublicRoleKeys();
  const cap={}; pubs.forEach(k=>{
    const v = parseInt(document.getElementById('cap_'+k)?.value||'0',10);
    cap[k] = isNaN(v)?0:v;
  });

  ACTIONS=load(DB_ACTIONS);
  if(editId){
    const a=ACTIONS.find(x=>x.id===editId);
    if(!a) return;
    a.date=d; a.timeFrom=f; a.timeTo=t; a.title=ti; a.location=lo; a.signupUnlock=unlock; a.capacity=cap;
    save(DB_ACTIONS,ACTIONS);
    logActivity({type:'updateEvent', userId:ME.id, userName:ME.name, eventId:a.id, eventTitle:a.title});
    toast('Ud√°lost upravena');
  }else{
    const su={}; pubs.forEach(k=> su[k]=[] );
    const a={ id: uid(), date:d, timeFrom:f, timeTo:t, title:ti, location:lo,
              signupUnlock:unlock, capacity:cap, signups:su, isPaid:false, adminNote:'' };
    ACTIONS.push(a);
    save(DB_ACTIONS,ACTIONS);
    logActivity({type:'createEvent', userId:ME.id, userName:ME.name, eventId:a.id, eventTitle:a.title});
    toast('Ud√°lost vytvo≈ôena');
  }
  renderApp();
}

function editEvent(aid){ viewCreateEvent(aid); }

function deleteEvent(aid){
  if(!userHasRole(ME,'admin')) return;
  if(!confirm('Smazat ud√°lost?')) return;
  ACTIONS=load(DB_ACTIONS);
  const a = ACTIONS.find(x=>x.id===aid);
  ACTIONS=ACTIONS.filter(x=>x.id!==aid);
  save(DB_ACTIONS,ACTIONS);
  if(a) logActivity({type:'deleteEvent', userId:ME.id, userName:ME.name, eventId:a.id, eventTitle:a.title});
  toast('Ud√°lost smaz√°na');
  renderApp();
}

/*******************
 * Past events
 *******************/
function viewPastEvents(){
  CURRENT_VIEW='past';
  archiveSweep();
  ARCHIVE=load(DB_ARCHIVE);
  const app=$('#app');

  const pubs=getPublicRoleKeys();
  const cards=(ARCHIVE||[]).slice().map(a=>{
    const capHtml=pubs.map(r=>{
      const list=a.signups?.[r]||[];
      const names=list.map(id=> (getUserById(id)||{}).name ).filter(Boolean).join(', ');
      return \`<li><b>\${roleLabel(r)}</b>: \${list.length}/\${(a.capacity?.[r]||0)} ‚Äî \${names||'‚Äî'}</li>\`;
    }).join('');

    const payBox = isMePrivileged() ? \`
      <div class="admin-box" style="margin-top:8px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <label class="row" style="gap:8px">
            <input type="checkbox" id="paid_\${a.id}" \${a.isPaid?'checked':''}
                   onchange="togglePaid('\${a.id}', this.checked, 'archive')"><b>Akce zaplacena</b>
          </label>
          <button class="btn" onclick="saveAdminNote('\${a.id}', 'archive')">Ulo≈æit pozn√°mku</button>
        </div>
        <textarea id="note_\${a.id}" class="textarea" rows="2" placeholder="Pozn√°mka pro admina...">\${a.adminNote||''}</textarea>
      </div>\` : '';

    return \`
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:flex-start">
          <div>
            <div style="font-weight:700">\${a.title}</div>
            <div class="muted">\${a.date} ‚Ä¢ \${a.location||'‚Äî'} ‚Ä¢ \${(a.timeFrom||'')}\${a.timeTo?('‚Äì'+a.timeTo):''}</div>
          </div>
        </div>
        <ul class="list-plain" style="margin-top:8px">\${capHtml}</ul>
        \${payBox}
      </div>\`;
  }).join('');

  app.innerHTML=\`<h3>Probƒõhl√© akce</h3>\${cards || '<div class="card muted">≈Ω√°dn√© z√°znamy.</div>'}\`;
}

/*******************
 * Members
 *******************/
function viewMembers(){
  CURRENT_VIEW='members';
  USERS=load(DB_USERS);
  const app=$('#app');
  const rows = USERS.map(u=>\`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>\${u.name}</b> <span class="muted">(\${u.isActive?'aktivn√≠':'deaktivov√°n'})</span></div>
          <div class="muted">Role: \${(u.roles||[]).map(roleLabel).join(', ')||'‚Äî'}</div>
        </div>
        <div class="row">
          <button class="btn" onclick="toggleUserActive('\${u.id}')">\${u.isActive?'Deaktivovat':'Aktivovat'}</button>
        </div>
      </div>
    </div>\`).join('');

  app.innerHTML=\`<h3>ƒålenov√©</h3>\${rows}\`;
}
function toggleUserActive(uidT){
  if(!userHasRole(ME,'admin')) return;
  USERS=load(DB_USERS);
  const u=USERS.find(x=>x.id===uidT); if(!u) return;
  u.isActive=!u.isActive;
  save(DB_USERS,USERS);
  toast('Ulo≈æeno', \`U≈æivatel \${u.name} je nyn√≠ \${u.isActive?'aktivn√≠':'deaktivov√°n'}\`);
  renderApp();
}

/*******************
 * Roles
 *******************/
function viewRoles(){
  CURRENT_VIEW='roles';
  ROLES=load(DB_ROLES);
  const app=$('#app');

  const list = ROLES.map(r=>\`
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div><b>\${r.label}</b> <span class="muted">(\${r.key})</span> ‚Ä¢ \${r.isPublic?'ve≈ôejn√°':'neve≈ôejn√°'}</div>
        <div class="row">
          <button class="btn" onclick="editRole('\${r.key}')">Upravit</button>
          <button class="btn danger" onclick="deleteRole('\${r.key}')">Smazat</button>
        </div>
      </div>
    </div>\`).join('');

  app.innerHTML=\`
    <h3>Role</h3>
    \${list}
    <div class="card">
      <h4>P≈ôidat roli</h4>
      <div class="grid3">
        <label>K√≥d<input id="r_key" class="input" placeholder="nap≈ô. ridic"></label>
        <label>N√°zev<input id="r_label" class="input" placeholder="≈òidiƒç"></label>
        <label>Ve≈ôejn√°?
          <select id="r_pub" class="select">
            <option value="1">Ano</option>
            <option value="0">Ne</option>
          </select>
        </label>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn primary" onclick="addRole()">P≈ôidat</button>
      </div>
    </div>\`;
}
function addRole(){
  if(!userHasRole(ME,'admin')) return;
  const key=(document.getElementById('r_key')?.value||'').trim();
  const label=(document.getElementById('r_label')?.value||'').trim();
  const pub = (document.getElementById('r_pub')?.value||'1')==='1';
  if(!key || !label){ alert('Vypl≈àte k√≥d i n√°zev.'); return; }
  ROLES=load(DB_ROLES);
  if(ROLES.some(r=>r.key===key)){ alert('K√≥d role u≈æ existuje.'); return; }
  ROLES.push({key,label,isPublic:pub});
  save(DB_ROLES,ROLES);
  toast('Role p≈ôid√°na');
  viewRoles();
}
function editRole(key){
  if(!userHasRole(ME,'admin')) return;
  const r=(load(DB_ROLES)||[]).find(x=>x.key===key); if(!r) return;
  const nl=prompt('Nov√Ω n√°zev', r.label) ?? r.label;
  const pub=confirm('Oznaƒçit jako ve≈ôejnou? OK=Ano, Zru≈°it=Ne');
  r.label=nl; r.isPublic=pub;
  const rs=load(DB_ROLES).map(x=> x.key===key ? r : x);
  save(DB_ROLES,rs);
  toast('Role upravena');
  viewRoles();
}
function deleteRole(key){
  if(!userHasRole(ME,'admin')) return;
  if(!confirm('Smazat roli?')) return;
  ROLES=load(DB_ROLES).filter(r=>r.key!==key);
  save(DB_ROLES,ROLES);
  toast('Role smaz√°na');
  viewRoles();
}

/*******************
 * Activity view
 *******************/
function viewActivity(){
  CURRENT_VIEW='activity';
  const app=$('#app');
  const list=(load(DB_ACTIVITY)||[]).slice(-200).reverse().map(a=>{
    const ts=new Date(a.ts).toLocaleString();
    return \`<li>\${ts}: <b>\${a.userName||a.userId||'u≈æivatel'}</b> ‚Äî \${a.type} (\${a.eventTitle||a.eventId||''})</li>\`;
  }).join('');
  app.innerHTML=\`<h3>Aktivita</h3><div class="card"><ul class="list-plain">\${list||'<li class="muted">≈Ω√°dn√° aktivita.</li>'}</ul></div>\`;
}

/*******************
 * Export / Z√°loha (jen support)
 *******************/
function viewExport(){
  CURRENT_VIEW='export';
  if(!isSupportUser(ME)){ alert('Pouze Podpora'); renderApp(); return; }
  const app=$('#app');
  app.innerHTML=\`
    <h3>Export / Z√°loha</h3>
    <div class="card">
      <div class="row">
        <button class="btn" onclick="downloadJson()">St√°hnout JSON</button>
        <button class="btn" onclick="downloadCsv()">St√°hnout CSV (ud√°losti)</button>
      </div>
    </div>\`;
}
function downloadJson(){
  const data = {
    users: load(DB_USERS),
    roles: load(DB_ROLES),
    actions: load(DB_ACTIONS),
    archive: load(DB_ARCHIVE),
    activity: load(DB_ACTIVITY)
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='smenar_backup.json';
  a.click();
}
function downloadCsv(){
  const acts=load(DB_ACTIONS);
  const pubs=getPublicRoleKeys();
  const head=['id','date','timeFrom','timeTo','title','location', ...pubs.map(k=>'cap_'+k), ...pubs.map(k=>'signed_'+k)];
  const rows=[head.join(',')];
  acts.forEach(a=>{
    const caps=pubs.map(k=> (a.capacity?.[k]||0));
    const signed=pubs.map(k=> (a.signups?.[k]||[]).map(uid=> (getUserById(uid)||{}).name||uid ).join('|'));
    const row=[a.id,a.date,a.timeFrom||'',a.timeTo||'',JSON.stringify(a.title),JSON.stringify(a.location), ...caps, ...signed].join(',');
    rows.push(row);
  });
  const blob=new Blob([rows.join('\\n')], {type:'text/csv;charset=utf-8;'});
  const aEl=document.createElement('a');
  aEl.href=URL.createObjectURL(blob);
  aEl.download='smenar_events.csv';
  aEl.click();
}

/*******************
 * Router
 *******************/
function renderApp(){
  renderHeader();
  if(!ME){
    const sid=localStorage.getItem(DB_SESSION);
    if(sid){
      USERS=load(DB_USERS);
      const u=getUserById(sid);
      if(u && u.isActive!==false){ ME=u; ensureActiveRole(); }
      else localStorage.removeItem(DB_SESSION);
    }
  }
  if(!ME){ viewLogin(); return; }
  switch(CURRENT_VIEW){
    case 'create': viewCreateEvent(CURRENT_EDIT_ID); break;
    case 'members': viewMembers(); break;
    case 'roles': viewRoles(); break;
    case 'activity': viewActivity(); break;
    case 'past': viewPastEvents(); break;
    case 'export': viewExport(); break;
    default: viewEvents();
  }
}
renderApp();

/*******************
 * Logout
 *******************/
function logout(){
  localStorage.removeItem(DB_SESSION);
  ME=null; ACTIVE_ROLE=null;
  renderHeader();
  viewLogin();
}
  </script>
</body>
</html>
